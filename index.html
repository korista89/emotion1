<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ê°ì • ë°ì´í„° ë¶„ì„ ë„êµ¬ Â· ì‹¤ì‹œê°„ ë™ê¸°í™”</title>
<style>
  :root{
    --bg:#f7f9fc;--panel:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#4f46e5;
    --accent:#22c55e;--danger:#ef4444;--border:#e5e7eb;--chip:#f1f5f9;
    --red:#ef4444;--blue:#2563eb;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
  .wrap{max-width:1180px;margin:0 auto;padding:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;white-space:nowrap}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:12px;border:1px solid var(--border); background:#fff;cursor:pointer;font-weight:700;min-height:40px}
  .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
  .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
  .btn:disabled{background:#e5e7eb;cursor:not-allowed;color:#9ca3af}
  .tabs{display:flex;gap:10px;overflow:auto;margin-bottom:12px}
  .tab{padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;white-space:nowrap}
  .tab.active{background:var(--primary);color:#fff;border-color:transparent}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
  .scroller{display:flex;gap:12px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:6px 2px}
  .stu{flex:0 0 210px;background:#fff;border:2px solid var(--border);border-radius:16px;padding:12px;text-align:center}
  .stu.selected{border-color:var(--primary);box-shadow:0 0 0 2px rgba(79,70,229,.22) inset}
  .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#e5e7eb;border:2px solid #fff;box-shadow:0 6px 14px rgba(0,0,0,.06)}
  .context{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
  .chip{padding:9px 12px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:13px;cursor:pointer;text-align:center;user-select:none}
  .chip.selected{background:var(--primary);color:#fff;border-color:transparent}
  table{width:100%;border-collapse:collapse;margin-top:10px} th,td{border:1px solid #ddd;padding:6px;text-align:center;font-size:13px} th{background:#f3f4f6}
  .hide{display:none!important}
  canvas{width:100%;height:420px;border:1px solid var(--border);border-radius:12px;background:#fff}
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:10px;background:radial-gradient(circle at 30% 30%, #8b5cf6, #2563eb);box-shadow:0 6px 16px rgba(37,99,235,.35)}
  .title{font-weight:900;font-size:20px} .muted{color:#64748b}
  .iconbtn{width:40px;height:40px;border-radius:12px;border:1px solid var(--border);background:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
  @media (max-width:640px){ .stu{flex:0 0 160px} .title{font-size:18px} }
  @media print{ .no-print{display:none!important} body{background:#fff} .card{border:0;box-shadow:none} @page{size:A4;margin:12mm} }
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal.show{display:flex}
  .modal .box{background:#fff;border-radius:16px;max-width:440px;width:100%;padding:18px;border:1px solid var(--border);box-shadow:0 24px 48px rgba(0,0,0,.25)}
  .modal .box h3{margin:0 0 8px 0}
  .loader{position:fixed;inset:0;background:rgba(255,255,255,.7);display:none;align-items:center;justify-content:center;z-index:100;flex-direction:column;gap:10px;font-weight:bold;color:var(--primary)}
  .loader.show{display:flex}
  .loader-spinner{width:48px;height:48px;border:5px solid #f3f3f3;border-top:5px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="loader" class="loader"><div class="loader-spinner"></div><div id="loader-msg">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
<div class="wrap">
  <div class="topbar card no-print">
    <div class="brand"><div class="logo"></div>
      <div><div class="title">ê°ì • ë°ì´í„° ë¶„ì„ ë„êµ¬</div><div class="muted" style="font-size:12px">v3.0 Â· ì†ë„ ê°œì„  ë° ë³´ê³ ì„œ ê¸°ëŠ¥ ê°•í™”</div></div>
    </div>
    <div class="row">
      <button id="manualSync" class="iconbtn" title="ìˆ˜ë™ ë™ê¸°í™”">ğŸ”„</button>
      <button id="openSheet" class="iconbtn" title="êµ¬ê¸€ ì‹œíŠ¸ ì—´ê¸°" disabled>ğŸ“„</button>
      <button id="gear" class="iconbtn" title="ì—°ë™ ì„¤ì •">âš™ï¸</button>
    </div>
  </div>
  <section id="login" class="card">
    <div class="row" style="justify-content:space-between;align-items:center"><h2>ğŸ” ë°˜ ì„ íƒ ë¡œê·¸ì¸</h2><div class="muted">A~F: a123~f123 Â· ê´€ë¦¬ì: admin123</div></div>
    <div class="row" id="classGrid"></div>
    <div id="pwArea" class="hide">
      <div class="row"><input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"/><button id="btnLogin" class="btn primary">ë¡œê·¸ì¸</button></div>
      <div class="muted" style="margin-top:6px">ì—°ê²°: <span id="linkStatus" class="pill">ë¯¸ì„¤ì •</span> Â· ì„œë²„ ë²„ì „ <span id="sv">0</span></div>
    </div>
  </section>
  <section id="app" class="card hide">
    <div class="row" style="justify-content:space-between;align-items:center"><h2>ğŸ“˜ ìˆ˜ì—… ë°ì´í„° ì…ë ¥</h2>
      <div class="row no-print"><div id="who" class="pill">-</div><button id="btnLogout" class="btn">ë¡œê·¸ì•„ì›ƒ</button></div>
    </div>
    <div class="tabs no-print" id="tabs">
      <button class="tab active" data-tab="am">ğŸ« ë“±êµì…ë ¥</button><button class="tab" data-tab="pm">ğŸ¡ í•˜êµì…ë ¥</button>
      <button class="tab" data-tab="data">ğŸ“‹ ë°ì´í„° ê´€ë¦¬</button><button class="tab" data-tab="graph">ğŸ“ˆ ê·¸ë˜í”„Â·ë³´ê³ ì„œ</button>
      <button class="tab" data-tab="list">ğŸ‘¥ í•™ìƒëª©ë¡</button><button class="tab" data-tab="new">â• í•™ìƒë“±ë¡</button>
    </div>
    <div id="tab-am"><div class="row" style="justify-content:center;gap:8px"><button class="btn" id="amPrev">â—€</button><button class="pill" id="amDateBtn"><span id="amDate"></span> ğŸ“…</button><input id="amDatePicker" class="hide" type="date"/><button class="btn" id="amNext">â–¶</button></div><h3>í•™ìƒ ì„ íƒ</h3><div id="amScroller" class="scroller"></div><div id="amForm" class="hide"><h3 id="amWho"></h3><div id="amEmotions"></div><div id="amCtxWrap" class="hide"><div style="text-align:center;margin:8px 0" class="muted">ê°„í¸ ë§¥ë½</div><div id="amCtx" class="context"></div></div><div class="row" style="margin-top:10px"><button class="btn primary" id="amSave">ì €ì¥</button></div></div></div>
    <div id="tab-pm" class="hide"><div class="row" style="justify-content:center;gap:8px"><button class="btn" id="pmPrev">â—€</button><button class="pill" id="pmDateBtn"><span id="pmDate"></span> ğŸ“…</button><input id="pmDatePicker" class="hide" type="date"/><button class="btn" id="pmNext">â–¶</button></div><h3>í•™ìƒ ì„ íƒ</h3><div id="pmScroller" class="scroller"></div><div id="pmForm" class="hide"><h3 id="pmWho"></h3><div id="pmEmotions"></div><div id="pmCtxWrap" class="hide"><div style="text-align:center;margin:8px 0" class="muted">ê°„í¸ ë§¥ë½</div><div id="pmCtx" class="context"></div></div><div class="row" style="margin-top:10px"><button class="btn primary" id="pmSave">ì €ì¥</button></div></div></div>
    <div id="tab-data" class="hide"><div class="row"><input id="searchName" placeholder="í•™ìƒëª… ê²€ìƒ‰"/><button id="btnSearch" class="btn">ê²€ìƒ‰</button><button id="btnClear" class="btn ghost">ì´ˆê¸°í™”</button></div><table><thead><tr><th>ë‚ ì§œ</th><th>í•™ìƒ</th><th>êµ¬ë¶„</th><th>ì ìˆ˜</th><th>ë§¥ë½</th><th>ê´€ë¦¬</th></tr></thead><tbody id="dataBody"></tbody></table></div>
    <div id="tab-graph" class="hide"><div class="row"><select id="graphStudent"></select><input type="date" id="fromDate"><input type="date" id="toDate"><button class="btn" id="btnGraph">ìƒì„±</button><button class="btn" id="btnPrint">ğŸ–¨ï¸ ì¸ì‡„</button></div><div style="height:8px"></div><h3 id="graphTitle" style="text-align:center"></h3><canvas id="chart"></canvas><div class="muted" style="font-size:12px;margin-top:6px;text-align:center"><b>ë²”ë¡€:</b> <span style="color:var(--red)">â— ë“±êµ</span> <span style="color:var(--blue)">â–² í•˜êµ</span></div><div style="height:14px"></div><div id="reportBox" class="card"></div></div>
    <div id="tab-list" class="hide"><h3>í•™ìƒ ëª©ë¡</h3><div id="stuList"></div></div>
    <div id="tab-new" class="hide"><h3>í•™ìƒ ë“±ë¡</h3><div class="row"><input id="newName" placeholder="í•™ìƒ ì´ë¦„"><input id="photo" type="file" accept="image/*" class="no-print"><img id="preview" class="avatar"/></div><div style="height:8px"></div><label>í•™ê¸‰</label><div id="chipsClass" class="context"></div><label>ì„±ë³„</label><div id="chipsSex" class="context"></div><label>ì§„ë‹¨</label><div id="chipsDx" class="context"></div><label>ì˜ì‚¬ì†Œí†µ</label><div id="chipsComm" class="context"></div><label>ê°ê° í”„ë¡œí•„</label><div id="chipsSensory" class="context"></div><label>ì„ í˜¸ ê°•í™”ì œ</label><div id="chipsReinf" class="context"></div><label>ì£¼ìš” ìœ ë°œìƒí™©</label><div id="chipsTrigger" class="context"></div><label>ì˜ë£Œ/ì•½ë¬¼</label><div id="chipsMeds" class="context"></div><div class="row" style="margin-top:8px"><input id="newParent" type="tel" placeholder="ë³´í˜¸ì ì—°ë½ì²˜"/></div><div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn primary" id="addStu">ë“±ë¡</button></div></div>
  </section>
</div>
<div id="modalSettings" class="modal"><div class="box"><h3>ì—°ë™ ì„¤ì •</h3><p class="muted">ë°°í¬ëœ ì›¹ì•± URLì„ ë¶™ì—¬ë„£ê³  ì €ì¥í•˜ì„¸ìš”.</p><input id="syncUrlInput" placeholder="https://script.google.com/macros/s/..."/>
<div class="row" style="justify-content:flex-end;margin-top:10px"><button id="saveUrl" class="btn primary">ì €ì¥</button><button id="closeUrl" class="btn">ë‹«ê¸°</button></div></div></div>
<div id="modalDone" class="modal"><div class="box"><h3>âœ… ì™„ë£Œ</h3><div id="doneMsg"></div><div class="row" style="justify-content:flex-end;margin-top:10px"><button id="doneOk" class="btn primary">í™•ì¸</button></div></div></div>
<div id="modalEdit" class="modal"><div class="box"><h3>í•™ìƒ ì •ë³´ ìˆ˜ì •</h3><div class="row"><input id="editName" placeholder="ì´ë¦„"><input id="editPhoto" type="file" accept="image/*"><img id="editPreview" class="avatar"/></div><div style="height:8px"></div>
<label>í•™ê¸‰</label><div id="editClass" class="context"></div><label>ì„±ë³„</label><div id="editSex" class="context"></div><label>ì§„ë‹¨</label><div id="editDx" class="context"></div><label>ì˜ì‚¬ì†Œí†µ</label><div id="editComm" class="context"></div><label>ê°ê° í”„ë¡œí•„</label><div id="editSensory" class="context"></div><label>ì„ í˜¸ ê°•í™”ì œ</label><div id="editReinf" class="context"></div><label>ì£¼ìš” ìœ ë°œìƒí™©</label><div id="editTrigger" class="context"></div><label>ì˜ë£Œ/ì•½ë¬¼</label><div id="editMeds" class="context"></div>
<div class="row" style="justify-content:flex-end;margin-top:10px"><button id="editSave" class="btn primary">ì €ì¥</button><button id="editClose" class="btn">ë‹«ê¸°</button></div></div></div>

<script>
(function(){
  "use strict";
  const KEY_URL="sync_url_full_v3";
  const PWD={A:"a123",B:"b123",C:"c123",D:"d123",E:"e123",F:"f123",admin:"admin123"};
  let SYNC_URL=localStorage.getItem(KEY_URL)||"";
  let serverVersion=0, localVersion=0;
  let currentUser=null, students=[], emotion={};
  let editTargetId=null;

  const $=s=>document.querySelector(s),$$=s=>[...document.querySelectorAll(s)];
  const fmt=d=>new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split("T")[0];
  const dateK=d=>d.toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric",weekday:"long"});
  function setText(sel,txt){ const el=$(sel); if(el) el.textContent=txt; }
  function showLoader(msg){$("#loader-msg").textContent=msg||"ì²˜ë¦¬ ì¤‘...";$("#loader").classList.add("show");}
  function hideLoader(){$("#loader").classList.remove("show");}
  function openModal(id){$(id).classList.add("show");} function closeModal(id){$(id).classList.remove("show");}
  function done(msg){$("#doneMsg").textContent=msg||"ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";openModal("#modalDone");}
  
  const EMO={5:{e:"ğŸ˜„",n:"ë§¤ìš° ì¢‹ìŒ"},4:{e:"ğŸ™‚",n:"ì¢‹ìŒ"},3:{e:"ğŸ˜",n:"ë³´í†µ"},2:{e:"ğŸ˜•",n:"ë¶ˆí¸"},1:{e:"ğŸ˜£",n:"ë§¤ìš° ì–´ë ¤ì›€"}};
  const CTX=[["ğŸ˜´ ìˆ˜ë©´ë¶€ì¡±"],["ğŸ’Š ê±´ê°•ì €í•˜"],["ğŸ  ê°€ì •ì´ìŠˆ"],["ğŸ”„ í™œë™ì „í™˜"],["ğŸ§’ ë˜ë˜ê°ˆë“±"],["ğŸ‘€ ê´€ì‹¬ìš”êµ¬"],["ğŸ ê°•í™”ì œìš”êµ¬"],["ğŸšª ê³¼ì œíšŒí”¼"],["ğŸŒ€ ê°ê°ì¶”êµ¬"],["ğŸ”Š ì†ŒìŒë¯¼ê°"],["ğŸ½ï¸ ë°°ê³ í””"],["ğŸ¤• í†µì¦/ë¶ˆí¸"],["ğŸ“… ì¼ì •ë³€ê²½"],["ğŸšŒ ë“±í•˜êµí”¼ë¡œ"],["ğŸŒ¤ï¸ ë‚ ì”¨ì˜í–¥"]];
  const OPS={classes:["A","B","C","D","E","F"],sex:["ë‚¨","ì—¬"],dx:["ì§€ì ì¥ì• ","ìíìŠ¤í™íŠ¸ëŸ¼","ADHD","í•™ìŠµì¥ì• ","ì •ì„œÂ·í–‰ë™ì¥ì• ","ê¸°íƒ€"],comm:["êµ¬ì–´","PECS","AAC","ì œìŠ¤ì²˜","ì œí•œì  ì–¸ì–´","ê¸°íƒ€"],sensory:["ì²­ê° ê³¼ë¯¼","ì‹œê° ê³¼ë¯¼","ì´‰ê° ê³¼ë¯¼","ì••ë°• ì„ í˜¸","ì›€ì§ì„ ì¶”êµ¬","ê¸°íƒ€"],reinf:["ìŠ¤í‹°ì»¤","ìŒì‹","í™œë™","ì „ìê¸°ê¸°","ì‚¬íšŒì  ì¹­ì°¬","ê¸°íƒ€"],trigger:["ê³¼ì œ ì „í™˜","ì†ŒìŒ","ì¼ì • ë³€ê²½","ë˜ë˜ ê°ˆë“±","ìš”êµ¬ ê±°ë¶€","ê¸°íƒ€"],meds:["ì—†ìŒ","í•­ì •ì‹ ë³‘ì œ","í•­ë¶ˆì•ˆì œ","í•­ê²½ë ¨ì œ","ê¸°íƒ€"]};

  async function api(action,params={}){
    if(!SYNC_URL) throw new Error("ì›¹ì•± URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    const url=new URL(SYNC_URL);
    url.searchParams.set('action', action);
    for(const k in params) url.searchParams.set(k, params[k]);
    const r=await fetch(url);
    if(!r.ok) throw new Error(`ì„œë²„ í†µì‹  ì˜¤ë¥˜: ${r.status}`);
    const j=await r.json();
    if(j.error) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${j.error}`);
    if(j.version) { serverVersion=j.version; setText("#sv",String(serverVersion)); }
    return j;
  }
  async function postApi(body){
    if(!SYNC_URL) throw new Error("ì›¹ì•± URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    const r=await fetch(SYNC_URL,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(body)});
    if(!r.ok) throw new Error(`ì„œë²„ í†µì‹  ì˜¤ë¥˜: ${r.status}`);
    const j=await r.json();
    if(j.error) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${j.error}`);
    if(j.version) { serverVersion=j.version; setText("#sv",String(serverVersion)); }
    return j;
  }

  function setSyncUrl(url){SYNC_URL=url.trim();localStorage.setItem(KEY_URL,SYNC_URL);setText("#linkStatus",SYNC_URL?"ì„¤ì •ë¨":"ë¯¸ì„¤ì •");}

  function chipContainer(el,ops,single=false){el.innerHTML=ops.map(v=>`<div class="chip" data-v="${v}">${v}</div>`).join("");el.onclick=e=>{const c=e.target.closest(".chip");if(!c)return;if(single){el.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected"));c.classList.add("selected");}else c.classList.toggle("selected");};}
  function getChips(el){return $$(`${el} .chip.selected`).map(x=>x.dataset.v);}
  function setChips(el,vals,ops,single=false){const container=$(el);container.innerHTML=ops.map(v=>`<div class="chip ${vals.includes(v)?'selected':''}" data-v="${v}">${v}</div>`).join("");chipContainer(container,ops,single);}

  function renderStudents(containerSel){
    const container=$(containerSel);
    const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    container.innerHTML=list.map(s=>`<div class="stu" data-id="${s.id}"><img class="avatar" src="${s.photo||""}" alt="${s.name}"/><div style="font-weight:800;margin-top:6px">${s.name}</div></div>`).join("")||`<div class="muted">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    container.onclick=e=>{const card=e.target.closest(".stu");if(!card)return;container.querySelectorAll(".stu").forEach(x=>x.classList.remove("selected"));card.classList.add("selected");const sid=card.dataset.id;const s=students.find(x=>x.id==sid);const prefix=containerSel.includes("am")?"am":"pm";$(`#${prefix}Form`).classList.remove("hide");$(`#${prefix}Who`).textContent=`${s.name} í•™ìƒ ê°ì •ê¸°ë¡`;container.dataset.sel=sid;};
  }
  function renderEmo(prefix){const box=$(`#${prefix}Emotions`);box.innerHTML=[5,4,3,2,1].map(sc=>`<div class="emoBtn" data-score="${sc}"><div style="font-size:28px">${EMO[sc].e}</div><div><div style="font-weight:800">${sc}ì  Â· ${EMO[sc].n}</div></div></div>`).join("");box.onclick=e=>{const b=e.target.closest(".emoBtn");if(!b)return;box.querySelectorAll(".emoBtn").forEach(x=>x.classList.remove("active"));b.classList.add("active");box.dataset.score=b.dataset.score;$(`#${prefix}CtxWrap`).classList.remove("hide");};}
  function renderCtx(prefix){const el=$(`#${prefix}Ctx`);el.innerHTML=CTX.map(([t])=>`<div class="chip" data-k="${t}">${t}</div>`).join("");el.onclick=e=>{const c=e.target.closest(".chip");if(!c)return;c.classList.toggle("selected");};}
  
  async function handleSaveEmotion(prefix, btn){
    btn.disabled=true; showLoader("ì €ì¥ ì¤‘...");
    try{
      const scroller=$(`#${prefix}Scroller`),sid=scroller.dataset.sel;
      const box=$(`#${prefix}Emotions`),score=parseInt(box.dataset.score||"0",10);
      if(!sid||!score){throw new Error("í•™ìƒê³¼ ê°ì •ì„ ì„ íƒí•˜ì„¸ìš”.");}
      const date=fmt(prefix==="am"?amDate:pmDate);
      const ctxSel=$$(`#${prefix}Ctx .chip.selected`).map(x=>x.dataset.k);
      await postApi({action:"add_emotion",date,student_id:sid,slot:(prefix==="am"?"morning":"afternoon"),score,context:ctxSel});
      done("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      box.querySelectorAll(".emoBtn").forEach(x=>x.classList.remove("active"));
      $(`#${prefix}CtxWrap`).classList.add("hide");
      $$(`#${prefix}Ctx .chip`).forEach(x=>x.classList.remove("selected"));
      scroller.querySelector('.selected')?.classList.remove('selected');
      $(`#${prefix}Form`).classList.add('hide');
      localVersion=0;
    }catch(e){done(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`);}
    finally{btn.disabled=false;hideLoader();}
  }

  let amDate=new Date(),pmDate=new Date();
  function setDates(){setText("#amDate",dateK(amDate));setText("#pmDate",dateK(pmDate));$("#amDatePicker").value=fmt(amDate);$("#pmDatePicker").value=fmt(pmDate);}

  async function onTabClick(tabId){
    $$(".tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===tabId));
    $$("[id^='tab-']").forEach(p=>p.classList.toggle("hide",p.id!==`tab-${tabId}`));
    showLoader("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
    try{
      if(tabId==="list"){
        if(localVersion < serverVersion) await fetchStudents();
        renderStudentList();
      }else if(tabId==="data"){
        await fetchAllEmotions();
        renderDataManager();
      }else if(tabId==="graph"){
        if(localVersion < serverVersion) await fetchStudents();
        renderGraphStudentSelect();
      }
    }catch(e){done(`íƒ­ ë¡œë”© ì‹¤íŒ¨: ${e.message}`);}
    finally{hideLoader();}
  }

  async function fetchStudents(){students=(await api('get_students')).students||[];localVersion=serverVersion;}
  async function fetchAllEmotions(){emotion=(await api('get_emotions')).emotion||{};}
  async function fetchDateRangeEmotions(from,to){return(await api('get_emotions',{from,to})).emotion||{};}

  function renderStudentList(){
    const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    $("#stuList").innerHTML=list.map(s=>`<div class="row" style="justify-content:space-between;border-bottom:1px solid #e5e7eb;padding:8px 0"><div class="row"><img class="avatar" src="${s.photo||""}" alt="${s.name}"/><div><div><b>${s.name}</b> <span class="muted">(${(s.classes||[]).join(", ")})</span></div></div></div><div class="row"><button class="btn" data-edit="${s.id}">ìˆ˜ì •</button><button class="btn danger" data-del="${s.id}">ì‚­ì œ</button></div></div>`).join("")||`<div class="muted">í•™ìƒ ì—†ìŒ</div>`;
  }
  function renderDataManager(filter=""){
    const body=$("#dataBody");body.innerHTML="";
    const dates=Object.keys(emotion).sort((a,b)=>b.localeCompare(a));
    dates.forEach(k=>{const day=emotion[k];Object.keys(day).forEach(sid=>{const rec=day[sid],nm=rec.name||"";if(filter&&!nm.includes(filter))return;['morning','afternoon'].forEach(slot=>{const cur=rec[slot];if(!cur)return;const tr=document.createElement("tr");tr.innerHTML=`<td>${k}</td><td>${nm}</td><td>${slot==="morning"?"ë“±êµ":"í•˜êµ"}</td><td>${cur.score}</td><td>${(cur.context||[]).join(", ")}</td><td><button class="btn danger" data-del="true">ì‚­ì œ</button></td>`;tr.dataset.date=k;tr.dataset.sid=sid;tr.dataset.slot=slot;body.appendChild(tr);});});});
  }
  function renderGraphStudentSelect(){const sel=$("#graphStudent");const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));sel.innerHTML=`<option value="">í•™ìƒ ì„ íƒ</option>`+list.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");}

  async function handleGraph(){
    const sid=$("#graphStudent").value, from=$("#fromDate").value, to=$("#toDate").value;
    if(!sid||!from||!to){return done("í•™ìƒê³¼ ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.");}
    const btn=$("#btnGraph");btn.disabled=true;showLoader("ë³´ê³ ì„œ ìƒì„± ì¤‘...");
    try{
      const s=students.find(x=>x.id==sid);
      const periodEmotion=await fetchDateRangeEmotions(from,to);
      drawGraphTitle(s?.name||"");
      const g=getRangeData(sid,from,to,periodEmotion);
      drawChart("chart",g.labels,g.am,g.pm);
      genReport(s,from,to,periodEmotion);
    }catch(e){done(`ê·¸ë˜í”„ ìƒì„± ì‹¤íŒ¨: ${e.message}`);}
    finally{btn.disabled=false;hideLoader();}
  }
  function getRangeData(sid,from,to,emoData){const labels=[],am=[],pm=[];const cur=new Date(from);const end=new Date(to);while(cur<=end){const k=fmt(cur),r=emoData[k]?.[sid];labels.push(k.slice(5));am.push(r?.morning?.score??null);pm.push(r?.afternoon?.score??null);cur.setDate(cur.getDate()+1);}return{labels,am,pm};}
  function drawGraphTitle(name){setText("#graphTitle",name?`${name} í•™ìƒ ê°ì • ëª¨ë‹ˆí„°ë§`:"");}
  function drawChart(canvasId,labels,am,pm){const c=$(`#${canvasId}`),ctx=c.getContext('2d');const dpr=window.devicePixelRatio||1;c.width=c.clientWidth*dpr;c.height=c.clientHeight*dpr;ctx.scale(dpr,dpr);const W=c.clientWidth,H=c.clientHeight,pad=42;ctx.clearRect(0,0,W,H);ctx.strokeStyle="#e5e7eb";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad,H-pad);ctx.lineTo(W-pad,H-pad);ctx.moveTo(pad,pad);ctx.lineTo(pad,H-pad);ctx.stroke();for(let s=1;s<=5;s++){const y=H-pad-(H-2*pad)*(s-1)/4;ctx.fillStyle="#64748b";ctx.font="12px sans-serif";ctx.fillText(String(s),10,y+4);ctx.strokeStyle="#f1f5f9";ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W-pad,y);ctx.stroke();}if(!labels.length)return;const step=(W-2*pad)/Math.max(1,labels.length-1);const yOf=v=>H-pad-(H-2*pad)*((v-1)/4);labels.forEach((lab,i)=>{const x=pad+i*step;if(i%Math.ceil(labels.length/8)===0){ctx.fillStyle="#64748b";ctx.fillText(lab,x-12,H-pad+14);}});function ds(pts,c,sh){ctx.strokeStyle=c;ctx.lineWidth=2;ctx.beginPath();let st=false;pts.forEach((v,i)=>{const x=pad+i*step;if(v==null){st=false;return;}const y=yOf(v);if(!st){ctx.moveTo(x,y);st=true;}else{ctx.lineTo(x,y);}});ctx.stroke();ctx.fillStyle=c;pts.forEach((v,i)=>{if(v==null)return;const x=pad+i*step,y=yOf(v);if(sh==="c"){ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fill();}else{ctx.beginPath();ctx.moveTo(x,y-5);ctx.lineTo(x-5,y+4);ctx.lineTo(x+5,y+4);ctx.closePath();ctx.fill();}ctx.font="11px sans-serif";ctx.fillText(String(v),x+6,y-6);});}ds(am,"#ef4444","c");ds(pm,"#2563eb","t");}
  
  function genReport(s,from,to,emoData){
    if(!s){$("#reportBox").innerHTML="í•™ìƒ ì •ë³´ ì—†ìŒ";return;}
    const recs=[];const cur=new Date(from),end=new Date(to);
    while(cur<=end){const k=fmt(cur);const r=emoData[k]?.[s.id];if(r?.morning)recs.push({score:r.morning.score,ctx:r.morning.context||[]});if(r?.afternoon)recs.push({score:r.afternoon.score,ctx:r.afternoon.context||[]});cur.setDate(cur.getDate()+1);}
    const n=recs.length;if(n===0){$("#reportBox").innerHTML=`<div class="muted">ì„ íƒëœ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;return;}
    const lowRecs=recs.filter(r=>r.score<=2);const ctxCount={};lowRecs.forEach(r=>r.ctx.forEach(c=>ctxCount[c]=(ctxCount[c]||0)+1));
    const topCtx=Object.entries(ctxCount).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v])=>`${k}(${v}íšŒ)`);
    let opinion="ì „ë°˜ì ìœ¼ë¡œ ì•ˆì •ì ì¸ ê°ì • ìƒíƒœë¥¼ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.";const plans=new Set();
    plans.add("<b>[ê¸°ë³¸]</b> SEL/Zones: ìˆ˜ì—… ì „ ê°ì • ì¹´ë“œ ì„ íƒ ë° ëŒ€ì²˜ ì „ëµ ë…¼ì˜ ë£¨í‹´ì„ í†µí•´ ê°ì • ì¸ì‹ì„ ë†’ì…ë‹ˆë‹¤.");
    plans.add("<b>[ê¸°ë³¸]</b> ê°€ì • ì—°ê³„: ë³´í˜¸ìì™€ ê°ì • í‘œí˜„ ë° ì£¼ìš” ë§¥ë½ì„ ì£¼ 1íšŒ ê³µìœ í•˜ì—¬ ì¼ê´€ëœ ì§€ì› í™˜ê²½ì„ ì¡°ì„±í•©ë‹ˆë‹¤.");
    if(lowRecs.length/n>=0.3){opinion=`ë‚®ì€ ì ìˆ˜(2ì  ì´í•˜)ê°€ ${lowRecs.length}íšŒ ê´€ì°°ë˜ì–´ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. íŠ¹íˆ ${topCtx.join(", ")||'ë‹¤ì–‘í•œ'} ìƒí™©ì—ì„œ ì–´ë ¤ì›€ì„ ê²ªëŠ” ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.`;const topKeys=topCtx.map(t=>t.split('(')[0]);if(topKeys.includes('ğŸšª ê³¼ì œíšŒí”¼'))plans.add("<b>[ê³¼ì œíšŒí”¼]</b> TEACCH/ABA: 'ë¨¼ì €-ê·¸ ë‹¤ìŒ' ë³´ë“œë¥¼ í™œìš©í•˜ê³ , ê³¼ì œë¥¼ ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ì—¬ ì„±ê³µ ê²½í—˜ì„ ëŠ˜ë ¤ì¤ë‹ˆë‹¤.");if(topKeys.includes('ğŸ”„ í™œë™ì „í™˜'))plans.add("<b>[í™œë™ì „í™˜]</b> ì‹œê°ì  ì§€ì›: íƒ€ì´ë¨¸ë‚˜ ì‹œê°ì  ì¼ì •í‘œë¡œ ë‹¤ìŒ í™œë™ì„ ëª…í™•í•˜ê²Œ ì˜ˆê³ í•˜ê³ , ì „í™˜ 5ë¶„ ì „ì— ë¯¸ë¦¬ ì•Œë ¤ì¤ë‹ˆë‹¤.");if(topKeys.includes('ğŸ§’ ë˜ë˜ê°ˆë“±'))plans.add("<b>[ë˜ë˜ê´€ê³„]</b> ì‚¬íšŒì„± ê¸°ìˆ  í›ˆë ¨(SST): ì—­í• ê·¹ì„ í†µí•´ ê°ˆë“± ìƒí™©ì—ì„œì˜ ì ì ˆí•œ ì˜ì‚¬ì†Œí†µ ë° ë¬¸ì œ í•´ê²° ê¸°ìˆ ì„ ì§€ë„í•©ë‹ˆë‹¤.");if(topKeys.includes('ğŸŒ€ ê°ê°ì¶”êµ¬')||topKeys.includes('ğŸ”Š ì†ŒìŒë¯¼ê°'))plans.add("<b>[ê°ê°ì¡°ì ˆ]</b> ê°ê° ë‹¤ì´ì–´íŠ¸: ì •ê¸°ì ì¸ ì›€ì§ì„ ê¸°íšŒë¥¼ ì œê³µí•˜ê±°ë‚˜, í•„ìš” ì‹œ í—¤ë“œí°ì„ ì°©ìš©í•˜ë„ë¡ í•˜ì—¬ ê°ê°ì  ì•ˆì •ì„ ë•ìŠµë‹ˆë‹¤.");if(topKeys.length===0)plans.add("<b>[íƒìƒ‰]</b> ABC ê´€ì°°: ë‚®ì€ ì ìˆ˜ë¥¼ ë³´ì¸ ìƒí™©ì˜ ì „í›„ ë§¥ë½(ì„ í–‰ì‚¬ê±´-í–‰ë™-í›„ì†ê²°ê³¼)ì„ ìƒì„¸íˆ ê¸°ë¡í•˜ì—¬ í•µì‹¬ ì›ì¸ì„ íŒŒì•…í•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.");}
    const human=a=>a?.length?a.join(", "):"ì •ë³´ ì—†ìŒ";
    $("#reportBox").innerHTML=`<div class="row" style="gap:12px;flex-wrap:nowrap"><div class="pill"><b>í•™ìƒ</b> ${s.name}</div><div class="pill"><b>ê¸°ê°„</b> ${from} ~ ${to}</div></div><div style="height:10px"></div><div><b>ì „ë¬¸ê°€ ì†Œê²¬</b>: ${opinion}</div><div style="height:8px"></div><div><b>ì¤‘ì¬ ê³„íš</b><ol>${[...plans].map(x=>`<li>${x}</li>`).join("")}</ol></div>`;
  }
  
  document.addEventListener("DOMContentLoaded", async ()=>{
    setSyncUrl(new URLSearchParams(location.search).get("gsUrl")||SYNC_URL);
    $("#gear").onclick=()=>openModal("#modalSettings");$("#closeUrl").onclick=()=>closeModal("#modalSettings");$("#doneOk").onclick=()=>closeModal("#modalDone");
    $("#saveUrl").onclick=()=>{setSyncUrl($("#syncUrlInput").value);done("URLì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");closeModal("#modalSettings");};
    $$(".tab").forEach(t=>t.onclick=()=>onTabClick(t.dataset.tab));
    
    // LOGIN
    $("#classGrid").innerHTML=['A','B','C','D','E','F','admin'].map(k=>`<button class="btn" data-class="${k}">${k==="admin"?'ğŸ”‘ ê´€ë¦¬ì':`í•™ê¸‰ ${k}`}</button>`).join("");
    $("#classGrid").onclick=e=>{const c=e.target.dataset.class;if(!c)return;currentUser=c;$("#pwArea").classList.remove("hide");$("#pw").focus();};
    $("#btnLogin").onclick=async()=>{const btn=$("#btnLogin");btn.disabled=true;showLoader("ë¡œê·¸ì¸ ì¤‘...");try{if($("#pw").value.trim()!==PWD[currentUser])throw new Error("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.");if(!SYNC_URL){openModal("#modalSettings");throw new Error("ë¨¼ì € ì—°ë™ ì„¤ì •ì„ í•´ì£¼ì„¸ìš”.");}await fetchStudents();$("#login").classList.add("hide");$("#app").classList.remove("hide");setText("#who",currentUser==="admin"?"ê´€ë¦¬ì":`${currentUser}í•™ê¸‰`);renderStudents("#amScroller");renderStudents("#pmScroller");}catch(e){done(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${e.message}`);}finally{btn.disabled=false;hideLoader();}};
    $("#pw").onkeydown=e=>{if(e.key==="Enter")$("#btnLogin").click();};
    $("#btnLogout").onclick=()=>location.reload();
    
    renderEmo("am");renderEmo("pm");renderCtx("am");renderCtx("pm");setDates();
    const past=new Date();past.setDate(past.getDate()-14);$("#fromDate").value=fmt(past);$("#toDate").value=fmt(new Date());
    
    $("#amSave").onclick=(e)=>handleSaveEmotion("am",e.target);
    $("#pmSave").onclick=(e)=>handleSaveEmotion("pm",e.target);
    $("#amPrev").onclick=()=>{amDate.setDate(amDate.getDate()-1);setDates();};
    $("#amNext").onclick=()=>{amDate.setDate(amDate.getDate()+1);setDates();};
    $("#pmPrev").onclick=()=>{pmDate.setDate(pmDate.getDate()-1);setDates();};
    $("#pmNext").onclick=()=>{pmDate.setDate(pmDate.getDate()+1);setDates();};
    $("#amDateBtn").onclick=()=>$("#amDatePicker").showPicker?.();$("#pmDateBtn").onclick=()=>$("#pmDatePicker").showPicker?.();
    $("#amDatePicker").onchange=e=>{amDate=new Date(e.target.value);setDates();};$("#pmDatePicker").onchange=e=>{pmDate=new Date(e.target.value);setDates();};

    $("#addStu").onclick=async(e)=>{const btn=e.target;btn.disabled=true;showLoader("ë“±ë¡ ì¤‘...");try{const name=$("#newName").value.trim();if(!name)throw new Error("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");let photo=null;const f=$("#photo").files[0];if(f)photo=await(new Promise(res=> {const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(f);}));let classes=getChips("#chipsClass");if(!classes.length&&currentUser!=="admin")classes=[currentUser];const s={id:Date.now(),name,photo,classes,sex:getChips("#chipsSex")[0]||"",dx:getChips("#chipsDx"),comm:getChips("#chipsComm"),sensory:getChips("#chipsSensory"),reinf:getChips("#chipsReinf"),trigger:getChips("#chipsTrigger"),meds:getChips("#chipsMeds"),parent:$("#newParent").value.trim()};await postApi({action:"add_student",student:s});done("í•™ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");localVersion=0;$$("#tab-new .chip.selected").forEach(c=>c.classList.remove("selected"));$("#newName").value=$("#newParent").value=$("#photo").value="";$("#preview").src="";}catch(err){done(`ë“±ë¡ ì‹¤íŒ¨: ${err.message}`);}finally{btn.disabled=false;hideLoader();}};
    $("#photo").onchange=async(e)=>{const f=e.target.files[0];if(!f)return;$("#preview").src=await(new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(f);}));};
    chipContainer($("#chipsClass"),OPS.classes);chipContainer($("#chipsSex"),OPS.sex,true);chipContainer($("#chipsDx"),OPS.dx);chipContainer($("#chipsComm"),OPS.comm);chipContainer($("#chipsSensory"),OPS.sensory);chipContainer($("#chipsReinf"),OPS.reinf);chipContainer($("#chipsTrigger"),OPS.trigger);chipContainer($("#chipsMeds"),OPS.meds);

    $("#stuList").onclick=async(e)=>{const editBtn=e.target.closest("[data-edit]"),delBtn=e.target.closest("[data-del]");if(editBtn){editTargetId=editBtn.dataset.edit;const s=students.find(x=>x.id==editTargetId);if(!s)return;$("#editName").value=s.name||"";$("#editPreview").src=s.photo||"";$("#editPhoto").value="";setChips("#editClass",s.classes||[],OPS.classes);setChips("#editSex",[s.sex||""],OPS.sex,true);setChips("#editDx",s.dx||[],OPS.dx);setChips("#editComm",s.comm||[],OPS.comm);setChips("#editSensory",s.sensory||[],OPS.sensory);setChips("#editReinf",s.reinf||[],OPS.reinf);setChips("#editTrigger",s.trigger||[],OPS.trigger);setChips("#editMeds",s.meds||[],OPS.meds);openModal("#modalEdit");}if(delBtn){if(!confirm("í•™ìƒì„ ì‚­ì œí•˜ë©´ ëª¨ë“  ê°ì • ê¸°ë¡ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?"))return;showLoader("ì‚­ì œ ì¤‘...");try{await postApi({action:"delete_student",id:delBtn.dataset.del});done("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");localVersion=0;await fetchStudents();renderStudentList();}catch(err){done(`ì‚­ì œ ì‹¤íŒ¨: ${err.message}`);}finally{hideLoader();}}};
    $("#editClose").onclick=()=>closeModal("#modalEdit");
    $("#editSave").onclick=async(e)=>{const btn=e.target;btn.disabled=true;showLoader("ìˆ˜ì • ì¤‘...");try{const s=students.find(x=>x.id==editTargetId);if(!s)throw new Error("í•™ìƒ ì •ë³´ ì—†ìŒ");s.name=$("#editName").value.trim();const pf=$("#editPhoto").files[0];if(pf)s.photo=await(new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(pf);}));s.classes=getChips("#editClass");s.sex=getChips("#editSex")[0]||"";s.dx=getChips("#editDx");s.comm=getChips("#editComm");s.sensory=getChips("#editSensory");s.reinf=getChips("#editReinf");s.trigger=getChips("#editTrigger");s.meds=getChips("#editMeds");await postApi({action:"update_student",student:s});done("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");localVersion=0;await fetchStudents();renderStudentList();closeModal("#modalEdit");}catch(err){done(`ìˆ˜ì • ì‹¤íŒ¨: ${err.message}`);}finally{btn.disabled=false;hideLoader();}};
    
    $("#dataBody").onclick=async e=>{const btn=e.target.closest("[data-del]");if(!btn||!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?"))return;const tr=btn.closest("tr");showLoader("ì‚­ì œ ì¤‘...");try{await postApi({action:"delete_emotion",date:tr.dataset.date,student_id:tr.dataset.sid,slot:tr.dataset.slot});done("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");tr.remove();}catch(err){done(`ì‚­ì œ ì‹¤íŒ¨: ${err.message}`);}finally{hideLoader();}};
    $("#btnSearch").onclick=()=>renderDataManager($("#searchName").value.trim());$("#btnClear").onclick=()=>{$("#searchName").value="";renderDataManager();};
    
    $("#btnGraph").onclick=handleGraph; $("#btnPrint").onclick=()=>window.print();
    $("#manualSync").onclick = async () => {
        showLoader("ë™ê¸°í™” ì¤‘...");
        try {
            const versionData = await api('version');
            if (versionData.version > localVersion) {
                await fetchStudents();
                renderStudents("#amScroller");
                renderStudents("#pmScroller");
                done("ìµœì‹  ë°ì´í„°ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                done("ì´ë¯¸ ìµœì‹  ë°ì´í„°ì…ë‹ˆë‹¤.");
            }
        } catch(e) {
            done(`ë™ê¸°í™” ì‹¤íŒ¨: ${e.message}`);
        } finally {
            hideLoader();
        }
    };
  });
})();
</script>
</body>
</html>
