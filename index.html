<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>감정 데이터 분석 도구 · Expert</title>
<style>
  :root{--bg:#f7f9fc;--panel:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#4f46e5;--accent:#22c55e;--danger:#ef4444;--border:#e5e7eb;--chip:#f1f5f9;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;font-size:15px}
  .wrap{max-width:1180px;margin:0 auto;padding:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;white-space:nowrap}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;min-height:40px;font-size:15px}
  .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
  .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
  .btn:disabled{background:#e5e7eb;cursor:not-allowed;color:#9ca3af}
  .tabs{display:flex;gap:10px;overflow-x:auto;margin-bottom:12px;-ms-overflow-style:none;scrollbar-width:none}
  .tabs::-webkit-scrollbar{display:none}
  .tab{padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;white-space:nowrap}
  .tab.active{background:var(--primary);color:#fff;border-color:transparent}
  input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;min-height:42px}
  .scroller{display:flex;gap:12px;overflow-x:auto;padding:6px 2px;-webkit-overflow-scrolling:touch;-ms-overflow-style:none;scrollbar-width:none}
  .scroller::-webkit-scrollbar{display:none}
  .stu{flex:0 0 160px;background:#fff;border:2px solid var(--border);border-radius:16px;padding:12px;text-align:center;cursor:pointer}
  .stu.selected{border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.3)}
  .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#e5e7eb;border:2px solid #fff;box-shadow:0 6px 14px rgba(0,0,0,.06);font-size:48px;line-height:64px;text-align:center}
  .emoBtn{display:flex;align-items:center;gap:12px;border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;cursor:pointer}
  .emoBtn.active{border-color:var(--primary);background:rgba(79,70,229,.05)}
  .context{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
  .chip{padding:9px 12px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:13px;cursor:pointer;text-align:center;user-select:none}
  .chip.selected{background:var(--primary);color:#fff;border-color:transparent}
  table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:14px}th{background:#f3f4f6}
  .hide{display:none!important}
  canvas{width:100%;height:420px;border:1px solid var(--border);border-radius:12px;background:#fff;margin-top:10px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
  .brand{display:flex;align-items:center;gap:10px}
  .title{font-weight:900;font-size:20px} .muted{color:#64748b}
  .iconbtn-group{display:flex;align-items:center;gap:4px}
  .iconbtn{width:40px;height:40px;border-radius:12px;border:1px solid var(--border);background:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px}
  @media(max-width:640px){.stu{flex:0 0 140px}.title{font-size:18px}.topbar{flex-direction:column;align-items:stretch}}
  @media print{.no-print{display:none!important}body{background:#fff}.card{border:0;box-shadow:none}#reportBox{padding:0}@page{size:A4;margin:12mm}}
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal.show{display:flex}
  .modal .box{background:#fff;border-radius:16px;max-width:480px;width:100%;padding:18px;border:1px solid var(--border);box-shadow:0 24px 48px rgba(0,0,0,.25)}
  .modal .box h3{margin:0 0 8px 0}
  .loader{position:fixed;inset:0;background:rgba(255,255,255,.7);display:none;align-items:center;justify-content:center;z-index:100;flex-direction:column;gap:10px;font-weight:bold;color:var(--primary)}
  .loader.show{display:flex}
  .loader-spinner{width:48px;height:48px;border:5px solid #f3f3f3;border-top:5px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  .emoji-picker{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0}
  .emoji-choice{font-size:40px;text-align:center;padding:10px;border-radius:12px;cursor:pointer;border:2px solid transparent}
  .emoji-choice.selected{border-color:var(--primary);background:rgba(79,70,229,.1)}
  #reportBox h4{margin:16px 0 8px 0;border-bottom:1px solid #eee;padding-bottom:4px}
  #reportBox ol, #reportBox ul{padding-left:20px;margin:0} #reportBox li{margin-bottom:8px}
</style>
</head>
<body>
<div id="loader" class="loader"><div class="loader-spinner"></div><div id="loader-msg"></div></div>
<div class="wrap">
  <div class="topbar card no-print">
    <div class="brand"><div style="font-size:32px">📈</div><div><div class="title">감정 데이터 입력</div><div class="muted" style="font-size:12px">Expert v4.0 · Powered by Gemini</div></div></div>
    <div class="iconbtn-group">
      <button id="manualSync" class="iconbtn" title="새로고침">🔄<span class="muted" style="font-size:10px;font-weight:bold">새로고침</span></button>
      <button id="openSheet" class="iconbtn" title="구글 시트 열기" disabled>📄<span class="muted" style="font-size:10px;font-weight:bold">시트보기</span></button>
      <button id="gear" class="iconbtn" title="연동 설정">⚙️<span class="muted" style="font-size:10px;font-weight:bold">설정</span></button>
    </div>
  </div>
  <section id="login" class="card"><div class="row" style="justify-content:space-between;align-items:center"><h2>🔐 반 선택 로그인</h2><div class="muted">관리자: admin123</div></div><div class="row" id="classGrid"></div><div id="pwArea" class="hide"><div class="row"><input id="pw" type="password" placeholder="비밀번호"/><button id="btnLogin" class="btn primary">로그인</button></div><div class="muted" style="margin-top:6px">연결: <span id="linkStatus" class="pill">미설정</span> · 서버 <span id="sv">0</span></div></div></section>
  <section id="app" class="card hide">
    <div class="row" style="justify-content:space-between;align-items:center"><h2></h2><div class="row no-print"><div id="who" class="pill">-</div><button id="btnLogout" class="btn">로그아웃</button></div></div>
    <div class="tabs no-print" id="tabs"><button class="tab active" data-tab="am">🏫 등교</button><button class="tab" data-tab="pm">🏡 하교</button><button class="tab" data-tab="data">📋 데이터 관리</button><button class="tab" data-tab="graph">📊 보고서</button><button class="tab" data-tab="list">👥 학생목록</button><button class="tab" data-tab="new">➕ 학생등록</button></div>
    <div id="tab-am"><div class="row" style="justify-content:center;gap:8px"><button class="btn" id="amPrev">◀</button><button class="pill" id="amDateBtn"><span id="amDate"></span></button><input id="amDatePicker" class="hide" type="date"/><button class="btn" id="amNext">▶</button></div><h3>학생 선택</h3><div id="amScroller" class="scroller"></div><div id="amForm" class="hide"><h3 id="amWho" style="text-align:center;margin-top:16px"></h3><div id="amEmotions"></div><div id="amCtxWrap" class="hide"><div style="text-align:center;margin:12px 0 8px" class="muted">어떤 상황이었나요? (복수선택 가능)</div><div id="amCtx" class="context"></div></div><div class="row" style="margin-top:16px;justify-content:center"><button class="btn primary" id="amSave" style="padding:12px 32px">저장하기</button></div></div></div>
    <div id="tab-pm" class="hide"><div class="row" style="justify-content:center;gap:8px"><button class="btn" id="pmPrev">◀</button><button class="pill" id="pmDateBtn"><span id="pmDate"></span></button><input id="pmDatePicker" class="hide" type="date"/><button class="btn" id="pmNext">▶</button></div><h3>학생 선택</h3><div id="pmScroller" class="scroller"></div><div id="pmForm" class="hide"><h3 id="pmWho" style="text-align:center;margin-top:16px"></h3><div id="pmEmotions"></div><div id="pmCtxWrap" class="hide"><div style="text-align:center;margin:12px 0 8px" class="muted">어떤 상황이었나요? (복수선택 가능)</div><div id="pmCtx" class="context"></div></div><div class="row" style="margin-top:16px;justify-content:center"><button class="btn primary" id="pmSave" style="padding:12px 32px">저장하기</button></div></div></div>
    <div id="tab-data" class="hide"><div class="row"><select id="dataStudentSelect"></select><button id="btnClear" class="btn ghost">전체보기</button></div><table><thead><tr><th>날짜</th><th>학생</th><th>구분</th><th>점수</th><th>맥락</th><th>관리</th></tr></thead><tbody id="dataBody"></tbody></table></div>
    <div id="tab-graph" class="hide"><div class="row"><select id="graphStudent"></select><input type="date" id="fromDate"><input type="date" id="toDate"><button class="btn" id="btnGraph">생성</button><button class="btn" id="btnPrint">🖨️ 인쇄</button></div><canvas id="chart"></canvas><div id="reportBox" class="card" style="margin-top:16px"></div></div>
    <div id="tab-list" class="hide"><h3>학생 목록</h3><div id="stuList"></div></div>
    <div id="tab-new" class="hide"><h3>학생 등록</h3><div class="row"><input id="newName" placeholder="학생 이름"><div id="newAvatar" class="avatar">👤</div></div><div class="emoji-picker" id="newEmojiPicker"></div><label for="photo" class="btn" style="width:100%;text-align:center">또는 사진 업로드</label><input id="photo" type="file" accept="image/*" class="hide"><div style="height:8px"></div><label>학급</label><div id="chipsClass" class="context"></div><label>성별</label><div id="chipsSex" class="context"></div><div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn primary" id="addStu">등록</button></div></div>
  </section>
</div>
<div id="modalSettings" class="modal"><div class="box"><h3>연동 설정</h3><p class="muted">배포된 웹앱 URL을 붙여넣고 저장하세요.</p><input id="syncUrlInput" placeholder="https://script.google.com/macros/s/..."><div class="row" style="justify-content:flex-end;margin-top:10px"><button id="saveUrl" class="btn primary">저장</button><button class="btn" onclick="closeModal('#modalSettings')">닫기</button></div></div></div>
<div id="modalDone" class="modal"><div class="box"><h3>✅ 완료</h3><div id="doneMsg"></div><div class="row" style="justify-content:flex-end;margin-top:10px"><button id="doneOk" class="btn primary">확인</button></div></div></div>
<div id="modalEdit" class="modal"><div class="box"><h3>학생 정보 수정</h3><div class="row"><input id="editName" placeholder="이름"><div id="editAvatar" class="avatar">👤</div></div><div class="emoji-picker" id="editEmojiPicker"></div><label for="editPhoto" class="btn" style="width:100%;text-align:center">또는 사진 업로드</label><input id="editPhoto" type="file" accept="image/*" class="hide"><div style="height:8px"></div><label>학급</label><div id="editClass" class="context"></div><label>성별</label><div id="editSex" class="context"></div><div class="row" style="justify-content:flex-end;margin-top:10px"><button id="editSave" class="btn primary">저장</button><button class="btn" onclick="closeModal('#modalEdit')">닫기</button></div></div></div>

<script>
(async function(){
  "use strict";
  const KEY_URL="sync_url_full_v4";
  const PWD={A:"a123",B:"b123",C:"c123",D:"d123",E:"e123",F:"f123",admin:"admin123"};
  let SYNC_URL=localStorage.getItem(KEY_URL)||"";
  let serverVersion=0, localStudentVersion=0;
  let currentUser=null, students=[], emotion={};
  let editTargetId=null;
  let chartInstance = null;
  const PROFILE_EMOJIS = ['🐯', '🐰', '🐼', '🦊', '🐨', '🐵', '🦄', '🦖'];

  const EMO={
    5:{e:"😊",n:"행복해요",d:"웃음, 눈 반짝임, 손뼉치기 등"},
    4:{e:"🙂",n:"좋아요",d:"편안한 얼굴, 활동에 적극적 참여"},
    3:{e:"😐",n:"괜찮아요",d:"표정 변화 적음, 지시에 반응"},
    2:{e:"😕",n:"살짝 불편",d:"눈썹 찌푸림, 꼼지락거림, 거부 시작"},
    1:{e:"😟",n:"힘들어요",d:"울상, 눈물, 몸 움츠림, 소리 지름"},
    0:{e:"😫",n:"괴로워요",d:"울음/고함, 바닥 눕기, 자해 시도"}
  };

  const CTX=[["😴 수면부족"],["💊 건강저하"],["🏠 가정이슈"],["🔄 활동전환"],["🧒 또래갈등"],["👀 관심요구"],["🎁 강화제요구"],["🚪 과제회피"],["🌀 감각추구"],["🔊 소음민감"],["🍽️ 배고픔"],["🤕 통증/불편"],["📅 일정변경"],["🚌 등하교피로"],["🌤️ 날씨영향"]];
  const OPS={classes:["A","B","C","D","E","F"],sex:["남","여"]};

  const $=s=>document.querySelector(s),$$=s=>[...document.querySelectorAll(s)];
  const fmt=d=>new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split("T")[0];
  const dateK=d=>d.toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric"});
  function showLoader(msg){$("#loader-msg").textContent=msg||"처리 중...";$("#loader").classList.add("show");}
  function hideLoader(){$("#loader").classList.remove("show");}
  function openModal(id){$(id).classList.add("show");} function closeModal(id){$(id).classList.remove("show");}
  function done(msg){$("#doneMsg").textContent=msg||"완료되었습니다.";openModal("#modalDone");}
  
  async function api(action,params={}){if(!SYNC_URL)throw new Error("웹앱 URL 미설정");const u=new URL(SYNC_URL);u.searchParams.set('action',action);for(const k in params)u.searchParams.set(k,params[k]);const r=await fetch(u);if(!r.ok)throw new Error(`서버 통신 오류: ${r.status}`);const j=await r.json();if(j.error)throw new Error(`서버 오류: ${j.error}`);if(j.version){serverVersion=j.version;$("#sv").textContent=serverVersion}return j}
  async function postApi(body){if(!SYNC_URL)throw new Error("웹앱 URL 미설정");const r=await fetch(SYNC_URL,{method:"POST",body:JSON.stringify(body)});if(!r.ok)throw new Error(`서버 통신 오류: ${r.status}`);const j=await r.json();if(j.error)throw new Error(`서버 오류: ${j.error}`);if(j.version){serverVersion=j.version;$("#sv").textContent=serverVersion}return j}
  function setSyncUrl(url){SYNC_URL=url.trim();localStorage.setItem(KEY_URL,SYNC_URL);$("#linkStatus").textContent=SYNC_URL?"설정됨":"미설정";}

  function chipContainer(el,ops,single=false){const c=$(el);c.innerHTML=ops.map(v=>`<div class="chip" data-v="${v}">${v}</div>`).join("");c.onclick=e=>{const t=e.target.closest(".chip");if(!t)return;if(single){c.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected"));t.classList.add("selected");}else t.classList.toggle("selected");};}
  function getChips(el){return $$(`${el} .chip.selected`).map(x=>x.dataset.v);}
  function setChips(el,vals,ops,single=false){const c=$(el);c.innerHTML=ops.map(v=>`<div class="chip ${vals.includes(v)?'selected':''}" data-v="${v}">${v}</div>`).join("");c.onclick=e=>{const t=e.target.closest(".chip");if(!t)return;if(single){c.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected"));t.classList.add("selected");}else t.classList.toggle("selected");};}
  
  function createEmojiPicker(containerId, avatarId){
    const picker = $(`#${containerId}`);
    const avatar = $(`#${avatarId}`);
    picker.innerHTML = PROFILE_EMOJIS.map(emoji => `<div class="emoji-choice" data-emoji="${emoji}">${emoji}</div>`).join('');
    picker.onclick = e => {
      const target = e.target.closest('.emoji-choice');
      if (!target) return;
      picker.querySelectorAll('.emoji-choice').forEach(c => c.classList.remove('selected'));
      target.classList.add('selected');
      avatar.textContent = target.dataset.emoji;
      avatar.dataset.selected = target.dataset.emoji;
    };
  }

  function renderStudents(containerSel){
    const container=$(containerSel);
    const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    container.innerHTML=list.map(s=>`<div class="stu" data-id="${s.id}"><div class="avatar" style="${s.photo.startsWith('data:image') ? `background-image:url(${s.photo})` : ''}">${s.photo.startsWith('data:image') ? '' : s.photo}</div><div style="font-weight:800;margin-top:6px">${s.name}</div></div>`).join("")||`<div class="muted">등록된 학생이 없습니다.</div>`;
    container.onclick=e=>{const card=e.target.closest(".stu");if(!card)return;container.querySelectorAll(".stu").forEach(x=>x.classList.remove("selected"));card.classList.add("selected");const sid=card.dataset.id;const s=students.find(x=>x.id==sid);const p=containerSel.includes("am")?"am":"pm";$(`#${p}Form`).classList.remove("hide");$(`#${p}Who`).textContent=`${s.name} 학생 감정기록`;container.dataset.sel=sid;};
  }
  function renderEmo(prefix){const box=$(`#${prefix}Emotions`);box.innerHTML=Object.keys(EMO).sort((a,b)=>b-a).map(sc=>`<div class="emoBtn" data-score="${sc}"><div style="font-size:28px">${EMO[sc].e}</div><div><div style="font-weight:800">${sc}점 · ${EMO[sc].n}</div><div class="muted" style="font-size:12px">${EMO[sc].d}</div></div></div>`).join("");box.onclick=e=>{const b=e.target.closest(".emoBtn");if(!b)return;box.querySelectorAll(".emoBtn").forEach(x=>x.classList.remove("active"));b.classList.add("active");box.dataset.score=b.dataset.score;$(`#${prefix}CtxWrap`).classList.remove("hide");};}
  function renderCtx(prefix){const el=$(`#${prefix}Ctx`);el.innerHTML=CTX.map(([t])=>`<div class="chip" data-k="${t}">${t}</div>`).join("");el.onclick=e=>{const c=e.target.closest(".chip");if(!c)return;c.classList.toggle("selected");};}
  
  async function handleSaveEmotion(prefix, btn){
    btn.disabled=true; showLoader("저장 중...");
    try{
      const scroller=$(`#${prefix}Scroller`),sid=scroller.dataset.sel;
      const box=$(`#${prefix}Emotions`),score=box.dataset.score;
      if(!sid||score===undefined){throw new Error("학생과 감정을 선택하세요.");}
      const date=fmt(prefix==="am"?amDate:pmDate);
      const ctxSel=$$(`#${prefix}Ctx .chip.selected`).map(x=>x.dataset.k);
      await postApi({action:"add_emotion",date,student_id:sid,slot:(prefix==="am"?"morning":"afternoon"),score:Number(score),context:ctxSel});
      done("저장되었습니다.");
      box.querySelector('.active')?.classList.remove('active');
      box.dataset.score = '';
      $(`#${prefix}CtxWrap`).classList.add("hide");
      $$(`#${prefix}Ctx .chip`).forEach(x=>x.classList.remove("selected"));
      scroller.querySelector('.selected')?.classList.remove('selected');
      $(`#${prefix}Form`).classList.add('hide');
    }catch(e){done(`저장 실패: ${e.message}`);}
    finally{btn.disabled=false;hideLoader();}
  }

  let amDate=new Date(),pmDate=new Date();
  function setDates(){$("#amDate").textContent=dateK(amDate);$("#pmDate").textContent=dateK(pmDate);$("#amDatePicker").value=fmt(amDate);$("#pmDatePicker").value=fmt(pmDate);}

  async function onTabClick(tabId){
    $$(".tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===tabId));
    $$("[id^='tab-']").forEach(p=>p.classList.toggle("hide",p.id!==`tab-${tabId}`));
    showLoader("데이터 로딩 중...");
    try{
      if (localStudentVersion < serverVersion) await fetchStudents();
      if(tabId==="list"){ renderStudentList(); }
      else if(tabId==="data"){ await fetchAndRenderEmotions(currentUser); }
      else if(tabId==="graph"){ renderGraphStudentSelect(); }
    }catch(e){done(`탭 로딩 실패: ${e.message}`);}
    finally{hideLoader();}
  }

  async function fetchStudents(){students=(await api('get_students')).students||[];localStudentVersion=serverVersion;}
  async function fetchAndRenderEmotions(userClass){
    emotion=(await api('get_emotions', { userClass: userClass })).emotion||{};
    renderDataManager();
    renderDataStudentSelect();
  }

  function renderStudentList(){
    const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    $("#stuList").innerHTML=list.map(s=>`<div class="row" style="justify-content:space-between;border-bottom:1px solid #e5e7eb;padding:8px 0"><div class="row"><div class="avatar" style="${s.photo.startsWith('data:image')?`background-image:url(${s.photo})`:''}">${s.photo.startsWith('data:image')?'':s.photo}</div><div><div><b>${s.name}</b> <span class="muted">(${(s.classes||[]).join(", ")})</span></div></div></div><div class="row"><button class="btn" data-edit="${s.id}">수정</button><button class="btn danger" data-del="${s.id}">삭제</button></div></div>`).join("")||`<div class="muted">학생 없음</div>`;
  }
  
  function renderDataStudentSelect(){
      const select = $('#dataStudentSelect');
      const list = currentUser === "admin" ? students : students.filter(s=>(s.classes||[]).includes(currentUser));
      select.innerHTML = `<option value="">학생 전체</option>` + list.map(s=>`<option value="${s.name}">${s.name}</option>`).join('');
  }

  function renderDataManager(filter=""){
    const body=$("#dataBody");body.innerHTML="";
    const dates=Object.keys(emotion).sort((a,b)=>b.localeCompare(a));
    dates.forEach(k=>{const day=emotion[k];Object.keys(day).forEach(sid=>{const rec=day[sid],nm=rec.name||"";if(filter&&nm!==filter)return;['morning','afternoon'].forEach(slot=>{const cur=rec[slot];if(!cur)return;const tr=document.createElement("tr");tr.innerHTML=`<td>${k}</td><td>${nm}</td><td>${slot==="morning"?"등교":"하교"}</td><td>${cur.score}</td><td>${(cur.context||[]).join(", ")}</td><td><button class="btn danger" data-del="true">삭제</button></td>`;tr.dataset.date=k;tr.dataset.sid=sid;tr.dataset.slot=slot;body.appendChild(tr);});});});
  }
  function renderGraphStudentSelect(){const sel=$("#graphStudent");const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));sel.innerHTML=`<option value="">학생 선택</option>`+list.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");}

  async function handleGraph(){
    const sid=$("#graphStudent").value, from=$("#fromDate").value, to=$("#toDate").value;
    if(!sid||!from||!to){return done("학생과 기간을 선택하세요.");}
    const btn=$("#btnGraph");btn.disabled=true;showLoader("보고서 생성 중...");
    try{
      const s=students.find(x=>x.id==sid);
      const periodEmotion=await api('get_emotions',{from,to});
      drawGraphTitle(s?.name||"");
      const g=getRangeData(sid,from,to,periodEmotion.emotion);
      drawChart("chart",g.labels,g.am,g.pm);
      genReport(s,from,to,periodEmotion.emotion);
    }catch(e){done(`그래프 생성 실패: ${e.message}`);}
    finally{btn.disabled=false;hideLoader();}
  }
  function getRangeData(sid,from,to,emoData){const labels=[],am=[],pm=[];const cur=new Date(from);const end=new Date(to);while(cur<=end){const k=fmt(cur),r=emoData[k]?.[sid];labels.push(k.slice(5));am.push(r?.morning?.score??null);pm.push(r?.afternoon?.score??null);cur.setDate(cur.getDate()+1);}return{labels,am,pm};}
  function drawGraphTitle(name){$("#graphTitle").textContent=name?`${name} 학생 감정 모니터링`:"";}
  
  function drawChart(canvasId,labels,am,pm){
    const c=$(`#${canvasId}`),ctx=c.getContext('2d');
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: '등교', data: am, borderColor: '#ef4444', backgroundColor: '#ef4444', fill: false, pointStyle: 'circle', radius: 5, tension: 0.1 },
          { label: '하교', data: pm, borderColor: '#2563eb', backgroundColor: '#2563eb', fill: false, pointStyle: 'triangle', radius: 6, tension: 0.1 }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false,
        scales: { y: { min: 0, max: 5, ticks: { stepSize: 1 } } }
      }
    });
  }
  
  function genReport(s,from,to,emoData){
    const box = $("#reportBox");
    if(!s){box.innerHTML="학생 정보 없음";return;}
    const recs=[];const cur=new Date(from),end=new Date(to);
    while(cur<=end){const k=fmt(cur);const r=emoData[k]?.[s.id];if(r?.morning)recs.push({score:r.morning.score,ctx:r.morning.context||[]});if(r?.afternoon)recs.push({score:r.afternoon.score,ctx:r.afternoon.context||[]});cur.setDate(cur.getDate()+1);}
    if(recs.length===0){box.innerHTML=`<div class="muted">선택된 기간에 데이터가 없습니다.</div>`;return;}
    
    const lowRecs=recs.filter(r=>r.score<=1);
    const ctxCount={};lowRecs.forEach(r=>r.ctx.forEach(c=>ctxCount[c]=(ctxCount[c]||0)+1));
    const topCtx=Object.entries(ctxCount).sort((a,b)=>b[1]-a[1]).slice(0,3);

    let html = `<h4>전문가 소견</h4><ul>`;
    const perspectives = {
      behavioral: "<b>[행동적 관점]</b> 데이터에 따르면, 학생의 감정적 어려움은 특정 선행사건과 정적/부적 강화의 결과로 나타날 수 있습니다. 특히, '${topCtx[0]?.[0] || "다양한"}' 상황에서 나타나는 행동은 특정 기능을 가질 가능성이 높으므로 기능 평가(FBA)를 고려해볼 수 있습니다.",
      sensory: "<b>[감각통합적 관점]</b> 학생의 감정 기복은 감각 처리의 어려움과 관련될 수 있습니다. '${topCtx.find(([k])=>k.includes('감각')||k.includes('소음'))?.[0] || '특정'}' 맥락에서의 부정적 반응은 감각 과부하 또는 미충족된 감각 추구 욕구를 시사하며, 안정적인 각성 수준 유지를 위한 환경 조절이 필요합니다.",
      cognitive: "<b>[인지심리학적 관점]</b> 학생은 특정 상황을 위협적이거나 압도적으로 해석하는 인지적 왜곡을 경험할 수 있습니다. 감정 조절의 어려움은 문제 해결 기술이나 대처 전략의 부재를 반영할 수 있으므로, 상황을 재해석하고 긍정적으로 대처하는 방법을 가르치는 것이 중요합니다."
    };
    html += `<li>${perspectives.behavioral}</li><li>${perspectives.sensory}</li><li>${perspectives.cognitive}</li></ul>`;
    
    html += `<h4>중재 계획 제안</h4>`;
    const plans = {
      med: "<b>약물 치료:</b> 학생의 정서적 불안정성이 일상 기능에 심각한 영향을 미친다면, 소아청소년 정신건강의학과 전문의와의 상담을 통해 약물적 개입을 고려할 수 있습니다. 이는 교육적·행동적 중재와 병행될 때 효과적이므로, 반드시 전문가의 정확한 진단과 처방에 따라야 합니다.",
      setting: "<b>배경사건 중재:</b> 학생의 전반적인 컨디션을 안정시키는 것이 중요합니다. 충분한 수면, 규칙적인 식사, 안정적인 가정 환경을 확보하고, 등교 전 학생이 예측 가능한 일과를 경험하도록 지원하여 스트레스 요인을 사전에 최소화해야 합니다.",
      antecedent: "<b>선행사건 중재:</b> 감정적 어려움을 유발하는 상황을 사전에 예방하는 전략이 필요합니다. '활동전환'이 어려운 경우 시각적 시간표(visual schedule)를 제공하고, '과제회피'가 나타나면 과제 난이도를 조절하거나 선택권을 제공하는 것이 효과적입니다.",
      skill: "<b>대체기술 교수:</b> 부적절한 행동 대신 사용할 수 있는 기능적인 기술을 가르쳐야 합니다. 예를 들어, 도움이 필요할 때 소리 지르는 대신 '도와주세요' 카드나 AAC를 사용하도록 가르치는 기능적 의사소통 훈련(FCT)이 필수적입니다.",
      reinforce: "<b>강화 전략:</b> 긍정적인 행동과 감정 표현을 즉각적으로 인정하고 칭찬하여 바람직한 행동의 빈도를 높입니다. 학생이 선호하는 강화제(예: 스티커, 짧은 휴식)를 활용한 토큰 경제(token economy)를 도입하여 동기를 부여하는 것이 좋습니다.",
      crisis: "<b>위기관리 계획:</b> 학생이 자신이나 타인에게 위험을 초래할 수 있는 행동(예: 자해, 공격성)을 보일 경우를 대비한 명확한 계획이 필요합니다. 위기 상황에서는 우선 학생과 주변의 안전을 확보하고, 사전에 약속된 안전한 공간으로 이동시켜 감정이 진정될 때까지 지원합니다."
    };
    html += `<ul>${Object.values(plans).map(p=>`<li>${p}</li>`).join('')}</ul>`;
    box.innerHTML = html;
  }
  
  async function imgToDataURL(file){return new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(file);});}
  
  document.addEventListener("DOMContentLoaded", async ()=>{
    setSyncUrl(new URLSearchParams(location.search).get("gsUrl")||SYNC_URL);
    $("#gear").onclick=()=>openModal("#modalSettings");$("#doneOk").onclick=()=>closeModal("#modalDone");
    $("#saveUrl").onclick=()=>{setSyncUrl($("#syncUrlInput").value);done("URL이 저장되었습니다.");closeModal("#modalSettings");};
    $$(".tab").forEach(t=>t.onclick=()=>onTabClick(t.dataset.tab));
    
    $("#classGrid").innerHTML=['A','B','C','D','E','F','admin'].map(k=>`<button class="btn" data-class="${k}">${k==="admin"?'🔑 관리자':`학급 ${k}`}</button>`).join("");
    $("#classGrid").onclick=e=>{const c=e.target.dataset.class;if(!c)return;currentUser=c;$("#pwArea").classList.remove("hide");$("#pw").focus();};
    $("#btnLogin").onclick=async()=>{const btn=$("#btnLogin");btn.disabled=true;showLoader("로그인 중...");try{if($("#pw").value.trim()!==PWD[currentUser])throw new Error("비밀번호가 틀립니다.");if(!SYNC_URL){openModal("#modalSettings");throw new Error("먼저 연동 설정을 해주세요.");}await fetchStudents();$("#login").classList.add("hide");$("#app").classList.remove("hide");$("#who").textContent=currentUser==="admin"?"관리자":`${currentUser}학급`;renderStudents("#amScroller");renderStudents("#pmScroller");}catch(e){done(`로그인 실패: ${e.message}`);}finally{btn.disabled=false;hideLoader();}};
    $("#pw").onkeydown=e=>{if(e.key==="Enter")$("#btnLogin").click();};
    $("#btnLogout").onclick=()=>location.reload();
    $("#openSheet").onclick=async()=>{try{const {sheetUrl}=await api('get_sheet_url');if(sheetUrl)window.open(sheetUrl,'_blank')}catch(e){}};
    
    renderEmo("am");renderEmo("pm");renderCtx("am");renderCtx("pm");setDates();
    const past=new Date();past.setDate(past.getDate()-14);$("#fromDate").value=fmt(past);$("#toDate").value=fmt(new Date());
    
    $("#amSave").onclick=(e)=>handleSaveEmotion("am",e.target); $("#pmSave").onclick=(e)=>handleSaveEmotion("pm",e.target);
    $("#amPrev").onclick=()=>{amDate.setDate(amDate.getDate()-1);setDates();}; $("#amNext").onclick=()=>{amDate.setDate(amDate.getDate()+1);setDates();};
    $("#pmPrev").onclick=()=>{pmDate.setDate(pmDate.getDate()-1);setDates();}; $("#pmNext").onclick=()=>{pmDate.setDate(pmDate.getDate()+1);setDates();};
    $("#amDateBtn").onclick=()=>$("#amDatePicker").showPicker?.();$("#pmDateBtn").onclick=()=>$("#pmDatePicker").showPicker?.();
    $("#amDatePicker").onchange=e=>{amDate=new Date(e.target.value);setDates();};$("#pmDatePicker").onchange=e=>{pmDate=new Date(e.target.value);setDates();};

    createEmojiPicker('newEmojiPicker', 'newAvatar');
    createEmojiPicker('editEmojiPicker', 'editAvatar');
    $("#addStu").onclick=async(e)=>{const btn=e.target;btn.disabled=true;showLoader("등록 중...");try{const name=$("#newName").value.trim();if(!name)throw new Error("이름을 입력하세요.");let photo=$("#newAvatar").dataset.selected||PROFILE_EMOJIS[0];const f=$("#photo").files[0];if(f)photo=await imgToDataURL(f);let classes=getChips("#chipsClass");if(!classes.length&&currentUser!=="admin")classes=[currentUser];const s={id:Date.now(),name,photo,classes,sex:getChips("#chipsSex")[0]||""};await postApi({action:"add_student",student:s});done("학생이 등록되었습니다.");localStudentVersion=0;$$("#tab-new .chip.selected").forEach(c=>c.classList.remove("selected"));$("#newName").value=$("#photo").value="";$("#newAvatar").textContent="👤";$("#newAvatar").dataset.selected="";}catch(err){done(`등록 실패: ${err.message}`);}finally{btn.disabled=false;hideLoader();}};
    $("#photo").onchange=async(e)=>{const f=e.target.files[0];if(!f)return;const dataUrl=await imgToDataURL(f);$("#newAvatar").style.backgroundImage=`url(${dataUrl})`;$("#newAvatar").textContent='';$("#newAvatar").dataset.selected=dataUrl;};
    chipContainer("#chipsClass",OPS.classes);chipContainer("#chipsSex",OPS.sex,true);
    
    $("#stuList").onclick=async(e)=>{const editBtn=e.target.closest("[data-edit]"),delBtn=e.target.closest("[data-del]");if(editBtn){editTargetId=editBtn.dataset.edit;const s=students.find(x=>x.id==editTargetId);if(!s)return;$("#editName").value=s.name||"";const avatar=$("#editAvatar");if(s.photo.startsWith('data:image')){avatar.style.backgroundImage=`url(${s.photo})`;avatar.textContent=''}else{avatar.style.backgroundImage='';avatar.textContent=s.photo||'👤'}avatar.dataset.selected=s.photo;$("#editPhoto").value="";setChips("#editClass",s.classes||[],OPS.classes);setChips("#editSex",[s.sex||""],OPS.sex,true);openModal("#modalEdit");}if(delBtn){if(!confirm("학생의 모든 기록이 삭제됩니다. 계속할까요?"))return;showLoader("삭제 중...");try{await postApi({action:"delete_student",id:delBtn.dataset.del});done("삭제되었습니다.");localStudentVersion=0;await onTabClick("list");}catch(err){done(`삭제 실패: ${err.message}`);}finally{hideLoader();}}};
    $("#editSave").onclick=async(e)=>{const btn=e.target;btn.disabled=true;showLoader("수정 중...");try{const s=students.find(x=>x.id==editTargetId);if(!s)throw new Error("학생 정보 없음");s.name=$("#editName").value.trim();s.photo=$("#editAvatar").dataset.selected;const pf=$("#editPhoto").files[0];if(pf)s.photo=await imgToDataURL(pf);s.classes=getChips("#editClass");s.sex=getChips("#editSex")[0]||"";await postApi({action:"update_student",student:s});done("수정되었습니다.");localStudentVersion=0;await onTabClick("list");closeModal("#modalEdit");}catch(err){done(`수정 실패: ${err.message}`);}finally{btn.disabled=false;hideLoader();}};
    $("#editPhoto").onchange=async(e)=>{const f=e.target.files[0];if(!f)return;const dataUrl=await imgToDataURL(f);const avatar=$("#editAvatar");avatar.style.backgroundImage=`url(${dataUrl})`;avatar.textContent='';avatar.dataset.selected=dataUrl;};

    $("#dataBody").onclick=async e=>{const btn=e.target.closest("[data-del]");if(!btn||!confirm("이 기록을 삭제할까요?"))return;const tr=btn.closest("tr");showLoader("삭제 중...");try{await postApi({action:"delete_emotion",date:tr.dataset.date,student_id:tr.dataset.sid,slot:tr.dataset.slot});done("삭제되었습니다.");tr.remove();}catch(err){done(`삭제 실패: ${err.message}`);}finally{hideLoader();}};
    $("#dataStudentSelect").onchange=e=>renderDataManager(e.target.value);$("#btnClear").onclick=()=>{$("#dataStudentSelect").value="";renderDataManager();};
    
    $("#btnGraph").onclick=handleGraph; $("#btnPrint").onclick=()=>window.print();
    $("#manualSync").onclick=async()=>{showLoader("동기화 중...");try{const v=await api('version');if(v.version!==localStudentVersion){await fetchStudents();renderStudents("#amScroller");renderStudents("#pmScroller");done("최신 정보로 동기화되었습니다.");}else{done("이미 최신 상태입니다.");}}catch(e){done(`동기화 실패: ${e.message}`);}finally{hideLoader();}};
    
    // Load Chart.js library
    const script=document.createElement('script');script.src='https://cdn.jsdelivr.net/npm/chart.js';document.head.appendChild(script);
  });
})();
</script>
</body>
</html>
