<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>감정 데이터 분석 도구 · 실시간 동기화</title>
<style>
  :root{
    --bg:#f7f9fc;--panel:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#4f46e5;
    --accent:#22c55e;--danger:#ef4444;--border:#e5e7eb;--chip:#f1f5f9;
    --red:#ef4444;--blue:#2563eb;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
  .wrap{max-width:1180px;margin:0 auto;padding:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;white-space:nowrap}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:12px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:700;min-height:40px}
  .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
  .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
  .btn.ghost{background:#fff}
  .tabs{display:flex;gap:10px;overflow:auto;margin-bottom:12px}
  .tab{padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;white-space:nowrap}
  .tab.active{background:var(--primary);color:#fff;border-color:transparent}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
  .scroller{display:flex;gap:12px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:6px 2px}
  .stu{flex:0 0 210px;background:#fff;border:2px solid var(--border);border-radius:16px;padding:12px;text-align:center}
  .stu.selected{border-color:var(--primary);box-shadow:0 0 0 2px rgba(79,70,229,.22) inset}
  .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#e5e7eb;border:2px solid #fff;box-shadow:0 6px 14px rgba(0,0,0,.06)}
  .emoList{display:grid;gap:10px}
  .emoBtn{display:flex;align-items:center;gap:12px;border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;cursor:pointer}
  .emoBtn.active{border-color:var(--primary);background:#eef2ff}
  .emoEmoji{font-size:28px}
  .emoTitle{font-weight:800}
  .emoScale{font-size:12px;color:#475569}
  .context{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .chip{padding:9px 12px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:13px;cursor:pointer;text-align:center;user-select:none}
  .chip.selected{background:var(--primary);color:#fff;border-color:transparent}
  .hint{grid-column:1/-1;font-size:12px;color:#475569;display:none}
  .hint.show{display:block}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:6px;text-align:center;font-size:13px}
  th{background:#f3f4f6}
  .hide{display:none!important}
  canvas{width:100%;height:420px;border:1px solid var(--border);border-radius:12px;background:#fff}
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:10px;background:radial-gradient(circle at 30% 30%, #8b5cf6, #2563eb);box-shadow:0 6px 16px rgba(37,99,235,.35)}
  .title{font-weight:900;font-size:20px}
  .muted{color:#64748b}
  .iconbtn{width:40px;height:40px;border-radius:12px;border:1px solid var(--border);background:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
  @media (max-width:640px){ .stu{flex:0 0 160px} .title{font-size:18px} }
  @media print{ .no-print{display:none!important} body{background:#fff} .card{border:0;box-shadow:none} @page{size:A4;margin:12mm} }
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal.show{display:flex}
  .modal .box{background:#fff;border-radius:16px;max-width:440px;width:100%;padding:18px;border:1px solid var(--border);box-shadow:0 24px 48px rgba(0,0,0,.25)}
  .modal .box h3{margin:0 0 8px 0}
  .right-bottom{position:sticky;bottom:0;display:flex;justify-content:flex-end}
</style>
</head>
<body>
<div class="wrap">

  <!-- 상단바 -->
  <div class="topbar card no-print">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title">감정 데이터 분석 도구</div>
        <div class="muted" style="font-size:12px">교육 현장 최적화 · 실시간 동기화</div>
      </div>
    </div>
    <div class="row">
      <button id="openSheet" class="iconbtn" title="구글 시트 열기" disabled>📄</button>
      <button id="gear" class="iconbtn" title="연동 설정">⚙️</button>
    </div>
  </div>

  <!-- 로그인 -->
  <section id="login" class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>🔐 반 선택 로그인</h2>
      <div class="muted">A~F: a123~f123 · 관리자: admin123</div>
    </div>
    <div class="row" id="classGrid"></div>
    <div id="pwArea" class="hide">
      <div class="row">
        <input id="pw" type="password" placeholder="비밀번호 (예: a123)" />
        <button id="btnLogin" class="btn primary">로그인</button>
      </div>
      <div class="muted" style="margin-top:6px">
        연결: <span id="linkStatus" class="pill">미설정</span> · 서버 버전 <span id="sv">0</span>
      </div>
    </div>
  </section>

  <!-- 본체 -->
  <section id="app" class="card hide">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>📘 수업 데이터 입력</h2>
      <div class="row no-print">
        <div id="who" class="pill">-</div>
        <button id="btnLogout" class="btn">로그아웃</button>
      </div>
    </div>

    <div class="tabs no-print" id="tabs">
      <button class="tab active" data-tab="am">🏫 등교입력</button>
      <button class="tab" data-tab="pm">🏡 하교입력</button>
      <button class="tab" data-tab="data">📋 데이터 관리</button>
      <button class="tab" data-tab="graph">📈 그래프·보고서</button>
      <button class="tab" data-tab="list">👥 학생목록</button>
      <button class="tab" data-tab="new">➕ 학생등록</button>
    </div>

    <!-- AM -->
    <div id="tab-am">
      <div class="row" style="justify-content:center;gap:8px">
        <button class="btn" id="amPrev">◀</button>
        <button class="pill" id="amDateBtn" title="눌러서 날짜 선택"><span id="amDate"></span> 📅</button>
        <input id="amDatePicker" class="hide" type="date"/>
        <button class="btn" id="amNext">▶</button>
      </div>
      <h3>학생 선택</h3><div id="amScroller" class="scroller"></div>
      <div id="amForm" class="hide">
        <h3 id="amWho" style="text-align:center"></h3>
        <div class="emoList" id="amEmotions"></div>
        <div id="amCtxWrap" class="hide">
          <div style="height:8px"></div>
          <div class="muted" style="text-align:center">간편 맥락 (복수 선택)</div>
          <div id="amCtx" class="context"></div>
          <div id="amHint" class="hint">예시가 여기에 표시됩니다.</div>
        </div>
        <div class="row"><button class="btn primary" id="amSave">저장</button></div>
      </div>
    </div>

    <!-- PM -->
    <div id="tab-pm" class="hide">
      <div class="row" style="justify-content:center;gap:8px">
        <button class="btn" id="pmPrev">◀</button>
        <button class="pill" id="pmDateBtn" title="눌러서 날짜 선택"><span id="pmDate"></span> 📅</button>
        <input id="pmDatePicker" class="hide" type="date"/>
        <button class="btn" id="pmNext">▶</button>
      </div>
      <h3>학생 선택</h3><div id="pmScroller" class="scroller"></div>
      <div id="pmForm" class="hide">
        <h3 id="pmWho" style="text-align:center"></h3>
        <div class="emoList" id="pmEmotions"></div>
        <div id="pmCtxWrap" class="hide">
          <div style="height:8px"></div>
          <div class="muted" style="text-align:center">간편 맥락 (복수 선택)</div>
          <div id="pmCtx" class="context"></div>
          <div id="pmHint" class="hint">예시가 여기에 표시됩니다.</div>
        </div>
        <div class="row"><button class="btn primary" id="pmSave">저장</button></div>
      </div>
    </div>

    <!-- Data -->
    <div id="tab-data" class="hide">
      <div class="row">
        <input id="searchName" placeholder="학생명 검색(데이터 필터)"/>
        <button id="btnSearch" class="btn">검색</button>
        <button id="btnClear" class="btn ghost">초기화</button>
      </div>
      <table>
        <thead><tr><th>날짜</th><th>학생</th><th>구분</th><th>점수</th><th>맥락</th><th>수정</th><th>삭제</th></tr></thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>

    <!-- Graph & Report -->
    <div id="tab-graph" class="hide">
      <div class="row">
        <select id="graphStudent"></select>
        <input type="date" id="fromDate"><input type="date" id="toDate">
        <button class="btn" id="btnGraph">그래프/보고서</button>
        <button class="btn" id="btnPrint">🖨️ 인쇄 / PDF</button>
      </div>
      <div style="height:8px"></div>
      <h3 id="graphTitle" style="text-align:center"></h3>
      <canvas id="chart"></canvas>
      <div class="muted" style="font-size:12px;margin-top:6px;text-align:center">
        <b>범례:</b> <span style="color:var(--red)">● AM(등교)</span> — <span style="color:var(--red)">━</span> ·
        <span style="color:var(--blue)">▲ PM(하교)</span> — <span style="color:var(--blue)">━</span> · 점 위 숫자=점수
      </div>
      <div style="height:14px"></div>
      <div id="reportBox" class="card" style="border-radius:16px"></div>
    </div>

    <!-- List -->
    <div id="tab-list" class="hide"><h3>학생 목록</h3><div id="stuList"></div></div>

    <!-- New -->
    <div id="tab-new" class="hide">
      <h3>학생 등록</h3>
      <div class="row">
        <input id="newName" type="text" placeholder="학생 이름">
        <input id="photo" type="file" accept="image/*" class="no-print">
        <img id="preview" class="avatar" alt="미리보기" />
      </div>
      <div style="height:8px"></div>
      <label>학급</label><div id="chipsClass" class="context"></div>
      <label>성별</label><div id="chipsSex" class="context"></div>
      <label>진단</label><div id="chipsDx" class="context"></div>
      <label>의사소통</label><div id="chipsComm" class="context"></div>
      <label>감각 프로필</label><div id="chipsSensory" class="context"></div>
      <label>선호 강화제</label><div id="chipsReinf" class="context"></div>
      <label>주요 유발상황</label><div id="chipsTrigger" class="context"></div>
      <label>의료/약물</label><div id="chipsMeds" class="context"></div>
      <div class="row"><input id="newParent" type="tel" placeholder="보호자 연락처"/></div>
      <div class="right-bottom"><button class="btn primary" id="addStu">등록</button></div>
    </div>
  </section>
</div>

<!-- 설정 모달 -->
<div id="modalSettings" class="modal">
  <div class="box">
    <h3>연동 설정</h3>
    <p class="muted">관리자가 한 번만 설정하면, 이후 접속자는 같은 링크로 연동됩니다.<br>웹앱 URL을 붙여넣고 저장하세요.</p>
    <input id="syncUrlInput" placeholder="웹앱 URL (https://script.google.com/macros/s/...)"/>
    <div id="shareLink" class="muted" style="font-size:12px;margin-top:6px"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="saveUrl" class="btn primary">저장</button>
      <button id="closeUrl" class="btn">닫기</button>
    </div>
  </div>
</div>

<!-- 완료 모달 -->
<div id="modalDone" class="modal">
  <div class="box">
    <h3>✅ 완료</h3>
    <div id="doneMsg" class="muted">서버에 저장되었습니다.</div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="doneOk" class="btn primary">확인</button>
    </div>
  </div>
</div>

<!-- 학생 수정 모달 -->
<div id="modalEdit" class="modal">
  <div class="box">
    <h3>학생 정보 수정</h3>
    <div class="row"><input id="editName" placeholder="이름"><input id="editPhoto" type="file" accept="image/*"><img id="editPreview" class="avatar"/></div>
    <div style="height:8px"></div>
    <label>학급</label><div id="editClass" class="context"></div>
    <label>성별</label><div id="editSex" class="context"></div>
    <label>진단</label><div id="editDx" class="context"></div>
    <label>의사소통</label><div id="editComm" class="context"></div>
    <label>감각 프로필</label><div id="editSensory" class="context"></div>
    <label>선호 강화제</label><div id="editReinf" class="context"></div>
    <label>주요 유발상황</label><div id="editTrigger" class="context"></div>
    <label>의료/약물</label><div id="editMeds" class="context"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="editSave" class="btn primary">저장</button>
      <button id="editClose" class="btn">닫기</button>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  const KEY_URL="sync_url_full";
  const PWD={A:"a123",B:"b123",C:"c123",D:"d123",E:"e123",F:"f123",admin:"admin123"};
  let SYNC_URL=localStorage.getItem(KEY_URL)||"";
  let SHEET_URL=""; // 서버에서 제공
  let serverVersion=0;
  let currentUser=null, students=[], emotion={};
  let editTargetId=null, busy=false;

  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const fmt=d=>new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split("T")[0];
  const clamp=n=>Math.max(1,Math.min(5,n|0));
  const dateK=d=>d.toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric",weekday:"long"});
  function setText(sel,txt){ const el=$(sel); if(el) el.textContent=txt; }
  function openModal(id){ $(id).classList.add("show"); } function closeModal(id){ $(id).classList.remove("show"); }
  function done(msg){ $("#doneMsg").innerHTML=msg||"입력이 완료되었습니다."; openModal("#modalDone"); }

  const EMO={
    5:{emoji:"😄",name:"매우 좋음",scale:"웃음·자발적 참여 ≥90%, 문제행동 0회"},
    4:{emoji:"🙂",name:"좋음",scale:"안정·지시 따름 75–90%, 문제행동 0–1회(짧음)"},
    3:{emoji:"😐",name:"보통",scale:"중립·참여 들쑥날쑥, 지시 따름 50–75%"},
    2:{emoji:"😕",name:"불편",scale:"찡그림·한숨, 지시 따름 25–50%, 지원 필요"},
    1:{emoji:"😣",name:"매우 어려움",scale:"울음/도망, 지시 따름 <25%, 즉각 중재"}
  };

  // 간편 맥락 15개: 3x5 배열
  const CTX=[
    ["😴 수면부족","전날 6시간 이하 수면, 아침 멍함"],
    ["💊 건강저하","감기·복통 등 컨디션 저하"],
    ["🏠 가정이슈","형제갈등/부모와 다툼 보고"],
    ["🔄 활동전환","즐거운 활동 → 과제 전환 어려움"],
    ["🧒 또래갈등","또래와 장난/갈등 후"],
    ["👀 관심요구","교사/친구 주목 끌기"],
    ["🎁 강화제요구","간식/기기 등 보상 요구"],
    ["🚪 과제회피","과제/요구 회피 시도"],
    ["🌀 감각추구","회전/딱딱 소리 추구"],
    ["🔊 소음민감","소음 환경에서 불편"],
    ["🍽️ 배고픔","간식/식사 전 강한 허기"],
    ["🤕 통증/불편","치아/복부 등 통증 호소"],
    ["📅 일정변경","예정과 다른 일정 발생"],
    ["🚌 등하교피로","이동 피로로 무기력"],
    ["🌤️ 날씨영향","더위/추위/비 등 영향"]
  ];

  const OPS={classes:["A","B","C","D","E","F"],sex:["남","여"],
    dx:["지적장애","자폐스펙트럼","ADHD","학습장애","정서·행동장애","기타"],
    comm:["구어","PECS","AAC","제스처","제한적 언어","기타"],
    sensory:["청각 과민","시각 과민","촉각 과민","압박 선호","움직임 추구","기타"],
    reinf:["스티커","음식(스낵/음료)","활동(휴식·산책)","전자기기","사회적 칭찬","기타"],
    trigger:["과제 전환","소음","일정 변경","또래 갈등","요구 거부","기타"],
    meds:["없음","항정신병제","항불안제","항경련제","기타"]
  };

  // Networking (text/plain to avoid preflight)
  async function jget(url){ const r=await fetch(url); if(!r.ok) throw new Error(String(r.status)); return r.json(); }
  async function jpost(url,body){ const r=await fetch(url,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(body)}); if(!r.ok) throw new Error(String(r.status)); return r.json(); }

  function setSyncUrl(url){
    SYNC_URL=url.trim();
    localStorage.setItem(KEY_URL,SYNC_URL);
    setText("#linkStatus", SYNC_URL? "설정됨":"미설정");
    try{
      const u=new URL(location.href); u.searchParams.set("gsUrl", SYNC_URL); history.replaceState({}, "", u.toString());
      $("#shareLink").innerHTML = `공유 링크: <code style="word-break:break-all">${u.toString()}</code>`;
    }catch{}
  }

  async function serverExport(){
    if(!SYNC_URL) throw new Error("URL 미설정");
    const j=await jget(SYNC_URL+"?action=export");
    students=j.students||[]; emotion=j.emotion||{}; serverVersion=Number(j.version||0); SHEET_URL=j.sheetUrl||"";
    setText("#sv", String(serverVersion));
    const btn=$("#openSheet"); btn.disabled = !SHEET_URL; btn.onclick = ()=>{ if(SHEET_URL) window.open(SHEET_URL,"_blank"); };
    buildAll();
  }

  async function addEmotion(date, sid, slot, score, context){
    const j=await jpost(SYNC_URL,{action:"add_emotion", date, student_id:sid, slot, score, context});
    if(!j.ok) throw new Error(j.error||"add_emotion 실패");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }
  async function upEmotion(date, sid, slot, score, context){
    const j=await jpost(SYNC_URL,{action:"update_emotion", date, student_id:sid, slot, score, context});
    if(!j.ok) throw new Error(j.error||"update_emotion 실패");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }
  async function delEmotion(date, sid, slot){
    const j=await jpost(SYNC_URL,{action:"delete_emotion", date, student_id:sid, slot});
    if(!j.ok) throw new Error(j.error||"delete_emotion 실패");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }
  async function addStudentS(s){
    const j=await jpost(SYNC_URL,{action:"add_student", student:s});
    if(!j.ok) throw new Error(j.error||"add_student 실패");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }
  async function updateStudentS(s){
    const j=await jpost(SYNC_URL,{action:"update_student", student:s});
    if(!j.ok) throw new Error(j.error||"update_student 실패");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }
  async function deleteStudentS(id){
    const j=await jpost(SYNC_URL,{action:"delete_student", id});
    if(!j.ok) throw new Error(j.error||"delete_student 실패");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }

  // chips
  function chipContainer(el,ops,single=false){
    el.innerHTML=ops.map(v=>`<div class="chip" data-v="${v}">${v}</div>`).join("");
    el.onclick=e=>{ const c=e.target.closest(".chip"); if(!c) return; if(single){ el.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected")); c.classList.add("selected"); } else c.classList.toggle("selected"); };
  }
  function getChips(el){ return Array.from(el.querySelectorAll(".chip.selected")).map(x=>x.dataset.v); }

  function buildClassButtons(){
    const g=$("#classGrid"); ["A","B","C","D","E","F","admin"].forEach(k=>{
      const b=document.createElement("button"); b.className="btn"; b.textContent=(k==="admin"?"🔑 관리자":"학급 "+k);
      b.onclick=()=>{ currentUser=k; $("#pwArea").classList.remove("hide"); setText("#linkStatus", SYNC_URL? "설정됨":"미설정"); setTimeout(()=>$("#pw").focus(),30); };
      g.appendChild(b);
    });
  }

  function buildStudents(container,prefix){
    const cards=$(container);
    const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    cards.innerHTML = list.map(s=>`
      <div class="stu" data-id="${s.id}">
        <img class="avatar" src="${s.photo||""}">
        <div style="font-weight:800;margin-top:6px">${s.name}</div>
        <div class="muted" style="font-size:12px">${(s.classes||[])[0]||""}</div>
      </div>`).join("") || `<div class="muted">학생 없음</div>`;
    cards.onclick = (e)=>{ const card=e.target.closest(".stu"); if(!card) return; cards.querySelectorAll(".stu").forEach(x=>x.classList.remove("selected")); card.classList.add("selected"); const sid=card.dataset.id; const nm=(students.find(x=>x.id==sid)||{}).name||""; (prefix==="am"?$("#amForm"):$("#pmForm")).classList.remove("hide"); (prefix==="am"?$("#amWho"):$("#pmWho")).textContent = `${nm} 학생의 감정`; cards.dataset.sel=sid; };
  }

  function buildEmo(prefix){
    const box= prefix==="am" ? $("#amEmotions") : $("#pmEmotions");
    box.innerHTML = [5,4,3,2,1].map(sc=>`
      <div class="emoBtn" data-score="${sc}">
        <div class="emoEmoji">${EMO[sc].emoji}</div>
        <div>
          <div class="emoTitle">${sc}점 · ${EMO[sc].name}</div>
          <div class="emoScale">${EMO[sc].scale}</div>
        </div>
      </div>`).join("");
    box.onclick = (e)=>{ const b=e.target.closest(".emoBtn"); if(!b) return; box.querySelectorAll(".emoBtn").forEach(x=>x.classList.remove("active")); b.classList.add("active"); box.dataset.score=b.dataset.score; (prefix==="am"?$("#amCtxWrap"):$("#pmCtxWrap")).classList.remove("hide"); };
  }

  function buildCtx(containerSel,hintSel){
    const el=$(containerSel), hint=$(hintSel);
    el.innerHTML = CTX.map(([t])=>`<div class="chip" data-k="${t}">${t}</div>`).join("");
    el.onclick = (e)=>{
      const c=e.target.closest(".chip"); if(!c) return;
      c.classList.toggle("selected");
      const sels=Array.from(el.querySelectorAll(".chip.selected")).map(x=>x.dataset.k);
      if(sels.length){
        const html = sels.map(k=>{
          const item = CTX.find(([t])=>t===k); return `• <b>${item[0]}</b>: ${item[1]}`;
        }).join("<br>");
        hint.innerHTML = html; hint.classList.add("show");
      } else { hint.classList.remove("show"); }
    };
  }

  function buildStuList(){
    const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    $("#stuList").innerHTML = list.map(s=>`
      <div class="row" style="justify-content:space-between;border-bottom:1px solid #e5e7eb;padding:8px 0">
        <div class="row">
          <img class="avatar" src="${s.photo||""}">
          <div>
            <div><b>${s.name}</b> <span class="muted">(${(s.classes||[]).join(", ")})</span></div>
            <div class="muted" style="font-size:12px">${(s.dx||[]).join("/")} · ${(s.comm||[]).join("/")} · ${(s.sensory||[]).join("/")}</div>
          </div>
        </div>
        <div class="row">
          <button class="btn" data-edit="${s.id}">수정</button>
          <button class="btn danger" data-del="${s.id}">삭제</button>
        </div>
      </div>`).join("") || `<div class="muted">학생 없음</div>`;
    $("#stuList").onclick = async (e)=>{
      const ed=e.target.closest("button[data-edit]"); const del=e.target.closest("button[data-del]");
      if(ed){ openEdit(ed.dataset.edit); }
      if(del){ if(!confirm("삭제할까요?")) return; const id=Number(del.dataset.del); try{ await deleteStudentS(id); await serverExport(); done("삭제되었습니다."); }catch(err){ done("서버 삭제 실패: "+err.message); } }
    };
  }

  function imgToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(file); }); }

  async function addStu(){
    if(busy) return;
    const name=$("#newName").value.trim();
    if(!name){ done("이름을 입력하세요."); return; }
    let photo=null; const f=$("#photo").files[0]; if(f) photo=await imgToDataURL(f);
    let classes=getChips($("#chipsClass")); if(classes.length===0 && currentUser && currentUser!=="admin"){ classes=[currentUser]; } // 현재 반 기본값
    const s={id:Date.now(),name,photo,classes,sex:getChips($("#chipsSex"))[0]||"",dx:getChips($("#chipsDx")),comm:getChips($("#chipsComm")),sensory:getChips($("#chipsSensory")),reinf:getChips($("#chipsReinf")),trigger:getChips($("#chipsTrigger")),meds:getChips($("#chipsMeds")),parent:$("#newParent").value.trim()};

    busy=true; const btn=$("#addStu"); btn.disabled=true;
    try{
      await addStudentS(s);
      await serverExport(); // 즉시 반영
      done("학생 등록이 완료되었습니다.");
    }catch(e){
      done("서버 저장 실패: "+e.message);
    }finally{
      busy=false; btn.disabled=false;
    }

    ["chipsClass","chipsSex","chipsDx","chipsComm","chipsSensory","chipsReinf","chipsTrigger","chipsMeds"].forEach(id=>$("#"+id).querySelectorAll(".chip").forEach(c=>c.classList.remove("selected")));
    $("#newName").value=""; $("#newParent").value=""; $("#photo").value=""; $("#preview").src="";
  }

  let amDate=new Date(), pmDate=new Date();
  function setDates(){ setText("#amDate",dateK(amDate)); setText("#pmDate",dateK(pmDate)); $("#amDatePicker").value=fmt(amDate); $("#pmDatePicker").value=fmt(pmDate); }

  async function saveEmotion(prefix,btn){
    if(busy) return;
    const scroller = prefix==="am" ? $("#amScroller") : $("#pmScroller"); const sid=scroller.dataset.sel;
    const box= prefix==="am" ? $("#amEmotions") : $("#pmEmotions");
    const score = parseInt(box.dataset.score||"0",10);
    if(!sid || !score){ done("학생/감정 선택 후 저장하세요."); return; }
    const date = fmt(prefix==="am"?amDate:pmDate);
    const ctxSel = Array.from((prefix==="am"?$("#amCtx"):$("#pmCtx")).querySelectorAll(".chip.selected")).map(x=>x.dataset.k);
    const slot = (prefix==="am"?"morning":"afternoon");

    busy=true; btn.disabled=true;
    try{
      await addEmotion(date, sid, slot, clamp(score), ctxSel);
      await serverExport(); // 서버 기준 최신 반영
      done("입력이 완료되었습니다.");
    }catch(e){
      done("서버 저장 실패: "+e.message);
    }finally{
      busy=false; btn.disabled=false;
    }
    box.querySelectorAll(".emoBtn").forEach(x=>x.classList.remove("active"));
    (prefix==="am"?$("#amCtxWrap"):$("#pmCtxWrap")).classList.add("hide");
    Array.from((prefix==="am"?$("#amCtx"):$("#pmCtx")).querySelectorAll(".chip")).forEach(x=>x.classList.remove("selected"));
  }

  function buildDataManager(filterName=""){
    const body=$("#dataBody"); body.innerHTML="";
    const dates=Object.keys(emotion).sort();
    dates.forEach(k=>{
      const day=emotion[k];
      Object.keys(day).forEach(sid=>{
        const rec=day[sid];
        const nm=rec.name||"";
        if(filterName && !nm.includes(filterName)) return;
        ["morning","afternoon"].forEach(slot=>{
          const cur=rec[slot]; if(!cur) return;
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${k}</td><td>${nm}</td><td>${slot==="morning"?"등교":"하교"}</td>
            <td><input type="number" min="1" max="5" value="${cur.score}" style="width:70px"/></td>
            <td><input type="text" value="${(cur.context||[]).join(", ")}" placeholder="쉼표 구분"/></td>
            <td><button class="btn" data-act="save">수정</button></td>
            <td><button class="btn danger" data-act="del">삭제</button></td>`;
          tr.dataset.date=k; tr.dataset.sid=sid; tr.dataset.slot=slot; body.appendChild(tr);
        });
      });
    });
    body.onclick=async (e)=>{
      const btn=e.target.closest("button"); if(!btn) return;
      const tr=btn.closest("tr"); const d=tr.dataset.date, sid=tr.dataset.sid, slot=tr.dataset.slot;
      if(btn.dataset.act==="save"){
        const score=parseInt(tr.querySelector('input[type="number"]').value||"0",10);
        const ctx=tr.querySelector('input[type="text"]').value.split(",").map(s=>s.trim()).filter(Boolean);
        if(!score){ done("점수 1~5 입력"); return; }
        try{ await upEmotion(d,sid,slot,clamp(score),ctx); await serverExport(); done("수정되었습니다."); }catch(err){ done("서버 수정 실패: "+err.message); }
      } else {
        if(!confirm("삭제할까요?")) return;
        try{ await delEmotion(d,sid,slot); await serverExport(); done("삭제되었습니다."); }catch(err){ done("서버 삭제 실패: "+err.message); }
      }
    };
  }

  function buildGraphStudentSelect(){
    const sel=$("#graphStudent"); const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    sel.innerHTML = `<option value="">학생 선택</option>` + list.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
  }
  function getRangeData(studentId,from,to){
    const labels=[], am=[], pm=[]; const fromD=new Date(from), toD=new Date(to); if(isNaN(fromD)||isNaN(toD)) return {labels,am,pm};
    const cur=new Date(fromD);
    while(cur<=toD){ const k=fmt(cur), r=emotion[k]?.[studentId]; labels.push(k.slice(5)); am.push(r?.morning?.score ?? null); pm.push(r?.afternoon?.score ?? null); cur.setDate(cur.getDate()+1); }
    return {labels, am, pm};
  }
  function drawGraphTitle(name){ setText("#graphTitle", name ? `${name} 학생 감정 모니터링 그래프` : ""); }
  function drawChart(canvasId, labels, am, pm){
    const c=document.getElementById(canvasId), ctx=c.getContext('2d');
    const dpr=window.devicePixelRatio||1; c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.scale(dpr,dpr);
    ctx.clearRect(0,0,c.clientWidth,c.clientHeight);
    const W=c.clientWidth,H=c.clientHeight,pad=42;
    ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.moveTo(pad,pad); ctx.lineTo(pad,H-pad); ctx.stroke();
    for(let s=1;s<=5;s++){ const y=H-pad-(H-2*pad)*(s-1)/4; ctx.fillStyle="#64748b"; ctx.font="12px sans-serif"; ctx.fillText(String(s), 10, y+4); ctx.strokeStyle="#f1f5f9"; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke(); }
    if(!labels.length) return;
    const step=(W-2*pad)/Math.max(1,labels.length-1); const yOf=v=>H-pad-(H-2*pad)*((v-1)/4);
    labels.forEach((lab,i)=>{ const x=pad+i*step; if(i%Math.ceil(labels.length/8)===0){ ctx.fillStyle="#64748b"; ctx.fillText(lab, x-12, H-pad+14); } });
    function drawSeries(points,color,shape){
      ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
      let started=false;
      points.forEach((v,i)=>{
        const x=pad+i*step;
        if(v==null){ started=false; return; }
        const y=yOf(v);
        if(!started){ ctx.moveTo(x,y); started=true; } else { ctx.lineTo(x,y); }
      });
      ctx.stroke();
      ctx.fillStyle=color;
      points.forEach((v,i)=>{
        if(v==null) return; const x=pad+i*step, y=yOf(v);
        if(shape==="circle"){ ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill(); }
        else{ ctx.beginPath(); ctx.moveTo(x, y-5); ctx.lineTo(x-5, y+4); ctx.lineTo(x+5, y+4); ctx.closePath(); ctx.fill(); }
        ctx.font="11px sans-serif"; ctx.fillText(String(v), x+6, y-6);
      });
    }
    drawSeries(am,"#ef4444","circle");
    drawSeries(pm,"#2563eb","tri");
  }
  function handleGraph(){
    const sid=$("#graphStudent").value, from=$("#fromDate").value, to=$("#toDate").value; if(!sid||!from||!to) return done("학생과 기간을 선택하세요.");
    const s = students.find(x=>x.id==sid);
    drawGraphTitle(s?.name||"");
    const g = getRangeData(sid,from,to); drawChart("chart",g.labels,g.am,g.pm); genReport(sid,from,to);
  }
  function genReport(studentId, from, to){
    const s = students.find(x=>x.id==studentId); if(!s){ $("#reportBox").innerHTML="학생 정보가 없습니다."; return; }
    const cur=new Date(from), end=new Date(to); const recs=[];
    while(cur<=end){ const k=fmt(cur); const r=emotion[k]?.[studentId]; if(r?.morning) recs.push({date:k,slot:"AM",score:r.morning.score,ctx:r.morning.context||[]}); if(r?.afternoon) recs.push({date:k,slot:"PM",score:r.afternoon.score,ctx:r.afternoon.context||[]}); cur.setDate(cur.getDate()+1); }
    const n=recs.length, avg=a=>a.length? (a.reduce((x,y)=>x+y,0)/a.length).toFixed(2):"-", amScores=recs.filter(r=>r.slot==="AM").map(r=>r.score), pmScores=recs.filter(r=>r.slot==="PM").map(r=>r.score);
    const lowDays = recs.filter(r=>r.score<=2).length, ctxCount={}; recs.forEach(r=>r.ctx.forEach(c=>ctxCount[c]=(ctxCount[c]||0)+1));
    const topCtx = Object.entries(ctxCount).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v])=>`${k}(${v})`);
    const human = (arr)=>arr?.length?arr.join(", "):"정보 없음";
    const summary = `표본 ${n}개, AM 평균 ${avg(amScores)}, PM 평균 ${avg(pmScores)}, 낮은 점수(≤2) ${lowDays}회. 주요 맥락: ${topCtx.join(", ")||"없음"}.`;
    const plan=[
      "SEL·Zones: 수업 시작 전 감정 선택 및 대처 카드 고르기 루틴화.",
      "ABA: 짧은 과제-짧은 강화(예: 5분 집중→1분 휴식) 고정 루틴.",
      "TEACCH: 시각 일정·작업 분할로 전환 예고와 예측 가능성 확보.",
      "AAC/PECS: 요청·거절·도움요청 문장/카드 일관된 모델링.",
      "감각 조절: 소음/움직임 민감 시 깊은압박·스트레칭·헤드폰 등 환경 조정.",
      "CPI 안전: 1점 신호 시 자극 낮추기·안전거리·선택 2개 중 택1 제시.",
      "가정 연계: 보호자와 동일 신호·강화 규칙 공유로 일관성 강화."
    ];
    $("#reportBox").innerHTML = `
      <div class="row" style="gap:12px;flex-wrap:nowrap"><div class="pill"><b>학생</b> ${s.name}</div><div class="pill"><b>시작</b> ${from}</div><div class="pill"><b>종료</b> ${to}</div></div>
      <div style="height:8px"></div>
      <div><b>요약</b>: ${summary}</div>
      <div style="height:6px"></div>
      <div class="muted">프로필: 학급 ${human(s.classes)} / 진단 ${human(s.dx)} / 의사소통 ${human(s.comm)} / 감각 ${human(s.sensory)}</div>
      <div style="height:10px"></div>
      <div><b>전문가 소견</b>: 점수와 맥락의 패턴을 고려할 때, 예고·시각 지원·짧은 강화 루틴의 비중을 높이면 안정도가 향상될 가능성이 큽니다. 낮은 점수일수록 감각·전환·요구 충돌 요인이 함께 나타나는 경향이 관찰됩니다.</div>
      <div style="height:8px"></div>
      <div><b>중재 계획(교사·보호자용)</b><ol>${plan.map(x=>`<li>${x}</li>`).join("")}</ol></div>
    `;
  }

  function buildAll(){
    buildStudents("#amScroller","am"); buildStudents("#pmScroller","pm");
    buildEmo("am"); buildEmo("pm"); buildCtx("#amCtx","#amHint"); buildCtx("#pmCtx","#pmHint"); buildDataManager(""); buildGraphStudentSelect();
    const past=new Date(); past.setDate(past.getDate()-14); $("#fromDate").value=fmt(past); $("#toDate").value=fmt(new Date()); setDates();
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    // URL via query
    const q=new URLSearchParams(location.search); if(q.get("gsUrl")) setSyncUrl(q.get("gsUrl"));
    setText("#linkStatus", SYNC_URL? "설정됨":"미설정");

    // Settings modal
    $("#gear").onclick=()=>openModal("#modalSettings");
    $("#saveUrl").onclick=async ()=>{
      const v=$("#syncUrlInput").value.trim(); if(!v) return;
      setSyncUrl(v);
      try{ await serverExport(); done("연동 설정 및 초기 동기화 완료"); }catch(err){ done("URL 저장 완료. 서버 확인 실패: "+err.message); }
      closeModal("#modalSettings");
    };
    $("#closeUrl").onclick=()=>closeModal("#modalSettings");
    $("#doneOk").onclick=()=>closeModal("#modalDone");

    // open sheet
    $("#openSheet").onclick=()=>{ if(SHEET_URL) window.open(SHEET_URL,"_blank"); };

    // class buttons
    buildClassButtons();

    // login
    $("#btnLogin").onclick=async ()=>{
      const val=$("#pw").value.trim();
      if(!currentUser) return done("학급을 먼저 선택하세요.");
      if(val!==PWD[currentUser]) return done("비밀번호가 올바르지 않습니다.");
      $("#login").classList.add("hide"); $("#app").classList.remove("hide");
      setText("#who", currentUser==="admin"?"관리자":currentUser+"학급");
      if(!SYNC_URL){ openModal("#modalSettings"); return; }
      try{ await serverExport(); }catch(e){ done("서버 연결 실패: "+e.message); }
      setInterval(async ()=>{
        try{ const j=await jget(SYNC_URL+"?action=version"); if(Number(j.version||0)>serverVersion){ await serverExport(); } }catch(e){ /* ignore */ }
      },5000);
    };
    $("#pw").addEventListener("keydown",e=>{ if(e.key==="Enter") $("#btnLogin").click(); });
    $("#btnLogout").onclick=()=>location.reload();

    // tabs
    $("#tabs").onclick=(e)=>{ const b=e.target.closest("button.tab"); if(!b)return; const tab=b.dataset.tab; $$(".tab").forEach(x=>x.classList.toggle("active",x.dataset.tab===tab)); ["am","pm","data","graph","list","new"].forEach(id=>$("#tab-"+id).classList.toggle("hide", id!==tab)); if(tab==="data") buildDataManager(); if(tab==="graph") buildGraphStudentSelect(); if(tab==="list") buildStuList(); };

    // date nav + date pickers
    $("#amPrev").onclick=()=>{ amDate.setDate(amDate.getDate()-1); setDates(); };
    $("#amNext").onclick=()=>{ amDate.setDate(amDate.getDate()+1); setDates(); };
    $("#pmPrev").onclick=()=>{ pmDate.setDate(pmDate.getDate()-1); setDates(); };
    $("#pmNext").onclick=()=>{ pmDate.setDate(pmDate.getDate()+1); setDates(); };
    $("#amDateBtn").onclick=()=>{ $("#amDatePicker").classList.remove("hide"); $("#amDatePicker").showPicker?.(); };
    $("#pmDateBtn").onclick=()=>{ $("#pmDatePicker").classList.remove("hide"); $("#pmDatePicker").showPicker?.(); };
    $("#amDatePicker").onchange=(e)=>{ amDate=new Date(e.target.value); setDates(); e.target.classList.add("hide"); };
    $("#pmDatePicker").onchange=(e)=>{ pmDate=new Date(e.target.value); setDates(); e.target.classList.add("hide"); };

    // chips
    chipContainer($("#chipsClass"),OPS.classes); chipContainer($("#chipsSex"),OPS.sex,true); chipContainer($("#chipsDx"),OPS.dx); chipContainer($("#chipsComm"),OPS.comm); chipContainer($("#chipsSensory"),OPS.sensory); chipContainer($("#chipsReinf"),OPS.reinf); chipContainer($("#chipsTrigger"),OPS.trigger); chipContainer($("#chipsMeds"),OPS.meds);
    $("#photo").onchange=async (e)=>{ const f=e.target.files[0]; if(!f) return; $("#preview").src=await imgToDataURL(f); };

    // actions
    $("#addStu").onclick=addStu;
    $("#amSave").onclick=()=>saveEmotion("am", $("#amSave"));
    $("#pmSave").onclick=()=>saveEmotion("pm", $("#pmSave"));

    // edit modal
    $("#editClose").onclick=()=>closeModal("#modalEdit");
    $("#editSave").onclick=async ()=>{
      const s=students.find(x=>x.id==editTargetId); if(!s) return;
      s.name=$("#editName").value.trim();
      const pf=$("#editPhoto").files[0]; if(pf) s.photo=await imgToDataURL(pf);
      const collect=(id)=>Array.from($(id).querySelectorAll(".chip.selected")).map(x=>x.dataset.v);
      s.classes=collect("#editClass"); s.sex=collect("#editSex")[0]||""; s.dx=collect("#editDx"); s.comm=collect("#editComm"); s.sensory=collect("#editSensory"); s.reinf=collect("#editReinf"); s.trigger=collect("#editTrigger"); s.meds=collect("#editMeds");
      try{ await updateStudentS(s); await serverExport(); done("학생 정보가 수정되었습니다."); closeModal("#modalEdit"); }catch(err){ done("서버 수정 실패: "+err.message); }
    };

    function openEdit(id){
      editTargetId=Number(id); const s=students.find(x=>x.id==editTargetId); if(!s) return;
      $("#editName").value=s.name||""; $("#editPreview").src=s.photo||""; $("#editPhoto").value="";
      const setContainer=(sel,ops,vals,single=false)=>{ const el=$(sel); el.innerHTML=ops.map(v=>`<div class="chip" data-v="${v}">${v}</div>`).join(""); el.querySelectorAll(".chip").forEach(c=>{ if(vals.includes(c.dataset.v)) c.classList.add("selected"); }); el.onclick=e=>{ const c=e.target.closest(".chip"); if(!c) return; if(single){ el.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected")); c.classList.add("selected"); } else c.classList.toggle("selected"); }; };
      setContainer("#editClass",OPS.classes,s.classes||[]);
      setContainer("#editSex",OPS.sex,[s.sex||""],true);
      setContainer("#editDx",OPS.dx,s.dx||[]);
      setContainer("#editComm",OPS.comm,s.comm||[]);
      setContainer("#editSensory",OPS.sensory,s.sensory||[]);
      setContainer("#editReinf",OPS.reinf,s.reinf||[]);
      setContainer("#editTrigger",OPS.trigger,s.trigger||[]);
      setContainer("#editMeds",OPS.meds,s.meds||[]);
      openModal("#modalEdit");
    }
    window.openEdit=openEdit;

    // data search
    $("#btnSearch").onclick=()=>buildDataManager($("#searchName").value.trim());
    $("#btnClear").onclick=()=>{ $("#searchName").value=""; buildDataManager(""); };
  });
})();
</script>
</body>
</html>
