<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ê°ì • ë°ì´í„° ë¶„ì„ ë„êµ¬ Â· ì‹¤ì‹œê°„ ë™ê¸°í™”</title>
<style>
  :root{
    --bg:#f7f9fc;--panel:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#4f46e5;
    --accent:#22c55e;--danger:#ef4444;--border:#e5e7eb;--chip:#f1f5f9;
    --red:#ef4444;--blue:#2563eb;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
  .wrap{max-width:1180px;margin:0 auto;padding:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;white-space:nowrap}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:12px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:700;min-height:40px}
  .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
  .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
  .btn.ghost{background:#fff}
  .tabs{display:flex;gap:10px;overflow:auto;margin-bottom:12px}
  .tab{padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;white-space:nowrap}
  .tab.active{background:var(--primary);color:#fff;border-color:transparent}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
  .scroller{display:flex;gap:12px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:6px 2px}
  .stu{flex:0 0 210px;background:#fff;border:2px solid var(--border);border-radius:16px;padding:12px;text-align:center}
  .stu.selected{border-color:var(--primary);box-shadow:0 0 0 2px rgba(79,70,229,.22) inset}
  .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#e5e7eb;border:2px solid #fff;box-shadow:0 6px 14px rgba(0,0,0,.06)}
  .emoList{display:grid;gap:10px}
  .emoBtn{display:flex;align-items:center;gap:12px;border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;cursor:pointer}
  .emoBtn.active{border-color:var(--primary);background:#eef2ff}
  .emoEmoji{font-size:28px}
  .emoTitle{font-weight:800}
  .emoScale{font-size:12px;color:#475569}
  .context{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .chip{padding:9px 12px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:13px;cursor:pointer;text-align:center;user-select:none}
  .chip.selected{background:var(--primary);color:#fff;border-color:transparent}
  .hint{grid-column:1/-1;font-size:12px;color:#475569;display:none}
  .hint.show{display:block}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:6px;text-align:center;font-size:13px}
  th{background:#f3f4f6}
  .hide{display:none!important}
  canvas{width:100%;height:420px;border:1px solid var(--border);border-radius:12px;background:#fff}
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:10px;background:radial-gradient(circle at 30% 30%, #8b5cf6, #2563eb);box-shadow:0 6px 16px rgba(37,99,235,.35)}
  .title{font-weight:900;font-size:20px}
  .muted{color:#64748b}
  .iconbtn{width:40px;height:40px;border-radius:12px;border:1px solid var(--border);background:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
  @media (max-width:640px){ .stu{flex:0 0 160px} .title{font-size:18px} }
  @media print{ .no-print{display:none!important} body{background:#fff} .card{border:0;box-shadow:none} @page{size:A4;margin:12mm} }
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal.show{display:flex}
  .modal .box{background:#fff;border-radius:16px;max-width:440px;width:100%;padding:18px;border:1px solid var(--border);box-shadow:0 24px 48px rgba(0,0,0,.25)}
  .modal .box h3{margin:0 0 8px 0}
  .right-bottom{position:sticky;bottom:0;display:flex;justify-content:flex-end}
</style>
</head>
<body>
<div class="wrap">

  <!-- ìƒë‹¨ë°” -->
  <div class="topbar card no-print">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title">ê°ì • ë°ì´í„° ë¶„ì„ ë„êµ¬</div>
        <div class="muted" style="font-size:12px">êµìœ¡ í˜„ì¥ ìµœì í™” Â· ì‹¤ì‹œê°„ ë™ê¸°í™”</div>
      </div>
    </div>
    <div class="row">
      <button id="openSheet" class="iconbtn" title="êµ¬ê¸€ ì‹œíŠ¸ ì—´ê¸°" disabled>ğŸ“„</button>
      <button id="gear" class="iconbtn" title="ì—°ë™ ì„¤ì •">âš™ï¸</button>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸ -->
  <section id="login" class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>ğŸ” ë°˜ ì„ íƒ ë¡œê·¸ì¸</h2>
      <div class="muted">A~F: a123~f123 Â· ê´€ë¦¬ì: admin123</div>
    </div>
    <div class="row" id="classGrid"></div>
    <div id="pwArea" class="hide">
      <div class="row">
        <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì˜ˆ: a123)" />
        <button id="btnLogin" class="btn primary">ë¡œê·¸ì¸</button>
      </div>
      <div class="muted" style="margin-top:6px">
        ì—°ê²°: <span id="linkStatus" class="pill">ë¯¸ì„¤ì •</span> Â· ì„œë²„ ë²„ì „ <span id="sv">0</span>
      </div>
    </div>
  </section>

  <!-- ë³¸ì²´ -->
  <section id="app" class="card hide">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>ğŸ“˜ ìˆ˜ì—… ë°ì´í„° ì…ë ¥</h2>
      <div class="row no-print">
        <div id="who" class="pill">-</div>
        <button id="btnLogout" class="btn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="tabs no-print" id="tabs">
      <button class="tab active" data-tab="am">ğŸ« ë“±êµì…ë ¥</button>
      <button class="tab" data-tab="pm">ğŸ¡ í•˜êµì…ë ¥</button>
      <button class="tab" data-tab="data">ğŸ“‹ ë°ì´í„° ê´€ë¦¬</button>
      <button class="tab" data-tab="graph">ğŸ“ˆ ê·¸ë˜í”„Â·ë³´ê³ ì„œ</button>
      <button class="tab" data-tab="list">ğŸ‘¥ í•™ìƒëª©ë¡</button>
      <button class="tab" data-tab="new">â• í•™ìƒë“±ë¡</button>
    </div>

    <!-- AM -->
    <div id="tab-am">
      <div class="row" style="justify-content:center;gap:8px">
        <button class="btn" id="amPrev">â—€</button>
        <button class="pill" id="amDateBtn" title="ëˆŒëŸ¬ì„œ ë‚ ì§œ ì„ íƒ"><span id="amDate"></span> ğŸ“…</button>
        <input id="amDatePicker" class="hide" type="date"/>
        <button class="btn" id="amNext">â–¶</button>
      </div>
      <h3>í•™ìƒ ì„ íƒ</h3><div id="amScroller" class="scroller"></div>
      <div id="amForm" class="hide">
        <h3 id="amWho" style="text-align:center"></h3>
        <div class="emoList" id="amEmotions"></div>
        <div id="amCtxWrap" class="hide">
          <div style="height:8px"></div>
          <div class="muted" style="text-align:center">ê°„í¸ ë§¥ë½ (ë³µìˆ˜ ì„ íƒ)</div>
          <div id="amCtx" class="context"></div>
          <div id="amHint" class="hint">ì˜ˆì‹œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <div class="row"><button class="btn primary" id="amSave">ì €ì¥</button></div>
      </div>
    </div>

    <!-- PM -->
    <div id="tab-pm" class="hide">
      <div class="row" style="justify-content:center;gap:8px">
        <button class="btn" id="pmPrev">â—€</button>
        <button class="pill" id="pmDateBtn" title="ëˆŒëŸ¬ì„œ ë‚ ì§œ ì„ íƒ"><span id="pmDate"></span> ğŸ“…</button>
        <input id="pmDatePicker" class="hide" type="date"/>
        <button class="btn" id="pmNext">â–¶</button>
      </div>
      <h3>í•™ìƒ ì„ íƒ</h3><div id="pmScroller" class="scroller"></div>
      <div id="pmForm" class="hide">
        <h3 id="pmWho" style="text-align:center"></h3>
        <div class="emoList" id="pmEmotions"></div>
        <div id="pmCtxWrap" class="hide">
          <div style="height:8px"></div>
          <div class="muted" style="text-align:center">ê°„í¸ ë§¥ë½ (ë³µìˆ˜ ì„ íƒ)</div>
          <div id="pmCtx" class="context"></div>
          <div id="pmHint" class="hint">ì˜ˆì‹œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <div class="row"><button class="btn primary" id="pmSave">ì €ì¥</button></div>
      </div>
    </div>

    <!-- Data -->
    <div id="tab-data" class="hide">
      <div class="row">
        <input id="searchName" placeholder="í•™ìƒëª… ê²€ìƒ‰(ë°ì´í„° í•„í„°)"/>
        <button id="btnSearch" class="btn">ê²€ìƒ‰</button>
        <button id="btnClear" class="btn ghost">ì´ˆê¸°í™”</button>
      </div>
      <table>
        <thead><tr><th>ë‚ ì§œ</th><th>í•™ìƒ</th><th>êµ¬ë¶„</th><th>ì ìˆ˜</th><th>ë§¥ë½</th><th>ìˆ˜ì •</th><th>ì‚­ì œ</th></tr></thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>

    <!-- Graph & Report -->
    <div id="tab-graph" class="hide">
      <div class="row">
        <select id="graphStudent"></select>
        <input type="date" id="fromDate"><input type="date" id="toDate">
        <button class="btn" id="btnGraph">ê·¸ë˜í”„/ë³´ê³ ì„œ</button>
        <button class="btn" id="btnPrint">ğŸ–¨ï¸ ì¸ì‡„ / PDF</button>
      </div>
      <div style="height:8px"></div>
      <h3 id="graphTitle" style="text-align:center"></h3>
      <canvas id="chart"></canvas>
      <div class="muted" style="font-size:12px;margin-top:6px;text-align:center">
        <b>ë²”ë¡€:</b> <span style="color:var(--red)">â— AM(ë“±êµ)</span> â€” <span style="color:var(--red)">â”</span> Â·
        <span style="color:var(--blue)">â–² PM(í•˜êµ)</span> â€” <span style="color:var(--blue)">â”</span> Â· ì  ìœ„ ìˆ«ì=ì ìˆ˜
      </div>
      <div style="height:14px"></div>
      <div id="reportBox" class="card" style="border-radius:16px"></div>
    </div>

    <!-- List -->
    <div id="tab-list" class="hide"><h3>í•™ìƒ ëª©ë¡</h3><div id="stuList"></div></div>

    <!-- New -->
    <div id="tab-new" class="hide">
      <h3>í•™ìƒ ë“±ë¡</h3>
      <div class="row">
        <input id="newName" type="text" placeholder="í•™ìƒ ì´ë¦„">
        <input id="photo" type="file" accept="image/*" class="no-print">
        <img id="preview" class="avatar" alt="ë¯¸ë¦¬ë³´ê¸°" />
      </div>
      <div style="height:8px"></div>
      <label>í•™ê¸‰</label><div id="chipsClass" class="context"></div>
      <label>ì„±ë³„</label><div id="chipsSex" class="context"></div>
      <label>ì§„ë‹¨</label><div id="chipsDx" class="context"></div>
      <label>ì˜ì‚¬ì†Œí†µ</label><div id="chipsComm" class="context"></div>
      <label>ê°ê° í”„ë¡œí•„</label><div id="chipsSensory" class="context"></div>
      <label>ì„ í˜¸ ê°•í™”ì œ</label><div id="chipsReinf" class="context"></div>
      <label>ì£¼ìš” ìœ ë°œìƒí™©</label><div id="chipsTrigger" class="context"></div>
      <label>ì˜ë£Œ/ì•½ë¬¼</label><div id="chipsMeds" class="context"></div>
      <div class="row"><input id="newParent" type="tel" placeholder="ë³´í˜¸ì ì—°ë½ì²˜"/></div>
      <div class="right-bottom"><button class="btn primary" id="addStu">ë“±ë¡</button></div>
    </div>
  </section>
</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="modalSettings" class="modal">
  <div class="box">
    <h3>ì—°ë™ ì„¤ì •</h3>
    <p class="muted">ê´€ë¦¬ìê°€ í•œ ë²ˆë§Œ ì„¤ì •í•˜ë©´, ì´í›„ ì ‘ì†ìëŠ” ê°™ì€ ë§í¬ë¡œ ì—°ë™ë©ë‹ˆë‹¤.<br>ì›¹ì•± URLì„ ë¶™ì—¬ë„£ê³  ì €ì¥í•˜ì„¸ìš”.</p>
    <input id="syncUrlInput" placeholder="ì›¹ì•± URL (https://script.google.com/macros/s/...)"/>
    <div id="shareLink" class="muted" style="font-size:12px;margin-top:6px"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="saveUrl" class="btn primary">ì €ì¥</button>
      <button id="closeUrl" class="btn">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ì™„ë£Œ ëª¨ë‹¬ -->
<div id="modalDone" class="modal">
  <div class="box">
    <h3>âœ… ì™„ë£Œ</h3>
    <div id="doneMsg" class="muted">ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="doneOk" class="btn primary">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- í•™ìƒ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="modalEdit" class="modal">
  <div class="box">
    <h3>í•™ìƒ ì •ë³´ ìˆ˜ì •</h3>
    <div class="row"><input id="editName" placeholder="ì´ë¦„"><input id="editPhoto" type="file" accept="image/*"><img id="editPreview" class="avatar"/></div>
    <div style="height:8px"></div>
    <label>í•™ê¸‰</label><div id="editClass" class="context"></div>
    <label>ì„±ë³„</label><div id="editSex" class="context"></div>
    <label>ì§„ë‹¨</label><div id="editDx" class="context"></div>
    <label>ì˜ì‚¬ì†Œí†µ</label><div id="editComm" class="context"></div>
    <label>ê°ê° í”„ë¡œí•„</label><div id="editSensory" class="context"></div>
    <label>ì„ í˜¸ ê°•í™”ì œ</label><div id="editReinf" class="context"></div>
    <label>ì£¼ìš” ìœ ë°œìƒí™©</label><div id="editTrigger" class="context"></div>
    <label>ì˜ë£Œ/ì•½ë¬¼</label><div id="editMeds" class="context"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="editSave" class="btn primary">ì €ì¥</button>
      <button id="editClose" class="btn">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  const KEY_URL="sync_url_full";
  const PWD={A:"a123",B:"b123",C:"c123",D:"d123",E:"e123",F:"f123",admin:"admin123"};
  let SYNC_URL=localStorage.getItem(KEY_URL)||"";
  let SHEET_URL=""; // ì„œë²„ì—ì„œ ì œê³µ
  let serverVersion=0;
  let currentUser=null, students=[], emotion={};
  let editTargetId=null, busy=false;

  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const fmt=d=>new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split("T")[0];
  const clamp=n=>Math.max(1,Math.min(5,n|0));
  const dateK=d=>d.toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric",weekday:"long"});
  function setText(sel,txt){ const el=$(sel); if(el) el.textContent=txt; }
  function openModal(id){ $(id).classList.add("show"); } function closeModal(id){ $(id).classList.remove("show"); }
  function done(msg){ $("#doneMsg").innerHTML=msg||"ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."; openModal("#modalDone"); }

  const EMO={
    5:{emoji:"ğŸ˜„",name:"ë§¤ìš° ì¢‹ìŒ",scale:"ì›ƒìŒÂ·ìë°œì  ì°¸ì—¬ â‰¥90%, ë¬¸ì œí–‰ë™ 0íšŒ"},
    4:{emoji:"ğŸ™‚",name:"ì¢‹ìŒ",scale:"ì•ˆì •Â·ì§€ì‹œ ë”°ë¦„ 75â€“90%, ë¬¸ì œí–‰ë™ 0â€“1íšŒ(ì§§ìŒ)"},
    3:{emoji:"ğŸ˜",name:"ë³´í†µ",scale:"ì¤‘ë¦½Â·ì°¸ì—¬ ë“¤ì‘¥ë‚ ì‘¥, ì§€ì‹œ ë”°ë¦„ 50â€“75%"},
    2:{emoji:"ğŸ˜•",name:"ë¶ˆí¸",scale:"ì°¡ê·¸ë¦¼Â·í•œìˆ¨, ì§€ì‹œ ë”°ë¦„ 25â€“50%, ì§€ì› í•„ìš”"},
    1:{emoji:"ğŸ˜£",name:"ë§¤ìš° ì–´ë ¤ì›€",scale:"ìš¸ìŒ/ë„ë§, ì§€ì‹œ ë”°ë¦„ <25%, ì¦‰ê° ì¤‘ì¬"}
  };

  // ê°„í¸ ë§¥ë½ 15ê°œ: 3x5 ë°°ì—´
  const CTX=[
    ["ğŸ˜´ ìˆ˜ë©´ë¶€ì¡±","ì „ë‚  6ì‹œê°„ ì´í•˜ ìˆ˜ë©´, ì•„ì¹¨ ë©í•¨"],
    ["ğŸ’Š ê±´ê°•ì €í•˜","ê°ê¸°Â·ë³µí†µ ë“± ì»¨ë””ì…˜ ì €í•˜"],
    ["ğŸ  ê°€ì •ì´ìŠˆ","í˜•ì œê°ˆë“±/ë¶€ëª¨ì™€ ë‹¤íˆ¼ ë³´ê³ "],
    ["ğŸ”„ í™œë™ì „í™˜","ì¦ê±°ìš´ í™œë™ â†’ ê³¼ì œ ì „í™˜ ì–´ë ¤ì›€"],
    ["ğŸ§’ ë˜ë˜ê°ˆë“±","ë˜ë˜ì™€ ì¥ë‚œ/ê°ˆë“± í›„"],
    ["ğŸ‘€ ê´€ì‹¬ìš”êµ¬","êµì‚¬/ì¹œêµ¬ ì£¼ëª© ëŒê¸°"],
    ["ğŸ ê°•í™”ì œìš”êµ¬","ê°„ì‹/ê¸°ê¸° ë“± ë³´ìƒ ìš”êµ¬"],
    ["ğŸšª ê³¼ì œíšŒí”¼","ê³¼ì œ/ìš”êµ¬ íšŒí”¼ ì‹œë„"],
    ["ğŸŒ€ ê°ê°ì¶”êµ¬","íšŒì „/ë”±ë”± ì†Œë¦¬ ì¶”êµ¬"],
    ["ğŸ”Š ì†ŒìŒë¯¼ê°","ì†ŒìŒ í™˜ê²½ì—ì„œ ë¶ˆí¸"],
    ["ğŸ½ï¸ ë°°ê³ í””","ê°„ì‹/ì‹ì‚¬ ì „ ê°•í•œ í—ˆê¸°"],
    ["ğŸ¤• í†µì¦/ë¶ˆí¸","ì¹˜ì•„/ë³µë¶€ ë“± í†µì¦ í˜¸ì†Œ"],
    ["ğŸ“… ì¼ì •ë³€ê²½","ì˜ˆì •ê³¼ ë‹¤ë¥¸ ì¼ì • ë°œìƒ"],
    ["ğŸšŒ ë“±í•˜êµí”¼ë¡œ","ì´ë™ í”¼ë¡œë¡œ ë¬´ê¸°ë ¥"],
    ["ğŸŒ¤ï¸ ë‚ ì”¨ì˜í–¥","ë”ìœ„/ì¶”ìœ„/ë¹„ ë“± ì˜í–¥"]
  ];

  const OPS={classes:["A","B","C","D","E","F"],sex:["ë‚¨","ì—¬"],
    dx:["ì§€ì ì¥ì• ","ìíìŠ¤í™íŠ¸ëŸ¼","ADHD","í•™ìŠµì¥ì• ","ì •ì„œÂ·í–‰ë™ì¥ì• ","ê¸°íƒ€"],
    comm:["êµ¬ì–´","PECS","AAC","ì œìŠ¤ì²˜","ì œí•œì  ì–¸ì–´","ê¸°íƒ€"],
    sensory:["ì²­ê° ê³¼ë¯¼","ì‹œê° ê³¼ë¯¼","ì´‰ê° ê³¼ë¯¼","ì••ë°• ì„ í˜¸","ì›€ì§ì„ ì¶”êµ¬","ê¸°íƒ€"],
    reinf:["ìŠ¤í‹°ì»¤","ìŒì‹(ìŠ¤ë‚µ/ìŒë£Œ)","í™œë™(íœ´ì‹Â·ì‚°ì±…)","ì „ìê¸°ê¸°","ì‚¬íšŒì  ì¹­ì°¬","ê¸°íƒ€"],
    trigger:["ê³¼ì œ ì „í™˜","ì†ŒìŒ","ì¼ì • ë³€ê²½","ë˜ë˜ ê°ˆë“±","ìš”êµ¬ ê±°ë¶€","ê¸°íƒ€"],
    meds:["ì—†ìŒ","í•­ì •ì‹ ë³‘ì œ","í•­ë¶ˆì•ˆì œ","í•­ê²½ë ¨ì œ","ê¸°íƒ€"]
  };

  // Networking (text/plain to avoid preflight)
  async function jget(url){ const r=await fetch(url); if(!r.ok) throw new Error(String(r.status)); return r.json(); }
  async function jpost(url,body){ const r=await fetch(url,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(body)}); if(!r.ok) throw new Error(String(r.status)); return r.json(); }

  function setSyncUrl(url){
    SYNC_URL=url.trim();
    localStorage.setItem(KEY_URL,SYNC_URL);
    setText("#linkStatus", SYNC_URL? "ì„¤ì •ë¨":"ë¯¸ì„¤ì •");
    try{
      const u=new URL(location.href); u.searchParams.set("gsUrl", SYNC_URL); history.replaceState({}, "", u.toString());
      $("#shareLink").innerHTML = `ê³µìœ  ë§í¬: <code style="word-break:break-all">${u.toString()}</code>`;
    }catch{}
  }

  async function serverExport(){
    if(!SYNC_URL) throw new Error("URL ë¯¸ì„¤ì •");
    const j=await jget(SYNC_URL+"?action=export");
    students=j.students||[]; emotion=j.emotion||{}; serverVersion=Number(j.version||0); SHEET_URL=j.sheetUrl||"";
    setText("#sv", String(serverVersion));
    const btn=$("#openSheet"); btn.disabled = !SHEET_URL; btn.onclick = ()=>{ if(SHEET_URL) window.open(SHEET_URL,"_blank"); };
    buildAll();
  }

  async function addEmotion(date, sid, slot, score, context){
    const j=await jpost(SYNC_URL,{action:"add_emotion", date, student_id:sid, slot, score, context});
    if(!j.ok) throw new Error(j.error||"add_emotion ì‹¤íŒ¨");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }
  async function upEmotion(date, sid, slot, score, context){
    const j=await jpost(SYNC_URL,{action:"update_emotion", date, student_id:sid, slot, score, context});
    if(!j.ok) throw new Error(j.error||"update_emotion ì‹¤íŒ¨");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }
  async function delEmotion(date, sid, slot){
    const j=await jpost(SYNC_URL,{action:"delete_emotion", date, student_id:sid, slot});
    if(!j.ok) throw new Error(j.error||"delete_emotion ì‹¤íŒ¨");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }
  async function addStudentS(s){
    const j=await jpost(SYNC_URL,{action:"add_student", student:s});
    if(!j.ok) throw new Error(j.error||"add_student ì‹¤íŒ¨");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }
  async function updateStudentS(s){
    const j=await jpost(SYNC_URL,{action:"update_student", student:s});
    if(!j.ok) throw new Error(j.error||"update_student ì‹¤íŒ¨");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }
  async function deleteStudentS(id){
    const j=await jpost(SYNC_URL,{action:"delete_student", id});
    if(!j.ok) throw new Error(j.error||"delete_student ì‹¤íŒ¨");
    serverVersion=Number(j.version||serverVersion+1); setText("#sv", String(serverVersion));
  }

  // chips
  function chipContainer(el,ops,single=false){
    el.innerHTML=ops.map(v=>`<div class="chip" data-v="${v}">${v}</div>`).join("");
    el.onclick=e=>{ const c=e.target.closest(".chip"); if(!c) return; if(single){ el.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected")); c.classList.add("selected"); } else c.classList.toggle("selected"); };
  }
  function getChips(el){ return Array.from(el.querySelectorAll(".chip.selected")).map(x=>x.dataset.v); }

  function buildClassButtons(){
    const g=$("#classGrid"); ["A","B","C","D","E","F","admin"].forEach(k=>{
      const b=document.createElement("button"); b.className="btn"; b.textContent=(k==="admin"?"ğŸ”‘ ê´€ë¦¬ì":"í•™ê¸‰ "+k);
      b.onclick=()=>{ currentUser=k; $("#pwArea").classList.remove("hide"); setText("#linkStatus", SYNC_URL? "ì„¤ì •ë¨":"ë¯¸ì„¤ì •"); setTimeout(()=>$("#pw").focus(),30); };
      g.appendChild(b);
    });
  }

  function buildStudents(container,prefix){
    const cards=$(container);
    const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    cards.innerHTML = list.map(s=>`
      <div class="stu" data-id="${s.id}">
        <img class="avatar" src="${s.photo||""}">
        <div style="font-weight:800;margin-top:6px">${s.name}</div>
        <div class="muted" style="font-size:12px">${(s.classes||[])[0]||""}</div>
      </div>`).join("") || `<div class="muted">í•™ìƒ ì—†ìŒ</div>`;
    cards.onclick = (e)=>{ const card=e.target.closest(".stu"); if(!card) return; cards.querySelectorAll(".stu").forEach(x=>x.classList.remove("selected")); card.classList.add("selected"); const sid=card.dataset.id; const nm=(students.find(x=>x.id==sid)||{}).name||""; (prefix==="am"?$("#amForm"):$("#pmForm")).classList.remove("hide"); (prefix==="am"?$("#amWho"):$("#pmWho")).textContent = `${nm} í•™ìƒì˜ ê°ì •`; cards.dataset.sel=sid; };
  }

  function buildEmo(prefix){
    const box= prefix==="am" ? $("#amEmotions") : $("#pmEmotions");
    box.innerHTML = [5,4,3,2,1].map(sc=>`
      <div class="emoBtn" data-score="${sc}">
        <div class="emoEmoji">${EMO[sc].emoji}</div>
        <div>
          <div class="emoTitle">${sc}ì  Â· ${EMO[sc].name}</div>
          <div class="emoScale">${EMO[sc].scale}</div>
        </div>
      </div>`).join("");
    box.onclick = (e)=>{ const b=e.target.closest(".emoBtn"); if(!b) return; box.querySelectorAll(".emoBtn").forEach(x=>x.classList.remove("active")); b.classList.add("active"); box.dataset.score=b.dataset.score; (prefix==="am"?$("#amCtxWrap"):$("#pmCtxWrap")).classList.remove("hide"); };
  }

  function buildCtx(containerSel,hintSel){
    const el=$(containerSel), hint=$(hintSel);
    el.innerHTML = CTX.map(([t])=>`<div class="chip" data-k="${t}">${t}</div>`).join("");
    el.onclick = (e)=>{
      const c=e.target.closest(".chip"); if(!c) return;
      c.classList.toggle("selected");
      const sels=Array.from(el.querySelectorAll(".chip.selected")).map(x=>x.dataset.k);
      if(sels.length){
        const html = sels.map(k=>{
          const item = CTX.find(([t])=>t===k); return `â€¢ <b>${item[0]}</b>: ${item[1]}`;
        }).join("<br>");
        hint.innerHTML = html; hint.classList.add("show");
      } else { hint.classList.remove("show"); }
    };
  }

  function buildStuList(){
    const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    $("#stuList").innerHTML = list.map(s=>`
      <div class="row" style="justify-content:space-between;border-bottom:1px solid #e5e7eb;padding:8px 0">
        <div class="row">
          <img class="avatar" src="${s.photo||""}">
          <div>
            <div><b>${s.name}</b> <span class="muted">(${(s.classes||[]).join(", ")})</span></div>
            <div class="muted" style="font-size:12px">${(s.dx||[]).join("/")} Â· ${(s.comm||[]).join("/")} Â· ${(s.sensory||[]).join("/")}</div>
          </div>
        </div>
        <div class="row">
          <button class="btn" data-edit="${s.id}">ìˆ˜ì •</button>
          <button class="btn danger" data-del="${s.id}">ì‚­ì œ</button>
        </div>
      </div>`).join("") || `<div class="muted">í•™ìƒ ì—†ìŒ</div>`;
    $("#stuList").onclick = async (e)=>{
      const ed=e.target.closest("button[data-edit]"); const del=e.target.closest("button[data-del]");
      if(ed){ openEdit(ed.dataset.edit); }
      if(del){ if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return; const id=Number(del.dataset.del); try{ await deleteStudentS(id); await serverExport(); done("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); }catch(err){ done("ì„œë²„ ì‚­ì œ ì‹¤íŒ¨: "+err.message); } }
    };
  }

  function imgToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(file); }); }

  async function addStu(){
    if(busy) return;
    const name=$("#newName").value.trim();
    if(!name){ done("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
    let photo=null; const f=$("#photo").files[0]; if(f) photo=await imgToDataURL(f);
    let classes=getChips($("#chipsClass")); if(classes.length===0 && currentUser && currentUser!=="admin"){ classes=[currentUser]; } // í˜„ì¬ ë°˜ ê¸°ë³¸ê°’
    const s={id:Date.now(),name,photo,classes,sex:getChips($("#chipsSex"))[0]||"",dx:getChips($("#chipsDx")),comm:getChips($("#chipsComm")),sensory:getChips($("#chipsSensory")),reinf:getChips($("#chipsReinf")),trigger:getChips($("#chipsTrigger")),meds:getChips($("#chipsMeds")),parent:$("#newParent").value.trim()};

    busy=true; const btn=$("#addStu"); btn.disabled=true;
    try{
      await addStudentS(s);
      await serverExport(); // ì¦‰ì‹œ ë°˜ì˜
      done("í•™ìƒ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch(e){
      done("ì„œë²„ ì €ì¥ ì‹¤íŒ¨: "+e.message);
    }finally{
      busy=false; btn.disabled=false;
    }

    ["chipsClass","chipsSex","chipsDx","chipsComm","chipsSensory","chipsReinf","chipsTrigger","chipsMeds"].forEach(id=>$("#"+id).querySelectorAll(".chip").forEach(c=>c.classList.remove("selected")));
    $("#newName").value=""; $("#newParent").value=""; $("#photo").value=""; $("#preview").src="";
  }

  let amDate=new Date(), pmDate=new Date();
  function setDates(){ setText("#amDate",dateK(amDate)); setText("#pmDate",dateK(pmDate)); $("#amDatePicker").value=fmt(amDate); $("#pmDatePicker").value=fmt(pmDate); }

  async function saveEmotion(prefix,btn){
    if(busy) return;
    const scroller = prefix==="am" ? $("#amScroller") : $("#pmScroller"); const sid=scroller.dataset.sel;
    const box= prefix==="am" ? $("#amEmotions") : $("#pmEmotions");
    const score = parseInt(box.dataset.score||"0",10);
    if(!sid || !score){ done("í•™ìƒ/ê°ì • ì„ íƒ í›„ ì €ì¥í•˜ì„¸ìš”."); return; }
    const date = fmt(prefix==="am"?amDate:pmDate);
    const ctxSel = Array.from((prefix==="am"?$("#amCtx"):$("#pmCtx")).querySelectorAll(".chip.selected")).map(x=>x.dataset.k);
    const slot = (prefix==="am"?"morning":"afternoon");

    busy=true; btn.disabled=true;
    try{
      await addEmotion(date, sid, slot, clamp(score), ctxSel);
      await serverExport(); // ì„œë²„ ê¸°ì¤€ ìµœì‹  ë°˜ì˜
      done("ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch(e){
      done("ì„œë²„ ì €ì¥ ì‹¤íŒ¨: "+e.message);
    }finally{
      busy=false; btn.disabled=false;
    }
    box.querySelectorAll(".emoBtn").forEach(x=>x.classList.remove("active"));
    (prefix==="am"?$("#amCtxWrap"):$("#pmCtxWrap")).classList.add("hide");
    Array.from((prefix==="am"?$("#amCtx"):$("#pmCtx")).querySelectorAll(".chip")).forEach(x=>x.classList.remove("selected"));
  }

  function buildDataManager(filterName=""){
    const body=$("#dataBody"); body.innerHTML="";
    const dates=Object.keys(emotion).sort();
    dates.forEach(k=>{
      const day=emotion[k];
      Object.keys(day).forEach(sid=>{
        const rec=day[sid];
        const nm=rec.name||"";
        if(filterName && !nm.includes(filterName)) return;
        ["morning","afternoon"].forEach(slot=>{
          const cur=rec[slot]; if(!cur) return;
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${k}</td><td>${nm}</td><td>${slot==="morning"?"ë“±êµ":"í•˜êµ"}</td>
            <td><input type="number" min="1" max="5" value="${cur.score}" style="width:70px"/></td>
            <td><input type="text" value="${(cur.context||[]).join(", ")}" placeholder="ì‰¼í‘œ êµ¬ë¶„"/></td>
            <td><button class="btn" data-act="save">ìˆ˜ì •</button></td>
            <td><button class="btn danger" data-act="del">ì‚­ì œ</button></td>`;
          tr.dataset.date=k; tr.dataset.sid=sid; tr.dataset.slot=slot; body.appendChild(tr);
        });
      });
    });
    body.onclick=async (e)=>{
      const btn=e.target.closest("button"); if(!btn) return;
      const tr=btn.closest("tr"); const d=tr.dataset.date, sid=tr.dataset.sid, slot=tr.dataset.slot;
      if(btn.dataset.act==="save"){
        const score=parseInt(tr.querySelector('input[type="number"]').value||"0",10);
        const ctx=tr.querySelector('input[type="text"]').value.split(",").map(s=>s.trim()).filter(Boolean);
        if(!score){ done("ì ìˆ˜ 1~5 ì…ë ¥"); return; }
        try{ await upEmotion(d,sid,slot,clamp(score),ctx); await serverExport(); done("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); }catch(err){ done("ì„œë²„ ìˆ˜ì • ì‹¤íŒ¨: "+err.message); }
      } else {
        if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
        try{ await delEmotion(d,sid,slot); await serverExport(); done("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); }catch(err){ done("ì„œë²„ ì‚­ì œ ì‹¤íŒ¨: "+err.message); }
      }
    };
  }

  function buildGraphStudentSelect(){
    const sel=$("#graphStudent"); const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    sel.innerHTML = `<option value="">í•™ìƒ ì„ íƒ</option>` + list.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
  }
  function getRangeData(studentId,from,to){
    const labels=[], am=[], pm=[]; const fromD=new Date(from), toD=new Date(to); if(isNaN(fromD)||isNaN(toD)) return {labels,am,pm};
    const cur=new Date(fromD);
    while(cur<=toD){ const k=fmt(cur), r=emotion[k]?.[studentId]; labels.push(k.slice(5)); am.push(r?.morning?.score ?? null); pm.push(r?.afternoon?.score ?? null); cur.setDate(cur.getDate()+1); }
    return {labels, am, pm};
  }
  function drawGraphTitle(name){ setText("#graphTitle", name ? `${name} í•™ìƒ ê°ì • ëª¨ë‹ˆí„°ë§ ê·¸ë˜í”„` : ""); }
  function drawChart(canvasId, labels, am, pm){
    const c=document.getElementById(canvasId), ctx=c.getContext('2d');
    const dpr=window.devicePixelRatio||1; c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.scale(dpr,dpr);
    ctx.clearRect(0,0,c.clientWidth,c.clientHeight);
    const W=c.clientWidth,H=c.clientHeight,pad=42;
    ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.moveTo(pad,pad); ctx.lineTo(pad,H-pad); ctx.stroke();
    for(let s=1;s<=5;s++){ const y=H-pad-(H-2*pad)*(s-1)/4; ctx.fillStyle="#64748b"; ctx.font="12px sans-serif"; ctx.fillText(String(s), 10, y+4); ctx.strokeStyle="#f1f5f9"; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke(); }
    if(!labels.length) return;
    const step=(W-2*pad)/Math.max(1,labels.length-1); const yOf=v=>H-pad-(H-2*pad)*((v-1)/4);
    labels.forEach((lab,i)=>{ const x=pad+i*step; if(i%Math.ceil(labels.length/8)===0){ ctx.fillStyle="#64748b"; ctx.fillText(lab, x-12, H-pad+14); } });
    function drawSeries(points,color,shape){
      ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
      let started=false;
      points.forEach((v,i)=>{
        const x=pad+i*step;
        if(v==null){ started=false; return; }
        const y=yOf(v);
        if(!started){ ctx.moveTo(x,y); started=true; } else { ctx.lineTo(x,y); }
      });
      ctx.stroke();
      ctx.fillStyle=color;
      points.forEach((v,i)=>{
        if(v==null) return; const x=pad+i*step, y=yOf(v);
        if(shape==="circle"){ ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill(); }
        else{ ctx.beginPath(); ctx.moveTo(x, y-5); ctx.lineTo(x-5, y+4); ctx.lineTo(x+5, y+4); ctx.closePath(); ctx.fill(); }
        ctx.font="11px sans-serif"; ctx.fillText(String(v), x+6, y-6);
      });
    }
    drawSeries(am,"#ef4444","circle");
    drawSeries(pm,"#2563eb","tri");
  }
  function handleGraph(){
    const sid=$("#graphStudent").value, from=$("#fromDate").value, to=$("#toDate").value; if(!sid||!from||!to) return done("í•™ìƒê³¼ ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.");
    const s = students.find(x=>x.id==sid);
    drawGraphTitle(s?.name||"");
    const g = getRangeData(sid,from,to); drawChart("chart",g.labels,g.am,g.pm); genReport(sid,from,to);
  }
  function genReport(studentId, from, to){
    const s = students.find(x=>x.id==studentId); if(!s){ $("#reportBox").innerHTML="í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
    const cur=new Date(from), end=new Date(to); const recs=[];
    while(cur<=end){ const k=fmt(cur); const r=emotion[k]?.[studentId]; if(r?.morning) recs.push({date:k,slot:"AM",score:r.morning.score,ctx:r.morning.context||[]}); if(r?.afternoon) recs.push({date:k,slot:"PM",score:r.afternoon.score,ctx:r.afternoon.context||[]}); cur.setDate(cur.getDate()+1); }
    const n=recs.length, avg=a=>a.length? (a.reduce((x,y)=>x+y,0)/a.length).toFixed(2):"-", amScores=recs.filter(r=>r.slot==="AM").map(r=>r.score), pmScores=recs.filter(r=>r.slot==="PM").map(r=>r.score);
    const lowDays = recs.filter(r=>r.score<=2).length, ctxCount={}; recs.forEach(r=>r.ctx.forEach(c=>ctxCount[c]=(ctxCount[c]||0)+1));
    const topCtx = Object.entries(ctxCount).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v])=>`${k}(${v})`);
    const human = (arr)=>arr?.length?arr.join(", "):"ì •ë³´ ì—†ìŒ";
    const summary = `í‘œë³¸ ${n}ê°œ, AM í‰ê·  ${avg(amScores)}, PM í‰ê·  ${avg(pmScores)}, ë‚®ì€ ì ìˆ˜(â‰¤2) ${lowDays}íšŒ. ì£¼ìš” ë§¥ë½: ${topCtx.join(", ")||"ì—†ìŒ"}.`;
    const plan=[
      "SELÂ·Zones: ìˆ˜ì—… ì‹œì‘ ì „ ê°ì • ì„ íƒ ë° ëŒ€ì²˜ ì¹´ë“œ ê³ ë¥´ê¸° ë£¨í‹´í™”.",
      "ABA: ì§§ì€ ê³¼ì œ-ì§§ì€ ê°•í™”(ì˜ˆ: 5ë¶„ ì§‘ì¤‘â†’1ë¶„ íœ´ì‹) ê³ ì • ë£¨í‹´.",
      "TEACCH: ì‹œê° ì¼ì •Â·ì‘ì—… ë¶„í• ë¡œ ì „í™˜ ì˜ˆê³ ì™€ ì˜ˆì¸¡ ê°€ëŠ¥ì„± í™•ë³´.",
      "AAC/PECS: ìš”ì²­Â·ê±°ì ˆÂ·ë„ì›€ìš”ì²­ ë¬¸ì¥/ì¹´ë“œ ì¼ê´€ëœ ëª¨ë¸ë§.",
      "ê°ê° ì¡°ì ˆ: ì†ŒìŒ/ì›€ì§ì„ ë¯¼ê° ì‹œ ê¹Šì€ì••ë°•Â·ìŠ¤íŠ¸ë ˆì¹­Â·í—¤ë“œí° ë“± í™˜ê²½ ì¡°ì •.",
      "CPI ì•ˆì „: 1ì  ì‹ í˜¸ ì‹œ ìê·¹ ë‚®ì¶”ê¸°Â·ì•ˆì „ê±°ë¦¬Â·ì„ íƒ 2ê°œ ì¤‘ íƒ1 ì œì‹œ.",
      "ê°€ì • ì—°ê³„: ë³´í˜¸ìì™€ ë™ì¼ ì‹ í˜¸Â·ê°•í™” ê·œì¹™ ê³µìœ ë¡œ ì¼ê´€ì„± ê°•í™”."
    ];
    $("#reportBox").innerHTML = `
      <div class="row" style="gap:12px;flex-wrap:nowrap"><div class="pill"><b>í•™ìƒ</b> ${s.name}</div><div class="pill"><b>ì‹œì‘</b> ${from}</div><div class="pill"><b>ì¢…ë£Œ</b> ${to}</div></div>
      <div style="height:8px"></div>
      <div><b>ìš”ì•½</b>: ${summary}</div>
      <div style="height:6px"></div>
      <div class="muted">í”„ë¡œí•„: í•™ê¸‰ ${human(s.classes)} / ì§„ë‹¨ ${human(s.dx)} / ì˜ì‚¬ì†Œí†µ ${human(s.comm)} / ê°ê° ${human(s.sensory)}</div>
      <div style="height:10px"></div>
      <div><b>ì „ë¬¸ê°€ ì†Œê²¬</b>: ì ìˆ˜ì™€ ë§¥ë½ì˜ íŒ¨í„´ì„ ê³ ë ¤í•  ë•Œ, ì˜ˆê³ Â·ì‹œê° ì§€ì›Â·ì§§ì€ ê°•í™” ë£¨í‹´ì˜ ë¹„ì¤‘ì„ ë†’ì´ë©´ ì•ˆì •ë„ê°€ í–¥ìƒë  ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤. ë‚®ì€ ì ìˆ˜ì¼ìˆ˜ë¡ ê°ê°Â·ì „í™˜Â·ìš”êµ¬ ì¶©ëŒ ìš”ì¸ì´ í•¨ê»˜ ë‚˜íƒ€ë‚˜ëŠ” ê²½í–¥ì´ ê´€ì°°ë©ë‹ˆë‹¤.</div>
      <div style="height:8px"></div>
      <div><b>ì¤‘ì¬ ê³„íš(êµì‚¬Â·ë³´í˜¸ììš©)</b><ol>${plan.map(x=>`<li>${x}</li>`).join("")}</ol></div>
    `;
  }

  function buildAll(){
    buildStudents("#amScroller","am"); buildStudents("#pmScroller","pm");
    buildEmo("am"); buildEmo("pm"); buildCtx("#amCtx","#amHint"); buildCtx("#pmCtx","#pmHint"); buildDataManager(""); buildGraphStudentSelect();
    const past=new Date(); past.setDate(past.getDate()-14); $("#fromDate").value=fmt(past); $("#toDate").value=fmt(new Date()); setDates();
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    // URL via query
    const q=new URLSearchParams(location.search); if(q.get("gsUrl")) setSyncUrl(q.get("gsUrl"));
    setText("#linkStatus", SYNC_URL? "ì„¤ì •ë¨":"ë¯¸ì„¤ì •");

    // Settings modal
    $("#gear").onclick=()=>openModal("#modalSettings");
    $("#saveUrl").onclick=async ()=>{
      const v=$("#syncUrlInput").value.trim(); if(!v) return;
      setSyncUrl(v);
      try{ await serverExport(); done("ì—°ë™ ì„¤ì • ë° ì´ˆê¸° ë™ê¸°í™” ì™„ë£Œ"); }catch(err){ done("URL ì €ì¥ ì™„ë£Œ. ì„œë²„ í™•ì¸ ì‹¤íŒ¨: "+err.message); }
      closeModal("#modalSettings");
    };
    $("#closeUrl").onclick=()=>closeModal("#modalSettings");
    $("#doneOk").onclick=()=>closeModal("#modalDone");

    // open sheet
    $("#openSheet").onclick=()=>{ if(SHEET_URL) window.open(SHEET_URL,"_blank"); };

    // class buttons
    buildClassButtons();

    // login
    $("#btnLogin").onclick=async ()=>{
      const val=$("#pw").value.trim();
      if(!currentUser) return done("í•™ê¸‰ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
      if(val!==PWD[currentUser]) return done("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      $("#login").classList.add("hide"); $("#app").classList.remove("hide");
      setText("#who", currentUser==="admin"?"ê´€ë¦¬ì":currentUser+"í•™ê¸‰");
      if(!SYNC_URL){ openModal("#modalSettings"); return; }
      try{ await serverExport(); }catch(e){ done("ì„œë²„ ì—°ê²° ì‹¤íŒ¨: "+e.message); }
      setInterval(async ()=>{
        try{ const j=await jget(SYNC_URL+"?action=version"); if(Number(j.version||0)>serverVersion){ await serverExport(); } }catch(e){ /* ignore */ }
      },5000);
    };
    $("#pw").addEventListener("keydown",e=>{ if(e.key==="Enter") $("#btnLogin").click(); });
    $("#btnLogout").onclick=()=>location.reload();

    // tabs
    $("#tabs").onclick=(e)=>{ const b=e.target.closest("button.tab"); if(!b)return; const tab=b.dataset.tab; $$(".tab").forEach(x=>x.classList.toggle("active",x.dataset.tab===tab)); ["am","pm","data","graph","list","new"].forEach(id=>$("#tab-"+id).classList.toggle("hide", id!==tab)); if(tab==="data") buildDataManager(); if(tab==="graph") buildGraphStudentSelect(); if(tab==="list") buildStuList(); };

    // date nav + date pickers
    $("#amPrev").onclick=()=>{ amDate.setDate(amDate.getDate()-1); setDates(); };
    $("#amNext").onclick=()=>{ amDate.setDate(amDate.getDate()+1); setDates(); };
    $("#pmPrev").onclick=()=>{ pmDate.setDate(pmDate.getDate()-1); setDates(); };
    $("#pmNext").onclick=()=>{ pmDate.setDate(pmDate.getDate()+1); setDates(); };
    $("#amDateBtn").onclick=()=>{ $("#amDatePicker").classList.remove("hide"); $("#amDatePicker").showPicker?.(); };
    $("#pmDateBtn").onclick=()=>{ $("#pmDatePicker").classList.remove("hide"); $("#pmDatePicker").showPicker?.(); };
    $("#amDatePicker").onchange=(e)=>{ amDate=new Date(e.target.value); setDates(); e.target.classList.add("hide"); };
    $("#pmDatePicker").onchange=(e)=>{ pmDate=new Date(e.target.value); setDates(); e.target.classList.add("hide"); };

    // chips
    chipContainer($("#chipsClass"),OPS.classes); chipContainer($("#chipsSex"),OPS.sex,true); chipContainer($("#chipsDx"),OPS.dx); chipContainer($("#chipsComm"),OPS.comm); chipContainer($("#chipsSensory"),OPS.sensory); chipContainer($("#chipsReinf"),OPS.reinf); chipContainer($("#chipsTrigger"),OPS.trigger); chipContainer($("#chipsMeds"),OPS.meds);
    $("#photo").onchange=async (e)=>{ const f=e.target.files[0]; if(!f) return; $("#preview").src=await imgToDataURL(f); };

    // actions
    $("#addStu").onclick=addStu;
    $("#amSave").onclick=()=>saveEmotion("am", $("#amSave"));
    $("#pmSave").onclick=()=>saveEmotion("pm", $("#pmSave"));

    // edit modal
    $("#editClose").onclick=()=>closeModal("#modalEdit");
    $("#editSave").onclick=async ()=>{
      const s=students.find(x=>x.id==editTargetId); if(!s) return;
      s.name=$("#editName").value.trim();
      const pf=$("#editPhoto").files[0]; if(pf) s.photo=await imgToDataURL(pf);
      const collect=(id)=>Array.from($(id).querySelectorAll(".chip.selected")).map(x=>x.dataset.v);
      s.classes=collect("#editClass"); s.sex=collect("#editSex")[0]||""; s.dx=collect("#editDx"); s.comm=collect("#editComm"); s.sensory=collect("#editSensory"); s.reinf=collect("#editReinf"); s.trigger=collect("#editTrigger"); s.meds=collect("#editMeds");
      try{ await updateStudentS(s); await serverExport(); done("í•™ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); closeModal("#modalEdit"); }catch(err){ done("ì„œë²„ ìˆ˜ì • ì‹¤íŒ¨: "+err.message); }
    };

    function openEdit(id){
      editTargetId=Number(id); const s=students.find(x=>x.id==editTargetId); if(!s) return;
      $("#editName").value=s.name||""; $("#editPreview").src=s.photo||""; $("#editPhoto").value="";
      const setContainer=(sel,ops,vals,single=false)=>{ const el=$(sel); el.innerHTML=ops.map(v=>`<div class="chip" data-v="${v}">${v}</div>`).join(""); el.querySelectorAll(".chip").forEach(c=>{ if(vals.includes(c.dataset.v)) c.classList.add("selected"); }); el.onclick=e=>{ const c=e.target.closest(".chip"); if(!c) return; if(single){ el.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected")); c.classList.add("selected"); } else c.classList.toggle("selected"); }; };
      setContainer("#editClass",OPS.classes,s.classes||[]);
      setContainer("#editSex",OPS.sex,[s.sex||""],true);
      setContainer("#editDx",OPS.dx,s.dx||[]);
      setContainer("#editComm",OPS.comm,s.comm||[]);
      setContainer("#editSensory",OPS.sensory,s.sensory||[]);
      setContainer("#editReinf",OPS.reinf,s.reinf||[]);
      setContainer("#editTrigger",OPS.trigger,s.trigger||[]);
      setContainer("#editMeds",OPS.meds,s.meds||[]);
      openModal("#modalEdit");
    }
    window.openEdit=openEdit;

    // data search
    $("#btnSearch").onclick=()=>buildDataManager($("#searchName").value.trim());
    $("#btnClear").onclick=()=>{ $("#searchName").value=""; buildDataManager(""); };
  });
})();
</script>
</body>
</html>
