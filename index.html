<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê°ì •ë°ì´í„°ë¶„ì„ë„êµ¬ â€” ê³ ì • ì—°ê²°(ë¬´ì‹œí¬ë¦¿, ì •ë¦¬ë³¸)</title>
  <style>
    :root{--primary:#6366f1;--bg:#f6f7fb;--panel:#fff;--border:#e5e7eb;--text:#0f172a;--muted:#6b7280;--danger:#ef4444;--ok:#16a34a}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px} .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:16px}
    .tabs{display:flex;gap:10px;overflow:auto;margin-bottom:12px} .tab{padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;white-space:nowrap}
    .tab.active{background:var(--primary);color:#fff;border-color:transparent} .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 12px;border-radius:999px;border:1px solid #c7d2fe;background:#eef2ff;white-space:nowrap} .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:9px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;min-height:38px}
    .btn.primary{background:var(--primary);border-color:transparent;color:#fff} .btn.danger{background:#ef4444;border-color:transparent;color:#fff} .btn.ok{background:var(--ok);border-color:transparent;color:#fff}
    .muted{color:var(--muted)} .hide{display:none!important} input,select,textarea{width:100%;padding:9px;border:1px solid var(--border);border-radius:10px}
    .scroller{display:flex;gap:12px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:6px 2px} .stu{flex:0 0 210px;background:#fff;border:2px solid var(--border);border-radius:16px;padding:12px;text-align:center}
    .stu.selected{border-color:#6366f1;box-shadow:0 0 0 2px rgba(99,102,241,.22) inset} .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#e5e7eb;border:2px solid #fff;box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .emoList{display:grid;gap:10px} .emoBtn{display:flex;align-items:center;gap:12px;border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;cursor:pointer}
    .emoBtn.active{border-color:#6366f1;background:#eef2ff} .emoEmoji{font-size:26px} .emoTitle{font-weight:800} .emoScale{font-size:12px;color:#64748b}
    .context{display:grid;grid-template-columns:repeat(3,1fr);gap:8px} .chip{padding:9px 12px;border-radius:999px;border:1px solid var(--border);background:#f8fafc;font-size:13px;cursor:pointer;text-align:center;user-select:none}
    .chip.selected{background:#6366f1;color:#fff;border-color:transparent} table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:6px;text-align:center;font-size:13px} th{background:#f3f4f6}
    canvas{width:100%;height:360px;border:1px solid var(--border);border-radius:12px;background:#fff}
    @media (max-width:640px){ .stu{flex:0 0 160px} } @media print{ .no-print{display:none!important} body{background:#fff} .card{border:0;box-shadow:none} @page{size:A4;margin:12mm} }
  </style>
</head>
<body>
<div class="wrap">
  <!-- ë¡œê·¸ì¸(í•­ìƒ ì²« í™”ë©´) -->
  <section id="login" class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>ğŸ” ë°˜ ì„ íƒ ë¡œê·¸ì¸</h2>
      <div class="muted">A~F: a123~f123 Â· ê´€ë¦¬ì: admin123</div>
    </div>
    <div class="row" id="classGrid"></div>
    <div id="pwArea" class="hide">
      <div class="row"><input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì˜ˆ: a123)" /><button id="btnLogin" class="btn primary">ë¡œê·¸ì¸</button></div>
      <div class="muted" style="margin-top:6px"><span class="pill">ìƒíƒœ</span> <span id="syncStatus" class="muted">ì´ˆê¸°í™”</span></div>
    </div>
  </section>

  <!-- ë³¸ì²´ -->
  <section id="app" class="card hide">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>ğŸ“˜ ê°ì •ë°ì´í„°ë¶„ì„ë„êµ¬ â€” ê³ ì •ì—°ë™(ì •ë¦¬ë³¸)</h2>
      <div class="row no-print"><div id="who" class="pill">-</div><button id="btnLogout" class="btn">ë¡œê·¸ì•„ì›ƒ</button></div>
    </div>

    <div class="tabs no-print" id="tabs">
      <button class="tab active" data-tab="am">ğŸ« ë“±êµì…ë ¥</button>
      <button class="tab" data-tab="pm">ğŸ¡ í•˜êµì…ë ¥</button>
      <button class="tab" data-tab="data">ğŸ“‹ ë°ì´í„° ê´€ë¦¬</button>
      <button class="tab" data-tab="graph">ğŸ“ˆ ê·¸ë˜í”„ë³´ê³ ì„œ</button>
      <button class="tab" data-tab="list">ğŸ‘¥ í•™ìƒëª©ë¡</button>
      <button class="tab" data-tab="new">â• í•™ìƒë“±ë¡</button>
      <button class="tab" data-tab="admin">ğŸ› ï¸ ê´€ë¦¬</button>
    </div>

    <!-- AM -->
    <div id="tab-am">
      <div class="row" style="justify-content:center;gap:8px"><button class="btn" id="amPrev">â—€</button><div class="pill" id="amDate"></div><button class="btn" id="amNext">â–¶</button></div>
      <h3>í•™ìƒ ì„ íƒ</h3><div id="amScroller" class="scroller"></div>
      <div id="amForm" class="hide">
        <h3 id="amWho" style="text-align:center"></h3>
        <div class="emoList" id="amEmotions"></div>
        <div id="amCtxWrap" class="hide"><div style="height:8px"></div><div class="muted" style="text-align:center">ê°„í¸ ë§¥ë½ (ë³µìˆ˜ ì„ íƒ)</div><div id="amCtx" class="context"></div></div>
        <div class="row"><button class="btn primary" id="amSave">ì €ì¥</button></div>
      </div>
    </div>

    <!-- PM -->
    <div id="tab-pm" class="hide">
      <div class="row" style="justify-content:center;gap:8px"><button class="btn" id="pmPrev">â—€</button><div class="pill" id="pmDate"></div><button class="btn" id="pmNext">â–¶</button></div>
      <h3>í•™ìƒ ì„ íƒ</h3><div id="pmScroller" class="scroller"></div>
      <div id="pmForm" class="hide">
        <h3 id="pmWho" style="text-align:center"></h3>
        <div class="emoList" id="pmEmotions"></div>
        <div id="pmCtxWrap" class="hide"><div style="height:8px"></div><div class="muted" style="text-align:center">ê°„í¸ ë§¥ë½ (ë³µìˆ˜ ì„ íƒ)</div><div id="pmCtx" class="context"></div></div>
        <div class="row"><button class="btn primary" id="pmSave">ì €ì¥</button></div>
      </div>
    </div>

    <!-- Data -->
    <div id="tab-data" class="hide">
      <h3>ëª¨ë“  ë°ì´í„° í™•ì¸/ìˆ˜ì •/ì‚­ì œ</h3>
      <table>
        <thead><tr><th>ë‚ ì§œ</th><th>í•™ìƒ</th><th>êµ¬ë¶„</th><th>ì ìˆ˜</th><th>ë§¥ë½</th><th>ìˆ˜ì •</th><th>ì‚­ì œ</th></tr></thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>

    <!-- Graph & Report -->
    <div id="tab-graph" class="hide">
      <h3>í•™ìƒë³„ ì„  ê·¸ë˜í”„ ë° ìë™ ë¶„ì„ ë³´ê³ ì„œ</h3>
      <div class="row">
        <select id="graphStudent"></select>
        <input type="date" id="fromDate"><input type="date" id="toDate">
        <button class="btn" id="btnGraph">ê·¸ë˜í”„/ë³´ê³ ì„œ ìƒì„±</button>
        <button class="btn" id="btnPrint">ğŸ–¨ï¸ ì¸ì‡„ / PDF</button>
      </div>
      <div style="height:8px"></div>
      <h3 id="graphTitle" style="text-align:center"></h3>
      <canvas id="chart"></canvas>
      <div class="muted" style="font-size:12px;margin-top:6px;text-align:center">
        <b>ë²”ë¡€:</b> <span style="color:#ef4444">â— ë¹¨ê°„ ì›=ë“±êµ(AM)</span> Â· <span style="color:#3b82f6">â–² íŒŒë€ ì„¸ëª¨=í•˜êµ(PM)</span> Â· ì  ìœ„ ìˆ«ìëŠ” ì ìˆ˜
      </div>
      <div style="height:14px"></div>
      <h3>ìë™ ë¶„ì„ ë³´ê³ ì„œ</h3>
      <div id="reportBox" class="card" style="border-radius:16px"></div>
    </div>

    <!-- List -->
    <div id="tab-list" class="hide"><h3>í•™ìƒ ëª©ë¡</h3><div id="stuList"></div></div>

    <!-- New -->
    <div id="tab-new" class="hide">
      <h3>í•™ìƒ ë“±ë¡</h3>
      <div class="row"><input id="photo" type="file" accept="image/*" class="no-print"><input id="newName" type="text" placeholder="í•™ìƒ ì´ë¦„"><button class="btn" id="addStu">ë“±ë¡</button></div>
      <div style="height:8px"></div>
      <label>í•™ê¸‰</label><div id="chipsClass" class="context"></div>
      <label>ì„±ë³„</label><div id="chipsSex" class="context"></div>
      <label>ì§„ë‹¨</label><div id="chipsDx" class="context"></div>
      <label>ì˜ì‚¬ì†Œí†µ</label><div id="chipsComm" class="context"></div>
      <label>ê°ê° í”„ë¡œí•„</label><div id="chipsSensory" class="context"></div>
      <label>ì„ í˜¸ ê°•í™”ì œ</label><div id="chipsReinf" class="context"></div>
      <label>ì£¼ìš” ìœ ë°œìƒí™©</label><div id="chipsTrigger" class="context"></div>
      <label>ì˜ë£Œ/ì•½ë¬¼</label><div id="chipsMeds" class="context"></div>
      <div class="row"><input id="newParent" type="tel" placeholder="ë³´í˜¸ì ì—°ë½ì²˜"/></div>
    </div>

    <!-- Admin -->
    <div id="tab-admin" class="hide">
      <h3>ê´€ë¦¬</h3>
      <div class="muted">ì´ ë²„ì „ì€ URLì´ ì½”ë“œì— ê³ ì •ë©ë‹ˆë‹¤.</div>
      <div class="row" style="margin-top:8px">
        <button id="syncPull" class="btn">ì„œë²„ â†’ ë¡œì»¬</button>
        <button id="syncPush" class="btn">ë¡œì»¬ â†’ ì„œë²„</button>
        <button id="exportJson" class="btn">JSON ë‚´ë³´ë‚´ê¸°</button>
        <label class="btn"><input id="importJson" type="file" accept="application/json" class="hide">JSON ê°€ì ¸ì˜¤ê¸°</label>
        <button id="purgeLocal" class="btn danger">ë¡œì»¬ ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
      <div class="muted" style="margin-top:6px">ìƒíƒœ: <span id="adminStatus" style="font-family:ui-monospace;background:#111827;color:#fff;padding:2px 6px;border-radius:6px">idle</span></div>
    </div>
  </section>
</div>

<script>
(function(){
  "use strict";
  // â˜… ì—¬ê¸° í•œ ê³³ë§Œ URL ë¶™ì—¬ë„£ìœ¼ë©´ ë
  const SYNC_URL = "https://script.google.com/macros/s/AKfycbzbXiAdD7Jtt9hT7x2NnIssOxqE8-nRCGMDNSnYnOAdJVcqHuyLJH5Ja9MzupBl2Z1G/exec";

  const KEY_ST="students_fixed_clean", KEY_ED="emotion_fixed_clean", KEY_SES="session_fixed_clean";
  const PWD={A:"a123",B:"b123",C:"c123",D:"d123",E:"e123",F:"f123",admin:"admin123"};
  let currentUser=null, students=[], emotion={};

  const EMO={5:{emoji:"ğŸ˜„",name:"í–‰ë³µ",scale:"ìë°œì  ë¯¸ì†ŒÂ·ê¸ì • ì–¸ì–´, ë„ì›€ ì—†ì´ ê³¼ì œ ì°¸ì—¬ â‰¥90%, ë¬¸ì œí–‰ë™ 0íšŒ"},
            4:{emoji:"ğŸ™‚",name:"ì¢‹ìŒ",scale:"ì§€ì‹œ ë”°ë¦„ 80% ë‚´ì™¸, ê°€ë²¼ìš´ ë„ì›€, ë¬¸ì œí–‰ë™ 0â€“1íšŒÂ·ì§§ìŒ"},
            3:{emoji:"ğŸ˜",name:"ë³´í†µ",scale:"ì¤‘ë¦½ í‘œì •, ì°¸ì—¬ ë³€ë™, ì§€ì‹œ ë”°ë¦„ 60â€“80%"},
            2:{emoji:"ğŸ˜”",name:"ë¶ˆí¸/ìŠ¬í””",scale:"íšŒí”¼Â·í•œìˆ¨Â·ëŠë¦° ë°˜ì‘, ì§€ì‹œ ë”°ë¦„ 40â€“60%, ì§€ì› í•„ìš”"},
            1:{emoji:"ğŸ˜­",name:"ê²©ì•™/ê´´ë¡œì›€",scale:"ìš¸ìŒ/ê³ í•¨Â·ê°•í•œ ë¶ˆí¸, ì§€ì‹œ ë”°ë¦„ <40%, ì¦‰ê° ì¤‘ì¬ í•„ìš”"}};
  const CTX=["ğŸ˜´ ìˆ˜ë©´ë¶€ì¡±","ğŸ’Š ê±´ê°•ì €í•˜","ğŸ  ê°€ì •ì´ìŠˆ","ğŸ”„ í™œë™ì „í™˜","ğŸ§’ ë˜ë˜ê°ˆë“±","ğŸ‘€ ê´€ì‹¬ìš”êµ¬","ğŸ ê°•í™”ì œìš”êµ¬","ğŸšª ê³¼ì œíšŒí”¼","ğŸŒ€ ê°ê°ì¶”êµ¬","ğŸ”Š ì†ŒìŒë¯¼ê°","ğŸ½ï¸ ë°°ê³ í””","ğŸ¤• í†µì¦/ë¶ˆí¸","ğŸ“… ì¼ì •ë³€ê²½","ğŸšŒ ë“±í•˜êµí”¼ë¡œ","ğŸŒ¤ï¸ ë‚ ì”¨ì˜í–¥"];
  const OPS={classes:["A","B","C","D","E","F"],sex:["ë‚¨","ì—¬"],dx:["ì§€ì ì¥ì• ","ìíìŠ¤í™íŠ¸ëŸ¼","ADHD","í•™ìŠµì¥ì• ","ì •ì„œÂ·í–‰ë™ì¥ì• ","ê¸°íƒ€"],comm:["êµ¬ì–´","PECS","AAC","ì œìŠ¤ì²˜","ì œí•œì  ì–¸ì–´","ê¸°íƒ€"],sensory:["ì²­ê° ê³¼ë¯¼","ì‹œê° ê³¼ë¯¼","ì´‰ê° ê³¼ë¯¼","ì••ë°• ì„ í˜¸","ì›€ì§ì„ ì¶”êµ¬","ê¸°íƒ€"],reinf:["ìŠ¤í‹°ì»¤","ìŒì‹(ìŠ¤ë‚µ/ìŒë£Œ)","í™œë™(íœ´ì‹Â·ì‚°ì±…)","ì „ìê¸°ê¸°","ì‚¬íšŒì  ì¹­ì°¬","ê¸°íƒ€"],trigger:["ê³¼ì œ ì „í™˜","ì†ŒìŒ","ì˜ˆê¸°ì¹˜ ì•Šì€ ì¼ì • ë³€ê²½","ë˜ë˜ ê°ˆë“±","ìš”êµ¬ ê±°ë¶€","ê¸°íƒ€"],meds:["ì—†ìŒ","í•­ì •ì‹ ë³‘ì œ","í•­ë¶ˆì•ˆì œ","í•­ê²½ë ¨ì œ","ê¸°íƒ€"]};

  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const fmt=d=>new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split("T")[0];
  const clamp=n=>Math.max(1,Math.min(5,n|0));
  const setText=(sel,txt)=>{ const el=$(sel); if(el) el.textContent=txt; };
  const toast=(msg)=>{ setText("#syncStatus",msg); setText("#adminStatus",msg); };

  const persist=()=>{
    localStorage.setItem(KEY_ST,JSON.stringify(students));
    localStorage.setItem(KEY_ED,JSON.stringify(emotion));
    buildDataManager();
  };

  // ë¡œê·¸ì¸
  const buildClassButtons=()=>{
    const g=$("#classGrid"); ["A","B","C","D","E","F","admin"].forEach(k=>{
      const b=document.createElement("button"); b.className="btn"; b.textContent=(k==="admin"?"ğŸ”‘ ê´€ë¦¬ì":"í•™ê¸‰ "+k);
      b.onclick=()=>{ currentUser=k; $("#pwArea").classList.remove("hide"); setTimeout(()=>$("#pw").focus(),30); };
      g.appendChild(b);
    });
  };
  const login=()=>{
    const val=$("#pw").value.trim();
    if(!currentUser) return toast("í•™ê¸‰ ì„ íƒ");
    if(val===PWD[currentUser]){
      localStorage.setItem(KEY_SES,JSON.stringify({user:currentUser,t:Date.now()}));
      $("#login").classList.add("hide"); $("#app").classList.remove("hide");
      setText("#who", currentUser==="admin"?"ê´€ë¦¬ì":currentUser+"í•™ê¸‰");
      pullServer(true); buildAll();
    } else toast("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
  };
  const logout=()=>{ localStorage.removeItem(KEY_SES); location.reload(); };

  // ì¹©
  const chipContainer=(id,ops,single=false)=>{
    const el=$(id); el.innerHTML=ops.map(v=>`<div class="chip" data-v="${v}">${v}</div>`).join("");
    el.onclick=e=>{ const c=e.target.closest(".chip"); if(!c) return; if(single){ $$(id+" .chip").forEach(x=>x.classList.remove("selected")); c.classList.add("selected"); } else c.classList.toggle("selected"); };
  };
  const getChips=id=>$$(id+" .chip.selected").map(x=>x.dataset.v);

  // í•™ìƒ
  const buildStuList=()=>{
    const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    $("#stuList").innerHTML = list.map(s=>`
      <div class="row" style="justify-content:space-between;border-bottom:1px solid #e5e7eb;padding:8px 0">
        <div class="row"><img class="avatar" src="${s.photo||""}"><div><div><b>${s.name}</b> <span class="muted">(${(s.classes||[]).join(", ")})</span></div>
        <div class="muted" style="font-size:12px">${(s.dx||[]).join("/")} Â· ${(s.comm||[]).join("/")} Â· ${(s.sensory||[]).join("/")}</div></div></div>
        <button class="btn danger" data-del="${s.id}">ì‚­ì œ</button></div>`).join("") || `<div class="muted">í•™ìƒ ì—†ìŒ</div>`;
    $("#stuList").onclick = (e)=>{ const b=e.target.closest("button[data-del]"); if(!b) return; const id=b.dataset.del; students=students.filter(s=>s.id!=id); persist(); buildStuList(); buildStudents("#amScroller","am"); buildStudents("#pmScroller","pm"); buildGraphStudentSelect(); };
  };
  const imgToDataURL=file=>new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(file); });
  const addStu=async()=>{
    const name=$("#newName").value.trim(); if(!name) return toast("ì´ë¦„ ì…ë ¥");
    let photo=null; const f=$("#photo").files[0]; if(f) photo=await imgToDataURL(f);
    const s={id:Date.now(),name,photo,classes:getChips("#chipsClass"),sex:getChips("#chipsSex")[0]||"",dx:getChips("#chipsDx"),comm:getChips("#chipsComm"),sensory:getChips("#chipsSensory"),reinf:getChips("#chipsReinf"),trigger:getChips("#chipsTrigger"),meds:getChips("#chipsMeds"),parent:$("#newParent").value.trim()};
    students.push(s);
    ["#chipsClass","#chipsSex","#chipsDx","#chipsComm","#chipsSensory","#chipsReinf","#chipsTrigger","#chipsMeds"].forEach(id=>$$(id+" .chip").forEach(c=>c.classList.remove("selected")));
    $("#newName").value=""; $("#newParent").value=""; $("#photo").value="";
    persist(); buildStuList(); buildStudents("#amScroller","am"); buildStudents("#pmScroller","pm"); buildGraphStudentSelect();
    pushServer();
  };
  const buildStudents=(container,prefix)=>{
    const all=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    const el=$(container);
    el.innerHTML = all.map(s=>`
      <div class="stu" data-id="${s.id}"><img class="avatar" src="${s.photo||""}"><div style="font-weight:800;margin-top:6px">${s.name}</div><div class="muted" style="font-size:12px">${(s.classes||[])[0]||""}</div></div>`).join("") || `<div class="muted">í•™ìƒ ì—†ìŒ</div>`;
    el.onclick = (e)=>{ const card=e.target.closest(".stu"); if(!card) return; $$(container+" .stu").forEach(x=>x.classList.remove("selected")); card.classList.add("selected"); const sid=card.dataset.id; const nm=(students.find(x=>x.id==sid)||{}).name||""; (prefix==="am"?$("#amForm"):$("#pmForm")).classList.remove("hide"); (prefix==="am"?$("#amWho"):$("#pmWho")).textContent = `${nm} í•™ìƒì˜ ê°ì •`; el.dataset.sel=sid; };
  };

  // ê°ì • ì…ë ¥
  const buildEmo=prefix=>{
    const box= prefix==="am" ? $("#amEmotions") : $("#pmEmotions");
    box.innerHTML = [5,4,3,2,1].map(sc=>`
      <div class="emoBtn" data-score="${sc}"><div class="emoEmoji">${EMO[sc].emoji}</div>
        <div><div class="emoTitle">${sc}ì  (${EMO[sc].name})</div><div class="emoScale">${EMO[sc].scale} Â· ëˆ„êµ¬ë‚˜ ê´€ì°° ê°€ëŠ¥</div></div>
      </div>`).join("");
    box.onclick = (e)=>{ const b=e.target.closest(".emoBtn"); if(!b) return; $$("#"+(prefix==="am"?"amEmotions":"pmEmotions")+" .emoBtn").forEach(x=>x.classList.remove("active")); b.classList.add("active"); box.dataset.score=b.dataset.score; (prefix==="am"?$("#amCtxWrap"):$("#pmCtxWrap")).classList.remove("hide"); };
  };
  const buildCtx=container=>{ const el=$(container); el.innerHTML = CTX.map(t=>`<div class="chip" data-k="${t}">${t}</div>`).join(""); el.onclick = (e)=>{ const c=e.target.closest(".chip"); if(!c) return; c.classList.toggle("selected"); }; };

  // ë‚ ì§œ
  let amDate=new Date(), pmDate=new Date();
  const dateK=d=>d.toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric",weekday:"long"});
  const setDates=()=>{ $("#amDate").textContent=dateK(amDate); $("#pmDate").textContent=dateK(pmDate); };

  const save=prefix=>{
    const scroller = prefix==="am" ? $("#amScroller") : $("#pmScroller"); const sid=scroller.dataset.sel;
    const score = parseInt((prefix==="am"?$("#amEmotions"):$("#pmEmotions")).dataset.score||"0",10);
    if(!sid || !score) return toast("í•™ìƒ/ê°ì • ì„ íƒ");
    const date = fmt(prefix==="am"?amDate:pmDate);
    emotion[date]=emotion[date]||{};
    const stu=students.find(s=>s.id==sid);
    if(!emotion[date][sid]) emotion[date][sid]={name:stu?.name||""};
    const ctx=$$(prefix==="am"?"#amCtx .chip.selected":"#pmCtx .chip.selected").map(x=>x.dataset.k);
    emotion[date][sid][prefix==="am"?"morning":"afternoon"]={score:clamp(score),context:ctx};
    persist(); alert("ì €ì¥ë¨"); pushServer();
    $$(prefix==="am"?"#amEmotions .emoBtn":"#pmEmotions .emoBtn").forEach(x=>x.classList.remove("active"));
    (prefix==="am"?$("#amCtxWrap"):$("#pmCtxWrap")).classList.add("hide");
    $$(prefix==="am"?"#amCtx .chip":"#pmCtx .chip").forEach(x=>x.classList.remove("selected"));
  };

  // ë°ì´í„° ê´€ë¦¬
  const buildDataManager=()=>{
    const body=$("#dataBody"); body.innerHTML="";
    const dates=Object.keys(emotion).sort();
    dates.forEach(k=>{
      const day=emotion[k];
      Object.keys(day).forEach(sid=>{
        const rec=day[sid];
        ["morning","afternoon"].forEach(slot=>{
          const cur=rec[slot]; if(!cur) return;
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${k}</td><td>${rec.name}</td><td>${slot==="morning"?"ë“±êµ":"í•˜êµ"}</td>
            <td><input type="number" min="1" max="5" value="${cur.score}" style="width:70px"/></td>
            <td><input type="text" value="${(cur.context||[]).join(", ")}" placeholder="ì‰¼í‘œ êµ¬ë¶„"/></td>
            <td><button class="btn" data-act="save">ìˆ˜ì •</button></td>
            <td><button class="btn danger" data-act="del">ì‚­ì œ</button></td>`;
          tr.dataset.date=k; tr.dataset.sid=sid; tr.dataset.slot=slot; body.appendChild(tr);
        });
      });
    });
    body.onclick=(e)=>{
      const btn=e.target.closest("button"); if(!btn) return;
      const tr=btn.closest("tr"); const d=tr.dataset.date, sid=tr.dataset.sid, slot=tr.dataset.slot;
      if(btn.dataset.act==="save"){
        const score=parseInt(tr.querySelector('input[type="number"]').value||"0",10);
        const ctx=tr.querySelector('input[type="text"]').value.split(",").map(s=>s.trim()).filter(Boolean);
        if(!score) return alert("ì ìˆ˜ 1~5 ì…ë ¥");
        emotion[d][sid][slot]={score:clamp(score),context:ctx};
        persist(); pushServer(); alert("ìˆ˜ì • ì™„ë£Œ");
      } else {
        if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
        delete emotion[d][sid][slot];
        if(!emotion[d][sid].morning && !emotion[d][sid].afternoon) delete emotion[d][sid];
        if(Object.keys(emotion[d]).length===0) delete emotion[d];
        persist(); pushServer(); tr.remove();
      }
    };
  };

  // ê·¸ë˜í”„
  const buildGraphStudentSelect=()=>{
    const sel=$("#graphStudent"); const list=currentUser==="admin"?students:students.filter(s=>(s.classes||[]).includes(currentUser));
    sel.innerHTML = `<option value="">í•™ìƒ ì„ íƒ</option>` + list.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
  };
  const getRangeData=(studentId,from,to)=>{
    const labels=[], am=[], pm=[]; const fromD=new Date(from), toD=new Date(to); if(isNaN(fromD)||isNaN(toD)) return {labels,am,pm};
    const cur=new Date(fromD);
    while(cur<=toD){ const k=fmt(cur), r=emotion[k]?.[studentId]; labels.push(k.slice(5)); am.push(r?.morning?.score ?? null); pm.push(r?.afternoon?.score ?? null); cur.setDate(cur.getDate()+1); }
    return {labels, am, pm};
  };
  const drawGraphTitle=name=> { $("#graphTitle").textContent = name ? `${name} í•™ìƒ ê°ì • ëª¨ë‹ˆí„°ë§ ê·¸ë˜í”„` : ""; };
  const drawChart=(canvasId, labels, am, pm)=>{
    const c=document.getElementById(canvasId), ctx=c.getContext('2d');
    const dpr=window.devicePixelRatio||1; c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.scale(dpr,dpr);
    ctx.clearRect(0,0,c.clientWidth,c.clientHeight);
    const W=c.clientWidth,H=c.clientHeight,pad=42;
    ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.moveTo(pad,pad); ctx.lineTo(pad,H-pad); ctx.stroke();
    for(let s=1;s<=5;s++){ const y=H-pad-(H-2*pad)*(s-1)/4; ctx.fillStyle="#64748b"; ctx.font="12px sans-serif"; ctx.fillText(String(s), 10, y+4); ctx.strokeStyle="#f1f5f9"; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke(); }
    if(!labels.length) return;
    const step=(W-2*pad)/Math.max(1,labels.length-1); const yOf=v=>H-pad-(H-2*pad)*((v-1)/4);
    labels.forEach((lab,i)=>{ const x=pad+i*step; if(i%Math.ceil(labels.length/8)===0){ ctx.fillStyle="#64748b"; ctx.fillText(lab, x-12, H-pad+14); } });
    ctx.fillStyle="#ef4444"; am.forEach((v,i)=>{ if(v==null) return; const x=pad+i*step, y=yOf(v); ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill(); ctx.font="11px sans-serif"; ctx.fillText(String(v), x+6, y-6); });
    ctx.fillStyle="#3b82f6"; pm.forEach((v,i)=>{ if(v==null) return; const x=pad+i*step, y=yOf(v); ctx.beginPath(); ctx.moveTo(x, y-5); ctx.lineTo(x-5, y+4); ctx.lineTo(x+5, y+4); ctx.closePath(); ctx.fill(); ctx.font="11px sans-serif"; ctx.fillText(String(v), x+6, y-6); });
  };
  const handleGraph=()=>{
    const sid=$("#graphStudent").value, from=$("#fromDate").value, to=$("#toDate").value; if(!sid||!from||!to) return alert("í•™ìƒê³¼ ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.");
    const s = students.find(x=>x.id==sid); drawGraphTitle(s?.name||"");
    const g = getRangeData(sid,from,to); drawChart("chart",g.labels,g.am,g.pm); genReport(sid,from,to);
  };
  const genReport=(studentId, from, to)=>{
    const s = students.find(x=>x.id==studentId); if(!s){ $("#reportBox").innerHTML="í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
    const cur=new Date(from), end=new Date(to); const recs=[];
    while(cur<=end){ const k=fmt(cur); const r=emotion[k]?.[studentId]; if(r?.morning) recs.push({date:k,slot:"AM",score:r.morning.score,ctx:r.morning.context||[]}); if(r?.afternoon) recs.push({date:k,slot:"PM",score:r.afternoon.score,ctx:r.afternoon.context||[]}); cur.setDate(cur.getDate()+1); }
    const n=recs.length, avg=a=>a.length? (a.reduce((x,y)=>x+y,0)/a.length).toFixed(2):"-", amScores=recs.filter(r=>r.slot==="AM").map(r=>r.score), pmScores=recs.filter(r=>r.slot==="PM").map(r=>r.score);
    const lowDays = recs.filter(r=>r.score<=2).length, ctxCount={}; recs.forEach(r=>r.ctx.forEach(c=>ctxCount[c]=(ctxCount[c]||0)+1));
    const topCtx = Object.entries(ctxCount).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v])=>`${k}(${v})`);
    const parts = [`<b>ê¸°ë³¸ ì •ë³´</b>: í•™ê¸‰ ${(s.classes||[]).join("/")||"ë¯¸ë“±ë¡"}, ì§„ë‹¨ ${(s.dx||[]).join(", ")||"ë¯¸ë“±ë¡"}, ì˜ì‚¬ì†Œí†µ ${(s.comm||[]).join(", ")||"ë¯¸ë“±ë¡"}, ê°ê° ${(s.sensory||[]).join(", ")||"ë¯¸ë“±ë¡"}`];
    const lines = [`<b>ìš”ì•½</b>: í‘œë³¸ ${n}ê°œ, AM í‰ê·  ${avg(amScores)}, PM í‰ê·  ${avg(pmScores)}, ì €ì¡°(â‰¤2) ${lowDays}íšŒ.`]; if(topCtx.length) lines.push(`<b>ì£¼ìš” ë§¥ë½</b>: ${topCtx.join(", ")}.`);
    const rec=[]; if((avg(amScores)!=="-" && parseFloat(avg(amScores))<=3) || (avg(pmScores)!=="-" && parseFloat(avg(pmScores))<=3)) rec.push("SELÂ·Zones: ê°ì • ë ˆì´ë¸”ë§Â·ëŒ€ì²˜ ì¹´ë“œ");
    rec.push("ABA/TEACCH/PECSÂ·AAC/ê°ê°í†µí•©/CBTÂ·DBT/CPI í˜‘ì—… ë£¨í‹´ ê¶Œì¥");
    $("#reportBox").innerHTML = `<div>${parts.join("<br>")}</div><div style="height:8px"></div><div>${lines.join("<br>")}</div><div style="height:8px"></div><b>ê¶Œì¥ ì¤‘ì¬/êµìœ¡ ë°©ë²•</b><ul>${rec.map(r=>`<li>${r}</li>`).join("")}</ul>`;
  };

  // ë™ê¸°í™”(ë¬´ì‹œí¬ë¦¿)
  const pullServer=async(silent=false)=>{
    if(!SYNC_URL) return toast("SYNC_URL ë¯¸ì„¤ì •");
    try{
      const r=await fetch(SYNC_URL+"?action=export"); if(!r.ok) throw new Error(r.status+"");
      const json=await r.json(); if(json.students && json.emotion){ students=json.students; emotion=json.emotion; persist(); buildAll(); toast("ì„œë²„ â†’ ë¡œì»¬ ì™„ë£Œ"); if(!silent) alert("ë™ê¸°í™” ì™„ë£Œ"); } else throw new Error("í˜•ì‹ì˜¤ë¥˜");
    }catch(e){ toast("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: "+e); if(!silent) alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨"); }
  };
  const pushServer=async()=>{
    if(!SYNC_URL) return;
    try{ const r=await fetch(SYNC_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"push",version:"fixed_clean",students,emotion})}); await r.text(); toast("ë¡œì»¬ â†’ ì„œë²„ ì—…ë¡œë“œ ì™„ë£Œ"); }
    catch(e){ toast("ì—…ë¡œë“œ ì‹¤íŒ¨: "+e); }
  };

  // ì´ˆê¸° êµ¬ì„±
  const buildAll=()=>{
    buildStuList(); buildStudents("#amScroller","am"); buildStudents("#pmScroller","pm");
    buildEmo("am"); buildEmo("pm"); buildCtx("#amCtx"); buildCtx("#pmCtx"); buildDataManager(); buildGraphStudentSelect();
    const past=new Date(); past.setDate(past.getDate()-14); $("#fromDate").value=fmt(past); $("#toDate").value=fmt(new Date()); setDates();
  };

  document.addEventListener("DOMContentLoaded", ()=>{
    try{ students=JSON.parse(localStorage.getItem(KEY_ST)||"[]"); emotion=JSON.parse(localStorage.getItem(KEY_ED)||"{}"); }catch{ students=[]; emotion={}; }
    if(students.length===0){ students=["ê¹€ë¯¼ì¤€","ì´ì„œì¤€","ë°•ë„ìœ¤","ìµœì‹œìš°"].map((n,i)=>({id:Date.now()+i,name:n,classes:["A"]})); persist(); }
    buildClassButtons(); $("#btnLogin").onclick=login; $("#pw").addEventListener("keydown",e=>{ if(e.key==="Enter") login(); }); $("#btnLogout").onclick=logout;
    $("#tabs").onclick=(e)=>{ const b=e.target.closest(".tab"); if(!b)return; const tab=b.dataset.tab; $$(".tab").forEach(x=>x.classList.toggle("active",x.dataset.tab===tab)); ["am","pm","data","graph","list","new","admin"].forEach(id=>$("#tab-"+id).classList.toggle("hide", id!==tab)); if(tab==="data") buildDataManager(); if(tab==="graph") buildGraphStudentSelect(); if(tab==="list") buildStuList(); };
    $("#amPrev").onclick=()=>{ amDate.setDate(amDate.getDate()-1); setDates(); };
    $("#amNext").onclick=()=>{ amDate.setDate(amDate.getDate()+1); setDates(); };
    $("#pmPrev").onclick=()=>{ pmDate.setDate(pmDate.getDate()-1); setDates(); };
    $("#pmNext").onclick=()=>{ pmDate.setDate(pmDate.getDate()+1); setDates(); };
    $("#amSave").onclick=()=>save("am"); $("#pmSave").onclick=()=>save("pm");
    chipContainer("#chipsClass",OPS.classes); chipContainer("#chipsSex",OPS.sex,true); chipContainer("#chipsDx",OPS.dx); chipContainer("#chipsComm",OPS.comm); chipContainer("#chipsSensory",OPS.sensory); chipContainer("#chipsReinf",OPS.reinf); chipContainer("#chipsTrigger",OPS.trigger); chipContainer("#chipsMeds",OPS.meds);
    $("#addStu").onclick=addStu; $("#btnGraph").onclick=handleGraph; $("#btnPrint").onclick=()=>window.print();
    $("#syncPull").onclick=()=>pullServer(); $("#syncPush").onclick=()=>pushServer();
    $("#exportJson").onclick=()=>{ const blob=new Blob([JSON.stringify({students,emotion},null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="emotion_data_export.json"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500); };
    $("#importJson").onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=x=>{ try{ const o=JSON.parse(x.target.result||"{}"); students=o.students||[]; emotion=o.emotion||{}; persist(); buildAll(); alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ"); }catch{ alert("JSON íŒŒì‹± ì‹¤íŒ¨"); } }; r.readAsText(f,"utf-8"); };
    $("#purgeLocal").onclick=()=>{ if(confirm("ë¡œì»¬ ì €ì¥ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?")){ localStorage.removeItem(KEY_ST); localStorage.removeItem(KEY_ED); localStorage.removeItem(KEY_SES); students=[]; emotion={}; buildAll(); alert("ë¡œì»¬ ì´ˆê¸°í™” ì™„ë£Œ"); } };
  });
})();
</script>
</body>
</html>
